<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>PluginBuilder.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</a> &gt; <a href="../../index.html" class="el_group">j-enterprise-service-bus</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">com.otk.jesb</a> &gt; <span class="el_source">PluginBuilder.java</span></div><h1>PluginBuilder.java</h1><pre class="source lang-java linenums">package com.otk.jesb;

import java.awt.image.BufferedImage;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.Serializable;
import java.io.StringWriter;
import java.nio.file.FileVisitResult;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.SimpleFileVisitor;
import java.nio.file.attribute.BasicFileAttributes;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.jar.Attributes;
import java.util.jar.JarEntry;
import java.util.jar.JarOutputStream;
import java.util.jar.Manifest;
import java.util.stream.Collectors;

import javax.imageio.ImageIO;
import javax.swing.SwingUtilities;

import com.otk.jesb.Structure.Element;
import com.otk.jesb.Structure.ElementProxy;
import com.otk.jesb.Structure.EnumerationStructure;
import com.otk.jesb.Structure.SharedStructureReference;
import com.otk.jesb.Structure.SimpleElement;
import com.otk.jesb.Structure.StructuredElement;
import com.otk.jesb.activation.ActivationHandler;
import com.otk.jesb.activation.Activator;
import com.otk.jesb.activation.ActivatorMetadata;
import com.otk.jesb.activation.ActivatorStructure;
import com.otk.jesb.compiler.CompilationError;
import com.otk.jesb.instantiation.InstantiationContext;
import com.otk.jesb.instantiation.RootInstanceBuilder;
import com.otk.jesb.operation.Operation;
import com.otk.jesb.operation.OperationBuilder;
import com.otk.jesb.operation.OperationMetadata;
import com.otk.jesb.operation.OperationStructureBuilder;
import com.otk.jesb.resource.Resource;
import com.otk.jesb.resource.ResourceMetadata;
import com.otk.jesb.resource.ResourceStructure;
import com.otk.jesb.solution.Folder;
import com.otk.jesb.solution.JAR;
import com.otk.jesb.solution.Plan;
import com.otk.jesb.solution.Plan.ExecutionContext;
import com.otk.jesb.solution.Plan.ExecutionInspector;
import com.otk.jesb.solution.Solution;
import com.otk.jesb.solution.Step;
import com.otk.jesb.ui.GUI;
import com.otk.jesb.ui.GUI.VariantCustomizations;
import com.otk.jesb.util.Accessor;
import com.otk.jesb.util.CodeBuilder;
import com.otk.jesb.util.CodeBuilder.PlaceHolder;
import com.otk.jesb.util.MiscUtils;
import com.otk.jesb.util.TreeVisitor;
import com.thoughtworks.xstream.io.xml.CompactWriter;
import xy.reflect.ui.control.DefaultFieldControlInput;
import xy.reflect.ui.control.FieldControlDataProxy;
import xy.reflect.ui.control.FieldControlInputProxy;
import xy.reflect.ui.control.IFieldControlData;
import xy.reflect.ui.control.IFieldControlInput;
import xy.reflect.ui.control.plugin.AbstractSimpleCustomizableFieldControlPlugin.AbstractConfiguration;
import xy.reflect.ui.control.plugin.ICustomizableFieldControlPlugin;
import xy.reflect.ui.control.plugin.IFieldControlPlugin;
import xy.reflect.ui.control.swing.customizer.MultiSwingCustomizer.SubSwingCustomizer;
import xy.reflect.ui.info.ResourcePath;
import xy.reflect.ui.info.custom.InfoCustomizations;
import xy.reflect.ui.info.type.ITypeInfo;
import xy.reflect.ui.info.type.enumeration.IEnumerationTypeInfo;
import xy.reflect.ui.info.type.source.JavaTypeInfoSource;
import xy.reflect.ui.util.ClassUtils;
import xy.reflect.ui.util.ReflectionUIUtils;

/**
 * This class allows to model and generate code for new
 * {@link Operation}/{@link Activator}/{@link Resource} types that will be
 * usable in the form of a plugin.
 * 
 * @author olitank
 *
 */
public class PluginBuilder {

	public static void main(String[] args) {
<span class="nc" id="L93">		SwingUtilities.invokeLater(new Runnable() {</span>
			@Override
			public void run() {
<span class="nc" id="L96">				GUI.INSTANCE.openObjectFrame(PluginBuilder.INSTANCE);</span>
<span class="nc" id="L97">			}</span>
		});
<span class="nc" id="L99">	}</span>

<span class="fc" id="L101">	public static final PluginBuilder INSTANCE = new PluginBuilder();</span>

<span class="fc" id="L103">	private String packageName = &quot;com.example&quot;;</span>
<span class="fc" id="L104">	private List&lt;ResourceDescriptor&gt; resources = new ArrayList&lt;ResourceDescriptor&gt;();</span>
<span class="fc" id="L105">	private List&lt;OperationDescriptor&gt; operations = new ArrayList&lt;OperationDescriptor&gt;();</span>
<span class="fc" id="L106">	private List&lt;ActivatorDescriptor&gt; activators = new ArrayList&lt;ActivatorDescriptor&gt;();</span>

	private JAR onlineJAR;

<span class="fc" id="L110">	private PluginBuilder() {</span>
<span class="fc" id="L111">	}</span>

	public String getPackageName() {
<span class="fc" id="L114">		return packageName;</span>
	}

	public void setPackageName(String packageName) {
<span class="nc" id="L118">		this.packageName = packageName;</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">		if (isTestingPrepared()) {</span>
<span class="nc" id="L120">			unprepareTesting();</span>
		}
<span class="nc" id="L122">	}</span>

	public List&lt;OperationDescriptor&gt; getOperations() {
<span class="fc" id="L125">		return operations;</span>
	}

	public void setOperations(List&lt;OperationDescriptor&gt; operations) {
<span class="fc" id="L129">		this.operations = operations;</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">		if (isTestingPrepared()) {</span>
<span class="fc" id="L131">			unprepareTesting();</span>
		}
<span class="fc" id="L133">	}</span>

	public List&lt;ResourceDescriptor&gt; getResources() {
<span class="fc" id="L136">		return resources;</span>
	}

	public void setResources(List&lt;ResourceDescriptor&gt; resources) {
<span class="fc" id="L140">		this.resources = resources;</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">		if (isTestingPrepared()) {</span>
<span class="fc" id="L142">			unprepareTesting();</span>
		}
<span class="fc" id="L144">	}</span>

	public List&lt;ActivatorDescriptor&gt; getActivators() {
<span class="fc" id="L147">		return activators;</span>
	}

	public void setActivators(List&lt;ActivatorDescriptor&gt; activators) {
<span class="fc" id="L151">		this.activators = activators;</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">		if (isTestingPrepared()) {</span>
<span class="fc" id="L153">			unprepareTesting();</span>
		}
<span class="fc" id="L155">	}</span>

	public void generateProject(File outputDirectory) throws IOException {
<span class="fc" id="L158">		MiscUtils.delete(outputDirectory);</span>
<span class="fc" id="L159">		File sourceDirectroy = getSourceDirectory(outputDirectory);</span>
<span class="fc" id="L160">		MiscUtils.createDirectory(sourceDirectroy, true);</span>
<span class="fc" id="L161">		generateSources(sourceDirectroy);</span>
<span class="fc" id="L162">		File resourceDirectroy = getResourceDirectory(outputDirectory);</span>
<span class="fc" id="L163">		MiscUtils.createDirectory(resourceDirectroy, true);</span>
<span class="fc" id="L164">		generateResources(resourceDirectroy);</span>
<span class="fc" id="L165">		File metaInformationDirectroy = getMetaInformationDirectory(outputDirectory);</span>
<span class="fc" id="L166">		MiscUtils.createDirectory(metaInformationDirectroy, true);</span>
<span class="fc" id="L167">		generateMetaInformation(metaInformationDirectroy);</span>
<span class="fc" id="L168">		generateProjectDescriptor(outputDirectory);</span>
<span class="fc" id="L169">	}</span>

	public void generateJAR(File jarFile) throws Exception {
<span class="fc" id="L172">		File temporaryDirectory = MiscUtils.createTemporaryDirectory();</span>
		try {
<span class="fc" id="L174">			generateProject(temporaryDirectory);</span>
<span class="fc" id="L175">			List&lt;Class&lt;?&gt;&gt; classes = new ArrayList&lt;Class&lt;?&gt;&gt;();</span>
<span class="fc" id="L176">			classes.addAll(compile(getSourceDirectory(temporaryDirectory)));</span>
<span class="fc" id="L177">			Manifest manifest = new Manifest();</span>
<span class="fc" id="L178">			try (FileInputStream in = new FileInputStream(</span>
<span class="fc" id="L179">					new File(getMetaInformationDirectory(temporaryDirectory), &quot;MANIFEST.MF&quot;))) {</span>
<span class="fc" id="L180">				manifest.read(in);</span>
			}
<span class="fc" id="L182">			try (JarOutputStream jarOutputStream = new JarOutputStream(new FileOutputStream(jarFile), manifest)) {</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">				for (Class&lt;?&gt; clazz : classes) {</span>
<span class="fc" id="L184">					String entryName = clazz.getName().replace(&quot;.&quot;, &quot;/&quot;) + &quot;.class&quot;;</span>
<span class="fc" id="L185">					JarEntry jarEntry = new JarEntry(entryName);</span>
<span class="fc" id="L186">					jarOutputStream.putNextEntry(jarEntry);</span>
<span class="fc" id="L187">					byte[] classBinary = MiscUtils.IN_MEMORY_COMPILER.getClassBinary(clazz);</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">					if (classBinary == null) {</span>
<span class="nc" id="L189">						throw new UnexpectedError();</span>
					}
<span class="fc" id="L191">					jarOutputStream.write(classBinary);</span>
<span class="fc" id="L192">					jarOutputStream.closeEntry();</span>
				}
<span class="fc" id="L194">				File resourceDirectory = getResourceDirectory(temporaryDirectory);</span>
<span class="fc" id="L195">				Files.walkFileTree(resourceDirectory.toPath(), new SimpleFileVisitor&lt;Path&gt;() {</span>
					@Override
					public FileVisitResult visitFile(Path filePath, BasicFileAttributes attrs) throws IOException {
<span class="fc" id="L198">						String entryName = resourceDirectory.toPath().relativize(filePath).toString().replace(&quot;\\&quot;,</span>
<span class="fc" id="L199">								&quot;/&quot;);</span>
<span class="fc" id="L200">						JarEntry jarEntry = new JarEntry(entryName);</span>
<span class="fc" id="L201">						jarOutputStream.putNextEntry(jarEntry);</span>
<span class="fc" id="L202">						jarOutputStream.write(MiscUtils.readBinary(filePath.toFile()));</span>
<span class="fc" id="L203">						jarOutputStream.closeEntry();</span>
<span class="fc" id="L204">						return super.visitFile(filePath, attrs);</span>
					}
				});
			}
		} finally {
<span class="fc" id="L209">			MiscUtils.delete(temporaryDirectory);</span>
		}
<span class="fc" id="L211">	}</span>

	public void prepareTesting() throws Exception {
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">		if (isTestingPrepared()) {</span>
<span class="nc" id="L215">			throw new UnexpectedError();</span>
		}
<span class="fc" id="L217">		File temporaryJarFile = MiscUtils.createTemporaryFile(&quot;jar&quot;);</span>
		try {
<span class="fc" id="L219">			generateJAR(temporaryJarFile);</span>
<span class="fc" id="L220">			onlineJAR = new JAR(temporaryJarFile);</span>
<span class="fc" id="L221">			Solution.INSTANCE.setRequiredJARs(MiscUtils.added(Solution.INSTANCE.getRequiredJARs(),</span>
<span class="fc" id="L222">					Solution.INSTANCE.getRequiredJARs().size(), onlineJAR));</span>
<span class="fc" id="L223">		} finally {</span>
<span class="fc" id="L224">			MiscUtils.delete(temporaryJarFile);</span>
		}
<span class="fc" id="L226">	}</span>

	public void unprepareTesting() {
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">		if (!isTestingPrepared()) {</span>
<span class="nc" id="L230">			throw new UnexpectedError();</span>
		}
<span class="fc" id="L232">		Solution.INSTANCE.setRequiredJARs(MiscUtils.removed(Solution.INSTANCE.getRequiredJARs(), -1, onlineJAR));</span>
<span class="fc" id="L233">		onlineJAR = null;</span>
<span class="fc" id="L234">	}</span>

	public boolean isTestingPrepared() {
<span class="fc bfc" id="L237" title="All 2 branches covered.">		return onlineJAR != null;</span>
	}

	private List&lt;Class&lt;?&gt;&gt; compile(File sourceDirectory) throws CompilationError {
<span class="fc" id="L241">		List&lt;Class&lt;?&gt;&gt; result = MiscUtils.IN_MEMORY_COMPILER.compile(sourceDirectory);</span>
<span class="fc" id="L242">		result = MiscUtils.expandWithEnclosedClasses(result);</span>
<span class="fc" id="L243">		return result;</span>
	}

	private File getResourceDirectory(File projectDirectory) {
<span class="fc" id="L247">		return new File(projectDirectory, &quot;src/main/resources&quot;);</span>
	}

	private File getSourceDirectory(File projectDirectory) {
<span class="fc" id="L251">		return new File(projectDirectory, &quot;src/main/java&quot;);</span>
	}

	private File getMetaInformationDirectory(File projectDirectory) {
<span class="fc" id="L255">		return new File(projectDirectory, &quot;META-INF&quot;);</span>
	}

	private void generateSources(File sourceDirectroy) {
<span class="fc bfc" id="L259" title="All 2 branches covered.">		for (OperationDescriptor operation : operations) {</span>
<span class="fc" id="L260">			operation.generateJavaSourceCode(sourceDirectroy, packageName);</span>
		}
<span class="fc bfc" id="L262" title="All 2 branches covered.">		for (ActivatorDescriptor activator : activators) {</span>
<span class="fc" id="L263">			activator.generateJavaSourceCode(sourceDirectroy, packageName);</span>
		}
<span class="fc bfc" id="L265" title="All 2 branches covered.">		for (ResourceDescriptor resource : resources) {</span>
<span class="fc" id="L266">			resource.generateJavaSourceCode(sourceDirectroy, packageName);</span>
		}
<span class="fc" id="L268">	}</span>

	private void generateResources(File resourceDirectroy) {
<span class="fc bfc" id="L271" title="All 2 branches covered.">		for (OperationDescriptor operation : operations) {</span>
<span class="fc" id="L272">			produceIcon(resourceDirectroy, operation.getOpertionTypeName(), operation.getIconImage());</span>
		}
<span class="fc bfc" id="L274" title="All 2 branches covered.">		for (ActivatorDescriptor activator : activators) {</span>
<span class="fc" id="L275">			produceIcon(resourceDirectroy, activator.getActivatorTypeName(), activator.getIconImage());</span>
		}
<span class="fc bfc" id="L277" title="All 2 branches covered.">		for (ResourceDescriptor resource : resources) {</span>
<span class="fc" id="L278">			produceIcon(resourceDirectroy, resource.getResourceTypeName(), resource.getIconImage());</span>
		}
<span class="fc" id="L280">	}</span>

	private void generateMetaInformation(File metaInformationDirectory) {
<span class="fc" id="L283">		Manifest manifest = new Manifest();</span>
<span class="fc" id="L284">		manifest.getMainAttributes().put(Attributes.Name.MANIFEST_VERSION, &quot;1.0&quot;);</span>
<span class="fc" id="L285">		manifest.getMainAttributes().put(JAR.PLUGIN_OPERATION_METADATA_CLASSES_MANIFEST_KEY,</span>
<span class="fc" id="L286">				operations.stream().map(operation -&gt; packageName + &quot;.&quot; + operation.getOpertionTypeName() + &quot;$Metadata&quot;)</span>
<span class="fc" id="L287">						.collect(Collectors.joining(&quot;,&quot;)));</span>
<span class="fc" id="L288">		manifest.getMainAttributes().put(JAR.PLUGIN_ACTIVATOR_METADATA_CLASSES_MANIFEST_KEY,</span>
<span class="fc" id="L289">				activators.stream().map(activator -&gt; packageName + &quot;.&quot; + activator.getActivatorTypeName() + &quot;$Metadata&quot;)</span>
<span class="fc" id="L290">						.collect(Collectors.joining(&quot;,&quot;)));</span>
<span class="fc" id="L291">		manifest.getMainAttributes().put(JAR.PLUGIN_RESOURCE_METADATA_CLASSES_MANIFEST_KEY,</span>
<span class="fc" id="L292">				resources.stream().map(resource -&gt; packageName + &quot;.&quot; + resource.getResourceTypeName() + &quot;$Metadata&quot;)</span>
<span class="fc" id="L293">						.collect(Collectors.joining(&quot;,&quot;)));</span>
<span class="fc" id="L294">		try (FileOutputStream out = new FileOutputStream(new File(metaInformationDirectory, &quot;MANIFEST.MF&quot;))) {</span>
<span class="fc" id="L295">			manifest.write(out);</span>
<span class="nc" id="L296">		} catch (IOException e) {</span>
<span class="nc" id="L297">			throw new UnexpectedError(e);</span>
		}
<span class="fc" id="L299">	}</span>

	private void generateProjectDescriptor(File projectDirectory) {
<span class="fc" id="L302">		try (FileOutputStream out = new FileOutputStream(new File(projectDirectory, &quot;pom.xml&quot;))) {</span>
<span class="fc" id="L303">			StringBuilder stringBuilder = new StringBuilder();</span>
<span class="fc" id="L304">			stringBuilder.append(&quot;&lt;project xmlns=\&quot;http://maven.apache.org/POM/4.0.0\&quot;\n&quot;);</span>
<span class="fc" id="L305">			stringBuilder.append(&quot;	xmlns:xsi=\&quot;http://www.w3.org/2001/XMLSchema-instance\&quot;\n&quot;);</span>
<span class="fc" id="L306">			stringBuilder.append(</span>
<span class="fc" id="L307">					&quot;	xsi:schemaLocation=\&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\&quot;&gt;\n&quot;);</span>
<span class="fc" id="L308">			stringBuilder.append(&quot;	&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n&quot;);</span>
<span class="fc" id="L309">			stringBuilder.append(&quot;\n&quot;);</span>
<span class="fc" id="L310">			stringBuilder.append(&quot;	&lt;groupId&gt;&quot; + packageName + &quot;&lt;/groupId&gt;\n&quot;);</span>
<span class="fc" id="L311">			stringBuilder.append(&quot;	&lt;artifactId&gt;jesb-plugin&lt;/artifactId&gt;\n&quot;);</span>
<span class="fc" id="L312">			stringBuilder.append(&quot;	&lt;version&gt;0.0.1&lt;/version&gt;\n&quot;);</span>
<span class="fc" id="L313">			stringBuilder.append(&quot;	&lt;packaging&gt;jar&lt;/packaging&gt;\n&quot;);</span>
<span class="fc" id="L314">			stringBuilder.append(&quot;\n&quot;);</span>
<span class="fc" id="L315">			stringBuilder.append(&quot;	&lt;name&gt;&quot; + packageName + &quot; JEnterpriseServiceBus Plugin&lt;/name&gt;\n&quot;);</span>
<span class="fc" id="L316">			stringBuilder.append(&quot;\n&quot;);</span>
<span class="fc" id="L317">			stringBuilder.append(&quot;	&lt;properties&gt;\n&quot;);</span>
<span class="fc" id="L318">			stringBuilder.append(&quot;		&lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;\n&quot;);</span>
<span class="fc" id="L319">			stringBuilder.append(&quot;		&lt;compiler.sourceVersion&gt;&quot; + BuildInformation.getCompilerSourceVersion()</span>
<span class="fc" id="L320">					+ &quot;&lt;/compiler.sourceVersion&gt;\n&quot;);</span>
<span class="fc" id="L321">			stringBuilder.append(&quot;		&lt;compiler.targetVersion&gt;&quot; + BuildInformation.getCompilerTargetVersion()</span>
<span class="fc" id="L322">					+ &quot;&lt;/compiler.targetVersion&gt;\n&quot;);</span>
<span class="fc" id="L323">			stringBuilder.append(&quot;	&lt;/properties&gt;\n&quot;);</span>
<span class="fc" id="L324">			stringBuilder.append(&quot;\n&quot;);</span>
<span class="fc" id="L325">			stringBuilder.append(&quot;	&lt;dependencies&gt;\n&quot;);</span>
<span class="fc" id="L326">			stringBuilder.append(&quot;		&lt;dependency&gt;\n&quot;);</span>
<span class="fc" id="L327">			stringBuilder.append(&quot;			&lt;groupId&gt;&quot; + BuildInformation.getGroupId() + &quot;&lt;/groupId&gt;\n&quot;);</span>
<span class="fc" id="L328">			stringBuilder.append(&quot;			&lt;artifactId&gt;&quot; + BuildInformation.getArtifactId() + &quot;&lt;/artifactId&gt;\n&quot;);</span>
<span class="fc" id="L329">			stringBuilder.append(&quot;			&lt;version&gt;&quot; + BuildInformation.getVersion() + &quot;&lt;/version&gt;\n&quot;);</span>
<span class="fc" id="L330">			stringBuilder.append(&quot;		&lt;/dependency&gt;\n&quot;);</span>
<span class="fc" id="L331">			stringBuilder.append(&quot;	&lt;/dependencies&gt;\n&quot;);</span>
<span class="fc" id="L332">			stringBuilder.append(&quot;\n&quot;);</span>
<span class="fc" id="L333">			stringBuilder.append(&quot;	&lt;build&gt;\n&quot;);</span>
<span class="fc" id="L334">			stringBuilder.append(&quot;		&lt;plugins&gt;\n&quot;);</span>
<span class="fc" id="L335">			stringBuilder.append(&quot;			&lt;plugin&gt;\n&quot;);</span>
<span class="fc" id="L336">			stringBuilder.append(&quot;				&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n&quot;);</span>
<span class="fc" id="L337">			stringBuilder.append(&quot;				&lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;\n&quot;);</span>
<span class="fc" id="L338">			stringBuilder.append(&quot;				&lt;version&gt;3.8.0&lt;/version&gt;\n&quot;);</span>
<span class="fc" id="L339">			stringBuilder.append(&quot;				&lt;configuration&gt;\n&quot;);</span>
<span class="fc" id="L340">			stringBuilder.append(&quot;					&lt;source&gt;${compiler.sourceVersion}&lt;/source&gt;\n&quot;);</span>
<span class="fc" id="L341">			stringBuilder.append(&quot;					&lt;target&gt;${compiler.targetVersion}&lt;/target&gt;\n&quot;);</span>
<span class="fc" id="L342">			stringBuilder.append(&quot;					&lt;compilerArgs&gt;\n&quot;);</span>
<span class="fc" id="L343">			stringBuilder.append(&quot;						&lt;arg&gt;-parameters&lt;/arg&gt;\n&quot;);</span>
<span class="fc" id="L344">			stringBuilder.append(&quot;					&lt;/compilerArgs&gt;\n&quot;);</span>
<span class="fc" id="L345">			stringBuilder.append(&quot;				&lt;/configuration&gt;\n&quot;);</span>
<span class="fc" id="L346">			stringBuilder.append(&quot;			&lt;/plugin&gt;\n&quot;);</span>
<span class="fc" id="L347">			stringBuilder.append(&quot;			&lt;plugin&gt;\n&quot;);</span>
<span class="fc" id="L348">			stringBuilder.append(&quot;				&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n&quot;);</span>
<span class="fc" id="L349">			stringBuilder.append(&quot;				&lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;\n&quot;);</span>
<span class="fc" id="L350">			stringBuilder.append(&quot;				&lt;executions&gt;\n&quot;);</span>
<span class="fc" id="L351">			stringBuilder.append(&quot;					&lt;execution&gt;\n&quot;);</span>
<span class="fc" id="L352">			stringBuilder.append(&quot;						&lt;phase&gt;prepare-package&lt;/phase&gt;\n&quot;);</span>
<span class="fc" id="L353">			stringBuilder.append(&quot;						&lt;goals&gt;\n&quot;);</span>
<span class="fc" id="L354">			stringBuilder.append(&quot;							&lt;goal&gt;jar&lt;/goal&gt;\n&quot;);</span>
<span class="fc" id="L355">			stringBuilder.append(&quot;						&lt;/goals&gt;\n&quot;);</span>
<span class="fc" id="L356">			stringBuilder.append(&quot;					&lt;/execution&gt;\n&quot;);</span>
<span class="fc" id="L357">			stringBuilder.append(&quot;				&lt;/executions&gt;\n&quot;);</span>
<span class="fc" id="L358">			stringBuilder.append(&quot;				&lt;version&gt;2.4&lt;/version&gt;\n&quot;);</span>
<span class="fc" id="L359">			stringBuilder.append(&quot;				&lt;configuration&gt;\n&quot;);</span>
<span class="fc" id="L360">			stringBuilder.append(&quot;					&lt;archive&gt;\n&quot;);</span>
<span class="fc" id="L361">			stringBuilder.append(&quot;						&lt;manifestFile&gt;META-INF/MANIFEST.MF&lt;/manifestFile&gt;\n&quot;);</span>
<span class="fc" id="L362">			stringBuilder.append(&quot;					&lt;/archive&gt;\n&quot;);</span>
<span class="fc" id="L363">			stringBuilder.append(&quot;				&lt;/configuration&gt;\n&quot;);</span>
<span class="fc" id="L364">			stringBuilder.append(&quot;			&lt;/plugin&gt;\n&quot;);</span>
<span class="fc" id="L365">			stringBuilder.append(&quot;		&lt;/plugins&gt;\n&quot;);</span>
<span class="fc" id="L366">			stringBuilder.append(&quot;	&lt;/build&gt;\n&quot;);</span>
<span class="fc" id="L367">			stringBuilder.append(&quot;\n&quot;);</span>
<span class="fc" id="L368">			stringBuilder.append(&quot;&lt;/project&gt;\n&quot;);</span>
<span class="fc" id="L369">			out.write((stringBuilder.toString()).getBytes());</span>
<span class="nc" id="L370">		} catch (IOException e) {</span>
<span class="nc" id="L371">			throw new UnexpectedError(e);</span>
		}
<span class="fc" id="L373">	}</span>

	private void produceIcon(File resourceDirectroy, String typeName, BufferedImage iconImage) {
		try {
<span class="fc" id="L377">			File iconFile = new File(resourceDirectroy, packageName.replace(&quot;.&quot;, &quot;/&quot;) + &quot;/&quot; + typeName + &quot;.png&quot;);</span>
<span class="fc bfc" id="L378" title="All 2 branches covered.">			if (!iconFile.getParentFile().exists()) {</span>
<span class="fc" id="L379">				MiscUtils.createDirectory(iconFile.getParentFile(), true);</span>
			}
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">			if (iconImage != null) {</span>
<span class="nc" id="L382">				ImageIO.write(iconImage, &quot;png&quot;, iconFile);</span>
<span class="nc" id="L383">			} else {</span>
<span class="fc" id="L384">				MiscUtils.writeBinary(iconFile, MiscUtils.readBinary(JESB.class.getResourceAsStream(&quot;generic.png&quot;)),</span>
<span class="fc" id="L385">						false);</span>
			}
<span class="pc" id="L387">		} catch (IOException e) {</span>
<span class="nc" id="L388">			throw new UnexpectedError(e);</span>
		}
<span class="fc" id="L390">	}</span>

	public void save(File file) throws IOException {
<span class="nc" id="L393">		try (FileOutputStream output = new FileOutputStream(file)) {</span>
<span class="nc" id="L394">			MiscUtils.serialize(this, output);</span>
		}
<span class="nc" id="L396">	}</span>

	public void load(File file) throws IOException {
<span class="nc" id="L399">		try (FileInputStream input = new FileInputStream(file)) {</span>
<span class="nc" id="L400">			PluginBuilder loaded = (PluginBuilder) MiscUtils.deserialize(input);</span>
<span class="nc" id="L401">			this.packageName = loaded.packageName;</span>
<span class="nc" id="L402">			this.operations = loaded.operations;</span>
<span class="nc" id="L403">			this.activators = loaded.activators;</span>
<span class="nc" id="L404">			this.resources = loaded.resources;</span>
		}
<span class="nc" id="L406">	}</span>

	public void validate() throws ValidationError {
<span class="pc bpc" id="L409" title="2 of 4 branches missed.">		if ((packageName == null) || packageName.isEmpty()) {</span>
<span class="nc" id="L410">			throw new ValidationError(&quot;Package name not provided&quot;);</span>
		}
<span class="fc bfc" id="L412" title="All 2 branches covered.">		for (OperationDescriptor operation : operations) {</span>
<span class="fc" id="L413">			operation.validate();</span>
		}
<span class="fc bfc" id="L415" title="All 2 branches covered.">		for (ActivatorDescriptor activator : activators) {</span>
<span class="fc" id="L416">			activator.validate();</span>
		}
<span class="fc bfc" id="L418" title="All 2 branches covered.">		for (ResourceDescriptor resource : resources) {</span>
<span class="fc" id="L419">			resource.validate();</span>
		}
<span class="fc bfc" id="L421" title="All 2 branches covered.">		if (operations.size() + activators.size() + resources.size() &gt; 0) {</span>
			try {
<span class="fc" id="L423">				File temporaryDirectory = MiscUtils.createTemporaryDirectory();</span>
				try {
<span class="fc" id="L425">					generateSources(temporaryDirectory);</span>
<span class="fc bfc" id="L426" title="All 2 branches covered.">					if (!PluginBuilder.INSTANCE.isTestingPrepared()) {</span>
<span class="fc" id="L427">						compile(temporaryDirectory);</span>
					}
<span class="fc" id="L429">				} finally {</span>
<span class="fc" id="L430">					MiscUtils.delete(temporaryDirectory);</span>
				}
<span class="nc" id="L432">			} catch (IOException e) {</span>
<span class="nc" id="L433">				throw new UnexpectedError(e);</span>
<span class="fc" id="L434">			} catch (Throwable t) {</span>
<span class="fc" id="L435">				throw new ValidationError(t.toString(), t);</span>
			}
		}
<span class="fc" id="L438">	}</span>

	public static String writeControlPluginConfiguration(Object controlPluginConfiguration) {
<span class="fc" id="L441">		StringWriter writer = new StringWriter();</span>
<span class="fc" id="L442">		MiscUtils.XSTREAM.marshal(controlPluginConfiguration, new CompactWriter(writer));</span>
<span class="fc" id="L443">		return writer.toString();</span>
	}

	public static Object readControlPluginConfiguration(String string) {
<span class="fc" id="L447">		return MiscUtils.XSTREAM.fromXML(string);</span>
	}

	private static void validateStructure(Structure structure) throws ValidationError {
		try {
<span class="fc" id="L452">			structure.visitElements(new TreeVisitor&lt;Structure.Element&gt;() {</span>
				@Override
				public VisitStatus visitNode(Element element) {
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">					if (element instanceof StructuredElement) {</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">						if (((StructuredElement) element).getStructure() instanceof SharedStructureReference) {</span>
<span class="nc" id="L457">							throw new IllegalStateException(&quot;Shared structure reference not allowed here&quot;);</span>
						}
					}
<span class="fc" id="L460">					return VisitStatus.VISIT_NOT_INTERRUPTED;</span>
				}
			});
<span class="pc" id="L463">		} catch (IllegalStateException e) {</span>
<span class="nc" id="L464">			throw new ValidationError(e.getMessage());</span>
		}
<span class="fc" id="L466">	}</span>

	private static Element ensureNotReadOnly(Element element) {
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">		if (element.getOptionality() == null) {</span>
<span class="nc" id="L470">			element = new Structure.ElementProxy(element) {</span>

<span class="nc" id="L472">				String GHOST_DEFAULT_VALUE_EXPRESSION_TO_ENABLE_SETTER = &quot;&lt;&quot; + MiscUtils.getDigitalUniqueIdentifier()</span>
<span class="nc" id="L473">						+ &quot;&gt;&quot;;</span>
				{
<span class="nc" id="L475">					Structure.Optionality optionality = new Structure.Optionality();</span>
<span class="nc" id="L476">					optionality.setDefaultValueExpression(GHOST_DEFAULT_VALUE_EXPRESSION_TO_ENABLE_SETTER);</span>
<span class="nc" id="L477">					setOptionality(optionality);</span>
				}

				@Override
				protected String generateJavaFieldDeclaration(String parentClassName, Map&lt;Object, Object&gt; options) {
<span class="nc" id="L482">					return super.generateJavaFieldDeclaration(parentClassName, options)</span>
<span class="nc" id="L483">							.replaceAll(&quot;\\s*=\\s*&quot; + GHOST_DEFAULT_VALUE_EXPRESSION_TO_ENABLE_SETTER, &quot;&quot;);</span>
				}

			};
		}
<span class="fc" id="L488">		return element;</span>
	}

	private static Object getControlPluginConfigurationOnIdentifierUpdate(String controlPluginIdentifier,
			Object oldControlPluginConfiguration) {
<span class="fc bfc" id="L493" title="All 2 branches covered.">		if (controlPluginIdentifier != null) {</span>
<span class="fc" id="L494">			IFieldControlPlugin selectedControlPlugin = GUI.INSTANCE</span>
<span class="fc" id="L495">					.obtainSubCustomizer(GUI.GLOBAL_EXCLUSIVE_CUSTOMIZATIONS).getFieldControlPlugins().stream()</span>
<span class="fc" id="L496">					.filter(controlPlugin -&gt; controlPlugin.getIdentifier().equals(controlPluginIdentifier)).findFirst()</span>
<span class="fc" id="L497">					.get();</span>
<span class="pc bpc" id="L498" title="1 of 2 branches missed.">			if (selectedControlPlugin instanceof ICustomizableFieldControlPlugin) {</span>
<span class="fc" id="L499">				Object defaultConfiguration = ((ICustomizableFieldControlPlugin) selectedControlPlugin)</span>
<span class="fc" id="L500">						.getDefaultControlCustomization();</span>
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">				if ((oldControlPluginConfiguration == null)</span>
<span class="nc bnc" id="L502" title="All 2 branches missed.">						|| (oldControlPluginConfiguration.getClass() != defaultConfiguration.getClass())) {</span>
<span class="fc" id="L503">					return ((ICustomizableFieldControlPlugin) selectedControlPlugin).getDefaultControlCustomization();</span>
				} else {
<span class="nc" id="L505">					return oldControlPluginConfiguration;</span>
				}
			} else {
<span class="nc" id="L508">				return null;</span>
			}
		} else {
<span class="fc" id="L511">			return null;</span>
		}
	}

<span class="fc" id="L515">	public static abstract class UIStructureBasedDescriptor {</span>

		protected abstract List&lt;? extends UIElementBasedDescriptor&gt; getUIElements();

		protected abstract String getDisplayedTypeName(String prefix);

		protected abstract void generateUICustomizationStatements(CodeBuilder result,
				UIElementBasedDescriptor uiElement, String uiCustomizationsVariableName, String displayedTypeName);

		private String additionalFieldDeclarationsSourceCode;
		private String additionalMethodDeclarationsSourceCode;
<span class="fc" id="L526">		private List&lt;String&gt; importedClassNames = new ArrayList&lt;String&gt;();</span>

		public String getAdditionalFieldDeclarationsSourceCode() {
<span class="fc" id="L529">			return additionalFieldDeclarationsSourceCode;</span>
		}

		public void setAdditionalFieldDeclarationsSourceCode(String additionalFieldDeclarationsSourceCode) {
<span class="nc" id="L533">			this.additionalFieldDeclarationsSourceCode = additionalFieldDeclarationsSourceCode;</span>
<span class="nc" id="L534">		}</span>

		public String getAdditionalMethodDeclarationsSourceCode() {
<span class="fc" id="L537">			return additionalMethodDeclarationsSourceCode;</span>
		}

		public void setAdditionalMethodDeclarationsSourceCode(String additionalMethodDeclarationsSourceCode) {
<span class="fc" id="L541">			this.additionalMethodDeclarationsSourceCode = additionalMethodDeclarationsSourceCode;</span>
<span class="fc" id="L542">		}</span>

		public List&lt;String&gt; getImportedClassNames() {
<span class="fc" id="L545">			return importedClassNames;</span>
		}

		public void setImportedClassNames(List&lt;String&gt; importedClassNames) {
<span class="nc" id="L549">			this.importedClassNames = importedClassNames;</span>
<span class="nc" id="L550">		}</span>

		protected String generateUICustomizationsMethodSourceCode(String displayedTypeNamePrefix) {
<span class="fc" id="L553">			CodeBuilder result = new CodeBuilder();</span>
<span class="fc" id="L554">			String displayedTypeName = getDisplayedTypeName(displayedTypeNamePrefix);</span>
<span class="fc" id="L555">			List&lt;? extends UIElementBasedDescriptor&gt; uiElements = getUIElements();</span>
<span class="fc" id="L556">			result.append(&quot;public static void &quot; + GUI.UI_CUSTOMIZATIONS_METHOD_NAME + &quot;(&quot;</span>
<span class="fc" id="L557">					+ InfoCustomizations.class.getName() + &quot; infoCustomizations) {\n&quot;);</span>
<span class="fc" id="L558">			result.indenting(() -&gt; {</span>
<span class="fc" id="L559">				result.append(&quot;// &quot; + displayedTypeName + &quot; form customization\n&quot;);</span>
<span class="fc" id="L560">				result.append(&quot;{\n&quot;);</span>
<span class="fc" id="L561">				result.indenting(() -&gt; {</span>
<span class="fc" id="L562">					result.append(&quot;// field control positions\n&quot;);</span>
<span class="fc" id="L563">					result.append(InfoCustomizations.class.getName() + &quot;.getTypeCustomization(infoCustomizations, &quot;</span>
<span class="fc" id="L564">							+ displayedTypeName + &quot;.class.getName())\n.setCustomFieldsOrder(&quot; + Arrays.class.getName()</span>
<span class="fc" id="L565">							+ &quot;.asList(&quot;</span>
<span class="fc" id="L566">							+ uiElements.stream().map(</span>
<span class="fc" id="L567">									uiField -&gt; '&quot;' + uiField.getDisplayedFieldName(this, displayedTypeNamePrefix) + '&quot;')</span>
<span class="fc" id="L568">									.collect(Collectors.joining(&quot;, &quot;))</span>
<span class="fc" id="L569">							+ &quot;));\n&quot;);</span>
<span class="fc bfc" id="L570" title="All 2 branches covered.">					for (UIElementBasedDescriptor uiElement : uiElements) {</span>
<span class="fc" id="L571">						result.append(&quot;// &quot; + uiElement.getDisplayedFieldName(this, displayedTypeNamePrefix)</span>
<span class="fc" id="L572">								+ &quot; control customization\n&quot;);</span>
<span class="fc" id="L573">						result.append(&quot;{\n&quot;);</span>
<span class="fc" id="L574">						result.indenting(() -&gt; {</span>
<span class="pc bpc" id="L575" title="1 of 2 branches missed.">							if (uiElement.getCaption() != null) {</span>
<span class="fc" id="L576">								result.append(InfoCustomizations.class.getName()</span>
<span class="fc" id="L577">										+ &quot;.getFieldCustomization(infoCustomizations, &quot; + displayedTypeName</span>
<span class="fc" id="L578">										+ &quot;.class.getName(), \&quot;&quot;</span>
<span class="fc" id="L579">										+ uiElement.getDisplayedFieldName(this, displayedTypeNamePrefix)</span>
<span class="fc" id="L580">										+ &quot;\&quot;)\n.setCustomFieldCaption(\&quot;&quot;</span>
<span class="fc" id="L581">										+ MiscUtils.escapeJavaString(uiElement.getCaption()) + &quot;\&quot;);\n&quot;);</span>
							}
<span class="fc" id="L583">							generateUICustomizationStatements(result, uiElement, &quot;infoCustomizations&quot;,</span>
<span class="fc" id="L584">									displayedTypeName);</span>
<span class="fc" id="L585">						});</span>
<span class="fc" id="L586">						result.append(&quot;}\n&quot;);</span>
					}
<span class="fc" id="L588">					result.append(&quot;// hide UI customization method\n&quot;);</span>
<span class="fc" id="L589">					result.append(InfoCustomizations.class.getName() + &quot;.getMethodCustomization(infoCustomizations, &quot;</span>
<span class="fc" id="L590">							+ displayedTypeName + &quot;.class.getName(), &quot; + ReflectionUIUtils.class.getName()</span>
<span class="fc" id="L591">							+ &quot;.buildMethodSignature(\&quot;void\&quot;, \&quot;&quot; + GUI.UI_CUSTOMIZATIONS_METHOD_NAME + &quot;\&quot;, &quot;</span>
<span class="fc" id="L592">							+ Arrays.class.getName() + &quot;.asList(&quot; + InfoCustomizations.class.getName()</span>
<span class="fc" id="L593">							+ &quot;.class.getName())))\n.setHidden(true);\n&quot;);</span>
<span class="fc" id="L594">				});</span>
<span class="fc" id="L595">				result.append(&quot;}\n&quot;);</span>
<span class="fc" id="L596">			});</span>
<span class="fc" id="L597">			result.append(&quot;}&quot;);</span>
<span class="fc" id="L598">			return result.toString();</span>
		}

		private static List&lt;Class&lt;?&gt;&gt; getCommonImportedClasses() {
<span class="fc" id="L602">			List&lt;Class&lt;?&gt;&gt; result = new ArrayList&lt;Class&lt;?&gt;&gt;();</span>
<span class="fc" id="L603">			result.add(Serializable.class);</span>
<span class="fc" id="L604">			result.add(Operation.class);</span>
<span class="fc" id="L605">			result.add(OperationStructureBuilder.class);</span>
<span class="fc" id="L606">			result.add(OperationBuilder.class);</span>
<span class="fc" id="L607">			result.add(OperationMetadata.class);</span>
<span class="fc" id="L608">			result.add(Activator.class);</span>
<span class="fc" id="L609">			result.add(ActivatorStructure.class);</span>
<span class="fc" id="L610">			result.add(ActivatorMetadata.class);</span>
<span class="fc" id="L611">			result.add(ActivationHandler.class);</span>
<span class="fc" id="L612">			result.add(Resource.class);</span>
<span class="fc" id="L613">			result.add(ResourceStructure.class);</span>
<span class="fc" id="L614">			result.add(ResourceMetadata.class);</span>
<span class="fc" id="L615">			result.add(RootInstanceBuilder.class);</span>
<span class="fc" id="L616">			result.add(Reference.class);</span>
<span class="fc" id="L617">			result.add(Variant.class);</span>
<span class="fc" id="L618">			result.add(InfoCustomizations.class);</span>
<span class="fc" id="L619">			result.add(ReflectionUIUtils.class);</span>
<span class="fc" id="L620">			result.add(ValidationError.class);</span>
<span class="fc" id="L621">			result.add(ResourcePath.class);</span>
<span class="fc" id="L622">			result.add(Step.class);</span>
<span class="fc" id="L623">			result.add(Plan.class);</span>
<span class="fc" id="L624">			return result;</span>
		}

		protected CodeBuilder.PlaceHolder getImportsPlaceHolder(String rootClassName) {
<span class="fc" id="L628">			return new CodeBuilder.PlaceHolder() {</span>
				List&lt;Class&lt;?&gt;&gt; usedImportClasses;

				@Override
				protected String replace(String finalCode) {
<span class="fc" id="L633">					finalCode = finalCode.replaceAll(&quot;\\b&quot; + MiscUtils.escapeRegex(&quot;java.lang.&quot;) + &quot;\\b&quot;, &quot;&quot;);</span>
<span class="fc" id="L634">					finalCode = finalCode.replaceAll(&quot;\\b&quot; + rootClassName + &quot;\\b&quot;,</span>
<span class="fc" id="L635">							MiscUtils.extractSimpleNameFromClassName(rootClassName));</span>
<span class="fc" id="L636">					List&lt;Class&lt;?&gt;&gt; candidateImportClasses = new ArrayList&lt;Class&lt;?&gt;&gt;(getCommonImportedClasses());</span>
<span class="fc" id="L637">					candidateImportClasses.addAll(importedClassNames.stream()</span>
<span class="pc" id="L638">							.map(className -&gt; MiscUtils.getJESBClass(className)).collect(Collectors.toList()));</span>
<span class="fc" id="L639">					usedImportClasses = new ArrayList&lt;Class&lt;?&gt;&gt;();</span>
<span class="fc bfc" id="L640" title="All 2 branches covered.">					for (Class&lt;?&gt; importedClass : candidateImportClasses) {</span>
<span class="fc" id="L641">						String newFinalCode = finalCode.replaceAll(</span>
<span class="fc" id="L642">								&quot;\\b&quot; + MiscUtils.escapeRegex(importedClass.getCanonicalName()) + &quot;\\b&quot;,</span>
<span class="fc" id="L643">								importedClass.getSimpleName());</span>
<span class="fc" id="L644">						boolean explicitImport = importedClassNames.contains(importedClass.getName());</span>
<span class="pc bpc" id="L645" title="1 of 4 branches missed.">						if (!explicitImport &amp;&amp; newFinalCode.equals(finalCode)) {</span>
<span class="fc" id="L646">							continue;</span>
						}
<span class="fc" id="L648">						usedImportClasses.add(importedClass);</span>
<span class="fc" id="L649">						finalCode = newFinalCode;</span>
					}
<span class="fc" id="L651">					return super.replace(finalCode);</span>
				}

				@Override
				protected String computeReplacement(String finalCode) {
<span class="fc" id="L656">					return usedImportClasses.stream().map(clazz -&gt; &quot;import &quot; + clazz.getCanonicalName() + &quot;;\n&quot;)</span>
<span class="fc" id="L657">							.collect(Collectors.joining());</span>
				}
			};
		}
	}

<span class="fc" id="L663">	public static abstract class UIElementBasedDescriptor {</span>

		private String name;
		private String caption;

		protected abstract String getDisplayedFieldName(UIStructureBasedDescriptor parent,
				String displayedTypeNamePrefix);

		public String getName() {
<span class="fc" id="L672">			return name;</span>
		}

		public void setName(String name) {
<span class="fc" id="L676">			this.name = name;</span>
<span class="fc" id="L677">		}</span>

		public String getCaption() {
<span class="fc" id="L680">			return caption;</span>
		}

		public void setCaption(String caption) {
<span class="fc" id="L684">			this.caption = caption;</span>
<span class="fc" id="L685">		}</span>

	}

<span class="fc" id="L689">	public static class OperationDescriptor extends UIStructureBasedDescriptor {</span>

		private static final String RESULT_OPTION_NAME = &quot;result&quot;;

		private String opertionTypeName;
		private String opertionTypeCaption;
		private String categoryName;
		private byte[] operationIconImageData;
<span class="fc" id="L697">		private List&lt;ParameterDescriptor&gt; parameters = new ArrayList&lt;ParameterDescriptor&gt;();</span>
		private ClassOptionDescriptor result;
<span class="fc" id="L699">		private String executionMethodBody = &quot;return null;&quot;;</span>
		private String additionalBuilderValidationStatements;

		public String getOpertionTypeName() {
<span class="fc" id="L703">			return opertionTypeName;</span>
		}

		public void setOpertionTypeName(String opertionTypeName) {
<span class="fc" id="L707">			this.opertionTypeName = opertionTypeName;</span>
<span class="fc" id="L708">		}</span>

		public String getOpertionTypeCaption() {
<span class="fc" id="L711">			return opertionTypeCaption;</span>
		}

		public void setOpertionTypeCaption(String opertionTypeCaption) {
<span class="fc" id="L715">			this.opertionTypeCaption = opertionTypeCaption;</span>
<span class="fc" id="L716">		}</span>

		public String getCategoryName() {
<span class="fc" id="L719">			return categoryName;</span>
		}

		public void setCategoryName(String categoryName) {
<span class="fc" id="L723">			this.categoryName = categoryName;</span>
<span class="fc" id="L724">		}</span>

		public List&lt;ParameterDescriptor&gt; getParameters() {
<span class="fc" id="L727">			return parameters;</span>
		}

		public void setParameters(List&lt;ParameterDescriptor&gt; parameters) {
<span class="fc" id="L731">			this.parameters = parameters;</span>
<span class="fc" id="L732">		}</span>

		public ClassOptionDescriptor getResult() {
<span class="fc" id="L735">			return result;</span>
		}

		public void setResult(ClassOptionDescriptor result) {
<span class="nc" id="L739">			this.result = result;</span>
<span class="nc" id="L740">		}</span>

		public String getExecutionMethodBody() {
<span class="fc" id="L743">			return executionMethodBody;</span>
		}

		public void setExecutionMethodBody(String executionMethodBody) {
<span class="fc" id="L747">			this.executionMethodBody = executionMethodBody;</span>
<span class="fc" id="L748">		}</span>

		public String getAdditionalBuilderValidationStatements() {
<span class="fc" id="L751">			return additionalBuilderValidationStatements;</span>
		}

		public void setAdditionalBuilderValidationStatements(String additionalBuilderValidationStatements) {
<span class="nc" id="L755">			this.additionalBuilderValidationStatements = additionalBuilderValidationStatements;</span>
<span class="nc" id="L756">		}</span>

		public byte[] getOperationIconImageData() {
<span class="nc" id="L759">			return operationIconImageData;</span>
		}

		public void setOperationIconImageData(byte[] operationIconImageData) {
<span class="nc" id="L763">			this.operationIconImageData = operationIconImageData;</span>
<span class="nc" id="L764">		}</span>

		public void loadIconImage(File file) throws IOException {
<span class="nc" id="L767">			operationIconImageData = MiscUtils.readBinary(file);</span>
<span class="nc" id="L768">		}</span>

		public BufferedImage getIconImage() {
<span class="pc bpc" id="L771" title="1 of 2 branches missed.">			if (operationIconImageData == null) {</span>
<span class="fc" id="L772">				return null;</span>
			}
			try {
<span class="nc" id="L775">				return ImageIO.read(new ByteArrayInputStream(operationIconImageData));</span>
<span class="nc" id="L776">			} catch (IOException e) {</span>
<span class="nc" id="L777">				throw new UnexpectedError(e);</span>
			}
		}

		public File generateJavaSourceCode(File sourceDirectroy, String packageName) {
<span class="fc" id="L782">			String operationClassName = packageName + &quot;.&quot; + opertionTypeName;</span>
<span class="fc" id="L783">			String implemented = Operation.class.getName();</span>
<span class="fc" id="L784">			Structure.ClassicStructure operationStructure = new Structure.ClassicStructure();</span>
<span class="fc" id="L785">			Map&lt;Object, Object&gt; codeGenerationOptions = Structure.ElementAccessMode.ACCESSORS.singletonOptions();</span>
<span class="fc bfc" id="L786" title="All 2 branches covered.">			for (ParameterDescriptor parameter : parameters) {</span>
<span class="fc" id="L787">				operationStructure.getElements().add(parameter.getOperationClassElement(operationClassName));</span>
			}
<span class="fc" id="L789">			CodeBuilder afterPackageDeclaration = new CodeBuilder();</span>
<span class="fc" id="L790">			CodeBuilder afterFieldDeclarations = new CodeBuilder();</span>
<span class="fc" id="L791">			CodeBuilder afterMethodDeclarations = new CodeBuilder();</span>
<span class="fc" id="L792">			PlaceHolder importsPlaceHolder = getImportsPlaceHolder(operationClassName);</span>
<span class="fc" id="L793">			afterPackageDeclaration.append(importsPlaceHolder.getReferenceString());</span>
<span class="fc" id="L794">			afterMethodDeclarations</span>
<span class="fc" id="L795">					.append(generateExecutionMethodSourceCode(operationClassName, codeGenerationOptions) + &quot;\n&quot;);</span>
<span class="fc" id="L796">			afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="fc" id="L797">			afterMethodDeclarations</span>
<span class="fc" id="L798">					.append(generateOperationBuilderClassSourceCode(operationClassName, codeGenerationOptions) + &quot;\n&quot;);</span>
<span class="fc" id="L799">			afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="fc" id="L800">			afterMethodDeclarations</span>
<span class="fc" id="L801">					.append(generateMetadataClassSourceCode(operationClassName, codeGenerationOptions) + &quot;\n&quot;);</span>
<span class="pc bpc" id="L802" title="1 of 2 branches missed.">			if (result != null) {</span>
<span class="nc" id="L803">				afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="nc" id="L804">				afterMethodDeclarations.append(result.generateClassesSourceCode(operationClassName, RESULT_OPTION_NAME,</span>
<span class="nc" id="L805">						codeGenerationOptions));</span>
			}
<span class="pc bpc" id="L807" title="1 of 2 branches missed.">			if (getAdditionalFieldDeclarationsSourceCode() != null) {</span>
<span class="nc" id="L808">				afterFieldDeclarations.append(getAdditionalFieldDeclarationsSourceCode() + &quot;\n&quot;);</span>
			}
<span class="pc bpc" id="L810" title="1 of 2 branches missed.">			if (getAdditionalMethodDeclarationsSourceCode() != null) {</span>
<span class="nc" id="L811">				afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="nc" id="L812">				afterMethodDeclarations.append(getAdditionalMethodDeclarationsSourceCode());</span>
			}
<span class="fc" id="L814">			File javaFile = new File(sourceDirectroy, operationClassName.replace(&quot;.&quot;, &quot;/&quot;) + &quot;.java&quot;);</span>
			try {
<span class="pc bpc" id="L816" title="1 of 2 branches missed.">				if (!javaFile.getParentFile().exists()) {</span>
<span class="fc" id="L817">					MiscUtils.createDirectory(javaFile.getParentFile(), true);</span>
				}
<span class="fc" id="L819">				MiscUtils.write(javaFile,</span>
<span class="fc" id="L820">						new CodeBuilder(operationStructure.generateJavaTypeSourceCode(operationClassName, implemented,</span>
<span class="fc" id="L821">								null, afterPackageDeclaration.toString(), afterFieldDeclarations.toString(),</span>
<span class="fc" id="L822">								afterMethodDeclarations.toString(), codeGenerationOptions))</span>
<span class="fc" id="L823">										.registerPlaceHolder(importsPlaceHolder).toString(),</span>
<span class="fc" id="L824">						false);</span>
<span class="pc" id="L825">			} catch (IOException e) {</span>
<span class="nc" id="L826">				throw new UnexpectedError(e);</span>
			}
<span class="fc" id="L828">			return javaFile;</span>
		}

		protected String generateExecutionMethodSourceCode(String className,
				Map&lt;Object, Object&gt; codeGenerationOptions) {
<span class="fc" id="L833">			CodeBuilder result = new CodeBuilder();</span>
<span class="fc" id="L834">			result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L835">			result.append(&quot;public Object execute() throws Throwable {\n&quot;);</span>
<span class="fc" id="L836">			result.appendIndented(executionMethodBody + &quot;\n&quot;);</span>
<span class="fc" id="L837">			result.append(&quot;}&quot;);</span>
<span class="fc" id="L838">			return result.toString();</span>
		}

		protected String generateOperationBuilderClassSourceCode(String operationClassName,
				Map&lt;Object, Object&gt; options) {
<span class="fc" id="L843">			String operationClassSimpleName = MiscUtils.extractSimpleNameFromClassName(operationClassName);</span>
<span class="fc" id="L844">			String implemented = OperationBuilder.class.getName() + &quot;&lt;&quot; + operationClassSimpleName + &quot;&gt;&quot;;</span>
<span class="fc" id="L845">			Structure.ClassicStructure operationBuilderStructure = new Structure.ClassicStructure();</span>
<span class="fc bfc" id="L846" title="All 2 branches covered.">			for (ParameterDescriptor parameter : parameters) {</span>
<span class="fc" id="L847">				operationBuilderStructure.getElements()</span>
<span class="fc" id="L848">						.add(parameter.getOperationBuilderClassElement(operationClassName));</span>
			}
<span class="fc" id="L850">			CodeBuilder afterMethodDeclarations = new CodeBuilder();</span>
<span class="fc" id="L851">			CodeBuilder afterPackageDeclaration = new CodeBuilder();</span>
<span class="pc bpc" id="L852" title="1 of 2 branches missed.">			for (String importedClassName : getImportedClassNames()) {</span>
<span class="nc" id="L853">				afterPackageDeclaration.append(&quot;import &quot; + importedClassName + &quot;;\n&quot;);</span>
			}
<span class="fc" id="L855">			afterMethodDeclarations.append(generateOperationBuildMethodSourceCode(operationClassName, options));</span>
<span class="fc" id="L856">			afterMethodDeclarations.append(generateOperationResultClassMethodSourceCode(operationClassName, options));</span>
<span class="fc" id="L857">			afterMethodDeclarations</span>
<span class="fc" id="L858">					.append(generateOperationBuilderValidationMethodSourceCode(operationClassName, options));</span>
<span class="fc" id="L859">			String packageName = MiscUtils.extractPackageNameFromClassName(operationClassName);</span>
<span class="fc" id="L860">			afterMethodDeclarations.append(</span>
<span class="pc bpc" id="L861" title="1 of 2 branches missed.">					generateUICustomizationsMethodSourceCode((packageName != null) ? (packageName + &quot;.&quot;) : &quot;&quot;) + &quot;\n&quot;);</span>
<span class="fc" id="L862">			return &quot;static &quot; + operationBuilderStructure.generateJavaTypeSourceCode(</span>
<span class="fc" id="L863">					getOperationBuilderClassSimpleName(), implemented, null, afterPackageDeclaration.toString(), null,</span>
<span class="fc" id="L864">					afterMethodDeclarations.toString(), options);</span>
		}

		@Override
		protected List&lt;? extends UIElementBasedDescriptor&gt; getUIElements() {
<span class="fc" id="L869">			return parameters;</span>
		}

		@Override
		protected String getDisplayedTypeName(String prefix) {
<span class="fc" id="L874">			String operationClassName = prefix + opertionTypeName;</span>
<span class="fc" id="L875">			String builderClassName = operationClassName + &quot;.&quot; + getOperationBuilderClassSimpleName();</span>
<span class="fc" id="L876">			return builderClassName;</span>
		}

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, UIElementBasedDescriptor uiElement,
				String uiCustomizationsVariableName, String displayedTypeName) {
<span class="fc" id="L882">			ParameterDescriptor parameter = (ParameterDescriptor) uiElement;</span>
<span class="fc" id="L883">			String operationClassName = displayedTypeName.substring(0,</span>
<span class="fc" id="L884">					displayedTypeName.length() - (&quot;.&quot; + getOperationBuilderClassSimpleName()).length());</span>
<span class="fc" id="L885">			parameter.getNature().generateUICustomizationStatements(result, uiCustomizationsVariableName,</span>
<span class="fc" id="L886">					operationClassName, getOperationBuilderClassSimpleName(), parameter.getName(),</span>
<span class="fc" id="L887">					parameter.getCaption());</span>
<span class="fc" id="L888">		}</span>

		protected String generateOperationBuilderValidationMethodSourceCode(String operationClassName,
				Map&lt;Object, Object&gt; options) {
<span class="fc" id="L892">			CodeBuilder result = new CodeBuilder();</span>
<span class="fc" id="L893">			result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L894">			result.append(&quot;public void validate(boolean recursively, &quot; + Plan.class.getName() + &quot; currentPlan, &quot;</span>
<span class="fc" id="L895">					+ Step.class.getName() + &quot; currentStep) throws &quot; + ValidationError.class.getName() + &quot;{\n&quot;);</span>
<span class="fc" id="L896">			result.indenting(() -&gt; {</span>
<span class="fc bfc" id="L897" title="All 2 branches covered.">				for (ParameterDescriptor parameter : parameters) {</span>
<span class="fc" id="L898">					parameter.getNature().generateOperationBuilderValidationStatements(result, operationClassName,</span>
<span class="fc" id="L899">							parameter.getName(), parameter.getCaption());</span>
				}
<span class="pc bpc" id="L901" title="1 of 2 branches missed.">				if (additionalBuilderValidationStatements != null) {</span>
<span class="nc" id="L902">					result.append(additionalBuilderValidationStatements + &quot;\n&quot;);</span>
				}
<span class="fc" id="L904">			});</span>
<span class="fc" id="L905">			result.append(&quot;}\n&quot;);</span>
<span class="fc" id="L906">			return result.toString();</span>
		}

		protected String generateOperationResultClassMethodSourceCode(String operationClassName,
				Map&lt;Object, Object&gt; options) {
<span class="fc" id="L911">			CodeBuilder result = new CodeBuilder();</span>
<span class="fc" id="L912">			result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L913">			result.append(&quot;public Class&lt;?&gt; getOperationResultClass(&quot; + Plan.class.getName() + &quot; currentPlan, &quot;</span>
<span class="fc" id="L914">					+ Step.class.getName() + &quot; currentStep) {\n&quot;);</span>
<span class="fc" id="L915">			result.appendIndented(generateResultClassMethodBody(operationClassName, options) + &quot;\n&quot;);</span>
<span class="fc" id="L916">			result.append(&quot;}\n&quot;);</span>
<span class="fc" id="L917">			return result.toString();</span>
		}

		protected String generateOperationBuildMethodSourceCode(String operationClassName,
				Map&lt;Object, Object&gt; options) {
<span class="fc" id="L922">			CodeBuilder result = new CodeBuilder();</span>
<span class="fc" id="L923">			String operationClassSimpleName = MiscUtils.extractSimpleNameFromClassName(operationClassName);</span>
<span class="fc" id="L924">			result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L925">			result.append(&quot;public &quot; + operationClassSimpleName + &quot; build(&quot;</span>
<span class="fc" id="L926">					+ MiscUtils.adaptClassNameToSourceCode(ExecutionContext.class.getName()) + &quot; context, &quot;</span>
<span class="fc" id="L927">					+ MiscUtils.adaptClassNameToSourceCode(ExecutionInspector.class.getName())</span>
<span class="fc" id="L928">					+ &quot; executionInspector) throws Exception {\n&quot;);</span>
<span class="fc" id="L929">			result.appendIndented(generateBuildMethodBody(operationClassName, options) + &quot;\n&quot;);</span>
<span class="fc" id="L930">			result.append(&quot;}\n&quot;);</span>
<span class="fc" id="L931">			return result.toString();</span>
		}

		protected String getOperationBuilderClassSimpleName() {
<span class="fc" id="L935">			return &quot;Builder&quot;;</span>
		}

		protected String generateBuildMethodBody(String operationClassName, Map&lt;Object, Object&gt; options) {
<span class="fc" id="L939">			CodeBuilder result = new CodeBuilder();</span>
<span class="fc bfc" id="L940" title="All 2 branches covered.">			for (ParameterDescriptor parameter : parameters) {</span>
<span class="fc" id="L941">				String buildStatementTarget = parameter.getOperationClassElement(operationClassName)</span>
<span class="fc" id="L942">						.getFinalTypeNameAdaptedToSourceCode(operationClassName) + &quot; &quot; + parameter.getName();</span>
<span class="fc" id="L943">				result.append(</span>
<span class="fc" id="L944">						parameter.generateBuildStatement(buildStatementTarget, operationClassName, options) + &quot;\n&quot;);</span>
			}
<span class="fc" id="L946">			result.append(&quot;return new &quot; + opertionTypeName + &quot;(&quot;</span>
<span class="fc" id="L947">					+ parameters.stream().map(ParameterDescriptor::getName).collect(Collectors.joining(&quot;, &quot;)) + &quot;);&quot;);</span>
<span class="fc" id="L948">			return result.toString();</span>
		}

		protected String generateMetadataClassSourceCode(String operationClassName, Map&lt;Object, Object&gt; options) {
<span class="fc" id="L952">			String className = &quot;Metadata&quot;;</span>
<span class="fc" id="L953">			String operationClassSimpleName = MiscUtils.extractSimpleNameFromClassName(operationClassName);</span>
<span class="fc" id="L954">			String implemented = OperationMetadata.class.getName() + &quot;&lt;&quot; + operationClassSimpleName + &quot;&gt;&quot;;</span>
<span class="fc" id="L955">			CodeBuilder result = new CodeBuilder();</span>
<span class="fc" id="L956">			result.append(&quot;public static class &quot; + className + &quot; implements &quot; + implemented + &quot;{&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L957">			result.indenting(() -&gt; {</span>
<span class="fc" id="L958">				result.append(&quot;\n&quot;);</span>
				{
<span class="fc" id="L960">					result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L961">					result.append(&quot;public String getOperationTypeName() {\n&quot;);</span>
<span class="fc" id="L962">					result.appendIndented(&quot;return \&quot;&quot; + opertionTypeCaption + &quot;\&quot;;&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L963">					result.append(&quot;}\n&quot;);</span>
				}
<span class="fc" id="L965">				result.append(&quot;\n&quot;);</span>
				{
<span class="fc" id="L967">					result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L968">					result.append(&quot;public String getCategoryName() {\n&quot;);</span>
<span class="fc" id="L969">					result.appendIndented(&quot;return \&quot;&quot; + categoryName + &quot;\&quot;;&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L970">					result.append(&quot;}\n&quot;);</span>
				}
<span class="fc" id="L972">				result.append(&quot;\n&quot;);</span>
				{
<span class="fc" id="L974">					result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L975">					result.append(&quot;public Class&lt;? extends &quot; + OperationBuilder.class.getName() + &quot;&lt;&quot;</span>
<span class="fc" id="L976">							+ operationClassSimpleName + &quot;&gt;&gt; getOperationBuilderClass() {\n&quot;);</span>
<span class="fc" id="L977">					result.appendIndented(&quot;return Builder.class;&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L978">					result.append(&quot;}\n&quot;);</span>
				}
<span class="fc" id="L980">				result.append(&quot;\n&quot;);</span>
				{
<span class="fc" id="L982">					result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L983">					result.append(&quot;public &quot; + ResourcePath.class.getName() + &quot; getOperationIconImagePath() {\n&quot;);</span>
<span class="fc" id="L984">					result.appendIndented(&quot;return new &quot; + ResourcePath.class.getName() + &quot;(&quot;</span>
<span class="fc" id="L985">							+ ResourcePath.class.getName() + &quot;.specifyClassPathResourceLocation(&quot;</span>
<span class="fc" id="L986">							+ operationClassSimpleName + &quot;.class.getName().replace(\&quot;.\&quot;, \&quot;/\&quot;) + \&quot;.png\&quot;));&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L987">					result.append(&quot;}\n&quot;);</span>
				}
<span class="fc" id="L989">				result.append(&quot;\n&quot;);</span>
<span class="fc" id="L990">			});</span>
<span class="fc" id="L991">			result.append(&quot;}&quot;);</span>
<span class="fc" id="L992">			return result.toString();</span>
		}

		protected String generateResultClassMethodBody(String operationClassName, Map&lt;Object, Object&gt; options) {
<span class="pc bpc" id="L996" title="1 of 2 branches missed.">			if (result == null) {</span>
<span class="fc" id="L997">				return &quot;return null;&quot;;</span>
			}
<span class="nc" id="L999">			return result.generateClassOptionMethodBody(operationClassName, RESULT_OPTION_NAME, options);</span>
		}

		public void validate() throws ValidationError {
<span class="pc bpc" id="L1003" title="1 of 4 branches missed.">			if ((opertionTypeName == null) || opertionTypeName.isEmpty()) {</span>
<span class="fc" id="L1004">				throw new ValidationError(&quot;Operation class name not provided&quot;);</span>
			}
<span class="fc bfc" id="L1006" title="All 2 branches covered.">			for (ParameterDescriptor parameter : parameters) {</span>
<span class="fc" id="L1007">				parameter.validate();</span>
			}
<span class="fc" id="L1009">		}</span>

		public com.otk.jesb.operation.Experiment test() throws Exception {
<span class="pc bpc" id="L1012" title="1 of 2 branches missed.">			if (PluginBuilder.INSTANCE.isTestingPrepared()) {</span>
<span class="nc" id="L1013">				PluginBuilder.INSTANCE.unprepareTesting();</span>
			}
<span class="fc" id="L1015">			PluginBuilder.INSTANCE.prepareTesting();</span>
<span class="fc" id="L1016">			String fullClassName = PluginBuilder.INSTANCE.getPackageName() + &quot;.&quot; + opertionTypeName;</span>
<span class="fc" id="L1017">			OperationBuilder&lt;?&gt; operationBuilder = (OperationBuilder&lt;?&gt;) MiscUtils</span>
<span class="fc" id="L1018">					.getJESBClass(fullClassName + &quot;$Builder&quot;).newInstance();</span>
<span class="fc" id="L1019">			return new com.otk.jesb.operation.Experiment(operationBuilder);</span>
		}

	}

<span class="fc" id="L1024">	public static class ParameterDescriptor extends UIElementBasedDescriptor {</span>

<span class="fc" id="L1026">		private ParameterNature nature = new SimpleParameterNature();</span>

		public ParameterNature getNature() {
<span class="fc" id="L1029">			return nature;</span>
		}

		@Override
		protected String getDisplayedFieldName(UIStructureBasedDescriptor parent, String displayedTypeNamePrefix) {
<span class="fc" id="L1034">			String builderClassName = parent.getDisplayedTypeName(displayedTypeNamePrefix);</span>
<span class="fc" id="L1035">			String operationClassName = builderClassName.substring(0, builderClassName.length()</span>
<span class="fc" id="L1036">					- (&quot;.&quot; + ((OperationDescriptor) parent).getOperationBuilderClassSimpleName()).length());</span>
<span class="fc" id="L1037">			return getOperationBuilderClassElement(operationClassName).getName();</span>
		}

		public void setNature(ParameterNature nature) {
<span class="fc" id="L1041">			this.nature = nature;</span>
<span class="fc" id="L1042">		}</span>

		public Element getOperationClassElement(String operationClassName) {
<span class="fc" id="L1045">			Element result = nature.getOperationClassElement(operationClassName, getName());</span>
<span class="fc" id="L1046">			return result;</span>
		}

		public Element getOperationBuilderClassElement(String operationClassName) {
<span class="fc" id="L1050">			Element result = nature.getOperationBuilderClassElement(operationClassName, getName(), getCaption());</span>
<span class="fc" id="L1051">			result = new Structure.ElementProxy(result) {</span>

				@Override
				protected String generateRequiredInnerJavaTypesSourceCode(String operationBuilderClassName,
						Map&lt;Object, Object&gt; options) {
<span class="fc" id="L1056">					return nature.generateBuilderRequiredInnerJavaTypesSourceCode(operationClassName,</span>
<span class="fc" id="L1057">							ParameterDescriptor.this.getName(), options);</span>
				}

			};
<span class="fc" id="L1061">			result = ensureNotReadOnly(result);</span>
<span class="fc" id="L1062">			return result;</span>
		}

		public String generateBuildStatement(String targetVariableName, String operationClassName,
				Map&lt;Object, Object&gt; options) {
<span class="fc" id="L1067">			return targetVariableName + &quot; = &quot; + nature.generateBuildExpression(operationClassName, getName(), options)</span>
<span class="fc" id="L1068">					+ &quot;;&quot;;</span>
		}

		public void validate() throws ValidationError {
<span class="pc bpc" id="L1072" title="1 of 4 branches missed.">			if ((getName() == null) || getName().isEmpty()) {</span>
<span class="fc" id="L1073">				throw new ValidationError(&quot;Parameter name not provided&quot;);</span>
			}
<span class="fc" id="L1075">			nature.validate();</span>
<span class="fc" id="L1076">		}</span>

	}

<span class="nc" id="L1080">	public static class ClassOptionDescriptor {</span>

<span class="nc" id="L1082">		private Structure structure = new Structure.ClassicStructure();</span>
		private List&lt;StructureDerivationAlternative&gt; concreteStructureAlternatives;

		public Structure getStructure() {
<span class="nc" id="L1086">			return structure;</span>
		}

		public void setStructure(Structure structure) {
<span class="nc" id="L1090">			this.structure = structure;</span>
<span class="nc" id="L1091">		}</span>

		public List&lt;StructureDerivationAlternative&gt; getConcreteStructureAlternatives() {
<span class="nc" id="L1094">			return concreteStructureAlternatives;</span>
		}

		public void setConcreteStructureAlternatives(
				List&lt;StructureDerivationAlternative&gt; concreteStructureAlternatives) {
<span class="nc" id="L1099">			this.concreteStructureAlternatives = concreteStructureAlternatives;</span>
<span class="nc" id="L1100">		}</span>

		public String generateClassesSourceCode(String parentClassName, String optionName,
				Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1104">			return getOptionElementUtility(parentClassName, optionName)</span>
<span class="nc" id="L1105">					.generateRequiredInnerJavaTypesSourceCode(parentClassName, options);</span>
		}

		protected String generateClassOptionMethodBody(String parentClassName, String optionName,
				Map&lt;Object, Object&gt; options) {
<span class="nc bnc" id="L1110" title="All 2 branches missed.">			if (concreteStructureAlternatives != null) {</span>
<span class="nc" id="L1111">				return getOptionNatureUtility(parentClassName)</span>
<span class="nc" id="L1112">						.generateConcreteTypeNameGetterBody(parentClassName, optionName, options)</span>
<span class="nc" id="L1113">						.replace(&quot;class.getName()&quot;, &quot;class&quot;);</span>
			} else {
<span class="nc" id="L1115">				return &quot;return &quot; + getOptionElementUtility(parentClassName, optionName)</span>
<span class="nc" id="L1116">						.getFinalTypeNameAdaptedToSourceCode(parentClassName) + &quot;.class;&quot;;</span>
			}
		}

		private Structure.Element getOptionElementUtility(String parentClassName, String optionName) {
<span class="nc" id="L1121">			return getOptionNatureUtility(parentClassName).getOperationClassElement(parentClassName, optionName);</span>
		}

		private DynamicParameterNature getOptionNatureUtility(String parentClassName) {
<span class="nc" id="L1125">			return new DynamicParameterNature() {</span>
				{
<span class="nc" id="L1127">					setStructure(ClassOptionDescriptor.this.structure);</span>
<span class="nc" id="L1128">					setConcreteStructureAlternatives(ClassOptionDescriptor.this.concreteStructureAlternatives);</span>
				}
			};
		}

		public void validate() throws ValidationError {
<span class="nc" id="L1134">			structure.validate(true);</span>
<span class="nc" id="L1135">			PluginBuilder.validateStructure(structure);</span>
<span class="nc bnc" id="L1136" title="All 2 branches missed.">			if (concreteStructureAlternatives != null) {</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">				for (StructureDerivationAlternative alternative : concreteStructureAlternatives) {</span>
<span class="nc" id="L1138">					alternative.validate();</span>
				}
			}
<span class="nc" id="L1141">		}</span>
	}

<span class="fc" id="L1144">	public static abstract class ParameterNature {</span>

		protected abstract Element getOperationClassElement(String operationClassName, String parameterName);

		protected abstract Element getOperationBuilderClassElement(String operationClassName, String parameterName,
				String parameterCaption);

		protected abstract String generateBuilderRequiredInnerJavaTypesSourceCode(String operationClassName,
				String parameterName, Map&lt;Object, Object&gt; options);

		protected abstract String generateBuildExpression(String operationClassName, String parameterName,
				Map&lt;Object, Object&gt; options);

		protected abstract void generateOperationBuilderValidationStatements(CodeBuilder result,
				String operationClassName, String parameterName, String parameterCaption);

		protected abstract void generateUICustomizationStatements(CodeBuilder result,
				String uiCustomizationsVariableName, String operationClassName, String operationBuilderClassSimpleName,
				String parameterName, String parameterCaption);

		public abstract void validate() throws ValidationError;

	}

<span class="fc" id="L1168">	public static class SimpleParameterNature extends ParameterNature {</span>

<span class="fc" id="L1170">		private SimpleElement internalElement = new SimpleElement();</span>
		private String defaultValueExpression;
<span class="fc" id="L1172">		private boolean variant = false;</span>
<span class="fc" id="L1173">		private boolean nullable = false;</span>
		private String controlPluginIdentifier;
		private Object controlPluginConfiguration;

		public String getTypeNameOrAlias() {
<span class="fc" id="L1178">			return internalElement.getTypeNameOrAlias();</span>
		}

		public void setTypeNameOrAlias(String typeNameOrAlias) {
<span class="fc" id="L1182">			internalElement.setTypeNameOrAlias(typeNameOrAlias);</span>
<span class="fc" id="L1183">		}</span>

		public List&lt;String&gt; getTypeNameOrAliasOptions() {
<span class="fc" id="L1186">			List&lt;String&gt; result = new ArrayList&lt;String&gt;(internalElement.getTypeNameOrAliasOptions());</span>
<span class="pc bpc" id="L1187" title="1 of 2 branches missed.">			if (internalElement.getTypeNameOrAlias() != null) {</span>
<span class="pc bpc" id="L1188" title="1 of 2 branches missed.">				if (!internalElement.getTypeNameOrAliasOptions().contains(internalElement.getTypeNameOrAlias())) {</span>
<span class="nc" id="L1189">					result.add(internalElement.getTypeNameOrAlias());</span>
				}
			}
<span class="fc" id="L1192">			return result;</span>
		}

		public String getDefaultValueExpression() {
<span class="fc" id="L1196">			return defaultValueExpression;</span>
		}

		public void setDefaultValueExpression(String defaultValueExpression) {
<span class="fc" id="L1200">			this.defaultValueExpression = defaultValueExpression;</span>
<span class="fc" id="L1201">		}</span>

		public boolean isVariant() {
<span class="fc" id="L1204">			return variant;</span>
		}

		public void setVariant(boolean variant) {
<span class="fc" id="L1208">			this.variant = variant;</span>
<span class="fc" id="L1209">		}</span>

		public boolean isNullable() {
<span class="fc" id="L1212">			return nullable;</span>
		}

		public void setNullable(boolean nullable) {
<span class="nc" id="L1216">			this.nullable = nullable;</span>
<span class="nc" id="L1217">		}</span>

		public String getControlPluginIdentifier() {
<span class="fc" id="L1220">			return controlPluginIdentifier;</span>
		}

		public void setControlPluginIdentifier(String controlPluginIdentifier) {
<span class="fc" id="L1224">			this.controlPluginIdentifier = controlPluginIdentifier;</span>
<span class="fc" id="L1225">			this.controlPluginConfiguration = PluginBuilder.getControlPluginConfigurationOnIdentifierUpdate(</span>
<span class="fc" id="L1226">					controlPluginIdentifier, controlPluginConfiguration);</span>
<span class="fc" id="L1227">		}</span>

		public Object getControlPluginConfiguration() {
<span class="fc" id="L1230">			return controlPluginConfiguration;</span>
		}

		public void setControlPluginConfiguration(Object controlPluginConfiguration) {
<span class="nc" id="L1234">			this.controlPluginConfiguration = controlPluginConfiguration;</span>
<span class="nc" id="L1235">		}</span>

		public List&lt;String&gt; getControlPluginIdentifierOptions() {
<span class="fc" id="L1238">			String typeName = Structure.SimpleElement.TYPE_NAME_BY_ALIAS.getOrDefault(getTypeNameOrAlias(),</span>
<span class="fc" id="L1239">					getTypeNameOrAlias());</span>
<span class="fc" id="L1240">			final ITypeInfo typeInfo = GUI.INSTANCE.getReflectionUI()</span>
<span class="fc" id="L1241">					.getTypeInfo(new JavaTypeInfoSource(MiscUtils.getJESBClass(typeName), null));</span>
<span class="fc" id="L1242">			IFieldControlInput sampleControlInput = new FieldControlInputProxy(</span>
<span class="fc" id="L1243">					new DefaultFieldControlInput(GUI.INSTANCE.getReflectionUI()) {</span>

						@Override
						public IFieldControlData getControlData() {
<span class="fc" id="L1247">							return new FieldControlDataProxy(super.getControlData()) {</span>

								@Override
								public ITypeInfo getType() {
<span class="fc" id="L1251">									return typeInfo;</span>
								}

							};
						}
					});
<span class="fc" id="L1257">			SubSwingCustomizer globalSubCustomizer = GUI.INSTANCE</span>
<span class="fc" id="L1258">					.obtainSubCustomizer(GUI.GLOBAL_EXCLUSIVE_CUSTOMIZATIONS);</span>
<span class="fc" id="L1259">			return globalSubCustomizer.getFieldControlPlugins().stream().filter(</span>
<span class="fc" id="L1260">					controlPlugin -&gt; controlPlugin.handles(globalSubCustomizer.getReflectionUI(), sampleControlInput))</span>
<span class="fc" id="L1261">					.map(IFieldControlPlugin::getIdentifier).collect(Collectors.toList());</span>
		}

		@Override
		protected void generateOperationBuilderValidationStatements(CodeBuilder result, String operationClassName,
				String parameterName, String parameterCaption) {
<span class="pc bpc" id="L1267" title="1 of 2 branches missed.">			if (variant) {</span>
<span class="nc" id="L1268">				String builderElementName = getOperationBuilderClassElement(operationClassName, parameterName,</span>
<span class="nc" id="L1269">						parameterCaption).getName();</span>
<span class="nc" id="L1270">				result.append(&quot;if (recursively) {\n&quot;);</span>
<span class="nc" id="L1271">				result.indenting(() -&gt; {</span>
<span class="nc" id="L1272">					result.append(&quot;try {\n&quot;);</span>
<span class="nc" id="L1273">					result.appendIndented(builderElementName + &quot;.validate();\n&quot;);</span>
<span class="nc" id="L1274">					result.append(&quot;} catch (&quot; + ValidationError.class.getName() + &quot; e) {\n&quot;);</span>
<span class="nc" id="L1275">					result.appendIndented(&quot;throw new &quot; + ValidationError.class.getName() + &quot;(\&quot;Failed to validate '&quot;</span>
<span class="nc" id="L1276">							+ MiscUtils.escapeJavaString(parameterCaption) + &quot;'\&quot;, e);\n&quot;);</span>
<span class="nc" id="L1277">					result.append(&quot;}\n&quot;);</span>
<span class="nc" id="L1278">				});</span>
<span class="nc" id="L1279">				result.append(&quot;}\n&quot;);</span>
			}
<span class="fc" id="L1281">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String operationClassName, String operationBuilderClassSimpleName, String parameterName,
				String parameterCaption) {
<span class="fc" id="L1287">			String builderClassName = operationClassName</span>
<span class="pc bpc" id="L1288" title="1 of 2 branches missed.">					+ ((operationBuilderClassSimpleName != null) ? (&quot;.&quot; + operationBuilderClassSimpleName) : &quot;&quot;);</span>
<span class="fc" id="L1289">			String builderElementName = getOperationBuilderClassElement(operationClassName, parameterName,</span>
<span class="fc" id="L1290">					parameterCaption).getName();</span>
<span class="fc" id="L1291">			String builderElementTypeName = getOperationBuilderClassElement(operationClassName, parameterName,</span>
<span class="fc" id="L1292">					parameterCaption).getFinalTypeNameAdaptedToSourceCode(builderClassName);</span>
<span class="fc bfc" id="L1293" title="All 2 branches covered.">			String customizedTypeNameExpression = variant</span>
<span class="fc" id="L1294">					? (MiscUtils.adaptClassNameToSourceCode(VariantCustomizations.class.getName())</span>
<span class="fc" id="L1295">							+ &quot;.getAdapterTypeName(&quot; + builderClassName + &quot;.class.getName(),\&quot;&quot; + builderElementName</span>
<span class="fc" id="L1296">							+ &quot;\&quot;)&quot;)</span>
<span class="fc" id="L1297">					: (builderClassName + &quot;.class.getName()&quot;);</span>
<span class="fc bfc" id="L1298" title="All 2 branches covered.">			String customizedFieldNameExpression = variant</span>
<span class="fc" id="L1299">					? (MiscUtils.adaptClassNameToSourceCode(VariantCustomizations.class.getName())</span>
<span class="fc" id="L1300">							+ &quot;.getConstantValueFieldName(\&quot;&quot; + builderElementName + &quot;\&quot;)&quot;)</span>
<span class="fc" id="L1301">					: (&quot;\&quot;&quot; + builderElementName + &quot;\&quot;&quot;);</span>
<span class="fc bfc" id="L1302" title="All 2 branches covered.">			String customizedFieldTypeNameExpression = variant</span>
<span class="fc" id="L1303">					? (MiscUtils.adaptClassNameToSourceCode(adaptVariantGenericParameterTypeName(</span>
<span class="fc" id="L1304">							getOperationClassElement(operationClassName, parameterName)</span>
<span class="fc" id="L1305">									.getTypeName(operationClassName)))</span>
<span class="fc" id="L1306">							+ &quot;.class.getName()&quot;)</span>
<span class="fc" id="L1307">					: (builderElementTypeName + &quot;.class.getName()&quot;);</span>
<span class="fc" id="L1308">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(&quot; + uiCustomizationsVariableName</span>
<span class="fc" id="L1309">					+ &quot;, &quot; + customizedTypeNameExpression + &quot;, &quot; + customizedFieldNameExpression</span>
<span class="fc" id="L1310">					+ &quot;)\n.setCustomFieldCaption(\&quot;&quot; + MiscUtils.escapeJavaString(parameterCaption) + &quot;\&quot;);\n&quot;);</span>
<span class="pc bpc" id="L1311" title="1 of 2 branches missed.">			if (nullable) {</span>
<span class="nc" id="L1312">				result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(&quot;</span>
<span class="nc" id="L1313">						+ uiCustomizationsVariableName + &quot;, &quot; + customizedTypeNameExpression + &quot;, &quot;</span>
<span class="nc" id="L1314">						+ customizedFieldNameExpression + &quot;)\n.setNullValueDistinctForced(true);\n&quot;);</span>
			}
<span class="fc bfc" id="L1316" title="All 2 branches covered.">			if (controlPluginIdentifier != null) {</span>
<span class="fc" id="L1317">				result.append(InfoCustomizations.class.getName() + &quot;.getTypeCustomization(&quot;</span>
<span class="fc" id="L1318">						+ InfoCustomizations.class.getName() + &quot;.getFieldCustomization(&quot; + uiCustomizationsVariableName</span>
<span class="fc" id="L1319">						+ &quot;, &quot; + customizedTypeNameExpression + &quot;, &quot; + customizedFieldNameExpression</span>
<span class="fc" id="L1320">						+ &quot;)\n.getSpecificTypeCustomizations(), &quot; + customizedFieldTypeNameExpression</span>
<span class="fc" id="L1321">						+ &quot;).setSpecificProperties(new &quot; + HashMap.class.getName() + &quot;&lt;String, Object&gt;() {\n&quot;);</span>
<span class="fc" id="L1322">				result.indenting(() -&gt; {</span>
<span class="fc" id="L1323">					result.append(&quot;private static final long serialVersionUID = 1L;\n&quot;);</span>
<span class="fc" id="L1324">					result.append(&quot;{\n&quot;);</span>
<span class="fc" id="L1325">					result.indenting(() -&gt; {</span>
<span class="fc" id="L1326">						result.append(ReflectionUIUtils.class.getName() + &quot;.setFieldControlPluginIdentifier(this, \&quot;&quot;</span>
<span class="fc" id="L1327">								+ controlPluginIdentifier + &quot;\&quot;);\n&quot;);</span>
<span class="pc bpc" id="L1328" title="1 of 2 branches missed.">						if (controlPluginConfiguration != null) {</span>
<span class="fc" id="L1329">							result.append(</span>
<span class="fc" id="L1330">									ReflectionUIUtils.class.getName() + &quot;.setFieldControlPluginConfiguration(this, \&quot;&quot;</span>
<span class="fc" id="L1331">											+ controlPluginIdentifier + &quot;\&quot;, (&quot; + Serializable.class.getName() + &quot;) &quot;</span>
<span class="fc" id="L1332">											+ PluginBuilder.class.getName() + &quot;.readControlPluginConfiguration(\&quot;&quot;</span>
<span class="fc" id="L1333">											+ MiscUtils.escapeJavaString(</span>
<span class="fc" id="L1334">													writeControlPluginConfiguration(controlPluginConfiguration))</span>
<span class="fc" id="L1335">											+ &quot;\&quot;));\n&quot;);</span>
						}
<span class="fc" id="L1337">					});</span>
<span class="fc" id="L1338">					result.append(&quot;}\n&quot;);</span>
<span class="fc" id="L1339">				});</span>
<span class="fc" id="L1340">				result.append(&quot;});\n&quot;);</span>
			}
<span class="fc" id="L1342">		}</span>

		@Override
		public Element getOperationClassElement(String operationClassName, String parameterName) {
<span class="fc" id="L1346">			Structure.SimpleElement result = new Structure.SimpleElement();</span>
<span class="fc" id="L1347">			result.setName(parameterName);</span>
<span class="fc" id="L1348">			result.setTypeNameOrAlias(getTypeNameOrAlias());</span>
<span class="fc" id="L1349">			return result;</span>
		}

		@Override
		protected Element getOperationBuilderClassElement(String operationClassName, String parameterName,
				String parameterCaption) {
<span class="fc bfc" id="L1355" title="All 2 branches covered.">			if (variant) {</span>
<span class="fc" id="L1356">				return new Structure.SimpleElement() {</span>
<span class="fc" id="L1357">					Element base = getOperationClassElement(operationClassName, parameterName);</span>
					{
<span class="fc" id="L1359">						setName(base.getName() + &quot;Variant&quot;);</span>
<span class="fc" id="L1360">						String variantGenericParameterTypeName = adaptVariantGenericParameterTypeName(</span>
<span class="fc" id="L1361">								base.getTypeName(operationClassName));</span>
<span class="fc" id="L1362">						setTypeNameOrAlias(Variant.class.getName() + &quot;&lt;&quot; + variantGenericParameterTypeName + &quot;&gt;&quot;);</span>
<span class="fc" id="L1363">						Structure.Optionality optionality = new Structure.Optionality();</span>
						{
<span class="fc" id="L1365">							optionality.setDefaultValueExpression(&quot;new &quot; + getTypeNameOrAlias() + &quot;(&quot;</span>
<span class="fc" id="L1366">									+ variantGenericParameterTypeName + &quot;.class&quot;</span>
<span class="pc bpc" id="L1367" title="1 of 2 branches missed.">									+ ((defaultValueExpression != null) ? (&quot;, &quot; + defaultValueExpression) : &quot;&quot;) + &quot;)&quot;);</span>
<span class="fc" id="L1368">							setOptionality(optionality);</span>
						}
					}

					@Override
					protected String generateRequiredInnerJavaTypesSourceCode(String operationBuilderClassName,
							Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1375">						return base.generateRequiredInnerJavaTypesSourceCode(operationClassName, options);</span>
					}
				};
			} else {
<span class="fc" id="L1379">				Element result = getOperationClassElement(operationClassName, parameterName);</span>
<span class="pc bpc" id="L1380" title="1 of 2 branches missed.">				if (defaultValueExpression != null) {</span>
<span class="fc" id="L1381">					Structure.Optionality optionality = new Structure.Optionality();</span>
<span class="fc" id="L1382">					optionality.setDefaultValueExpression(defaultValueExpression);</span>
<span class="fc" id="L1383">					result.setOptionality(optionality);</span>
				}
<span class="fc" id="L1385">				return result;</span>
			}
		}

		protected String adaptVariantGenericParameterTypeName(String typeName) {
<span class="nc" id="L1390">			Class&lt;?&gt; simpleClass = MiscUtils.getJESBClass(typeName);</span>
<span class="nc bnc" id="L1391" title="All 2 branches missed.">			if (simpleClass.isPrimitive()) {</span>
<span class="nc" id="L1392">				simpleClass = ClassUtils.primitiveToWrapperClass(simpleClass);</span>
			}
<span class="nc" id="L1394">			return simpleClass.getName();</span>
		}

		@Override
		protected String generateBuildExpression(String operationClassName, String parameterName,
				Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1400">			Element operationBuilderElement = getOperationBuilderClassElement(operationClassName, parameterName, &quot;&quot;);</span>
<span class="nc bnc" id="L1401" title="All 2 branches missed.">			if (variant) {</span>
<span class="nc" id="L1402">				return &quot;this.&quot; + operationBuilderElement.getName() + &quot;.getValue()&quot;;</span>
			} else {
<span class="nc" id="L1404">				return &quot;this.&quot; + operationBuilderElement.getName();</span>
			}
		}

		@Override
		protected String generateBuilderRequiredInnerJavaTypesSourceCode(String operationClassName,
				String parameterName, Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1411">			return null;</span>
		}

		public void validate() throws ValidationError {
<span class="fc" id="L1415">			internalElement.validate(true);</span>
<span class="fc bfc" id="L1416" title="All 2 branches covered.">			if (controlPluginIdentifier != null) {</span>
<span class="fc" id="L1417">				List&lt;String&gt; options = getControlPluginIdentifierOptions();</span>
<span class="pc bpc" id="L1418" title="1 of 2 branches missed.">				if (!options.contains(controlPluginIdentifier)) {</span>
<span class="nc" id="L1419">					throw new ValidationError(&quot;Invalid control plugin identifier: '&quot; + controlPluginIdentifier</span>
<span class="nc" id="L1420">							+ &quot;'. Expected &quot; + options);</span>
				}
			}
<span class="fc" id="L1423">		}</span>
	}

<span class="fc" id="L1426">	public static class ReferenceParameterNature extends ParameterNature {</span>

		private String assetClassName;

		public String getAssetClassName() {
<span class="fc" id="L1431">			return assetClassName;</span>
		}

		public void setAssetClassName(String assetClassName) {
<span class="fc" id="L1435">			this.assetClassName = assetClassName;</span>
<span class="fc" id="L1436">		}</span>

		@Override
		protected void generateOperationBuilderValidationStatements(CodeBuilder result, String operationClassName,
				String parameterName, String parameterCaption) {
<span class="fc" id="L1441">			String builderElementName = getOperationBuilderClassElement(operationClassName, parameterName,</span>
<span class="fc" id="L1442">					parameterCaption).getName();</span>
<span class="fc" id="L1443">			result.append(&quot;if (&quot; + builderElementName + &quot;.resolve() == null) {\n&quot;);</span>
<span class="fc" id="L1444">			result.appendIndented(&quot;throw new &quot; + ValidationError.class.getName() + &quot;(\&quot;Failed to resolve the '&quot;</span>
<span class="fc" id="L1445">					+ MiscUtils.escapeJavaString(parameterCaption) + &quot;' reference\&quot;);\n&quot;);</span>
<span class="fc" id="L1446">			result.append(&quot;}\n&quot;);</span>
<span class="fc" id="L1447">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String operationClassName, String operationBuilderClassSimpleName, String parameterName,
				String parameterCaption) {
<span class="fc" id="L1453">			String builderClassName = operationClassName</span>
<span class="pc bpc" id="L1454" title="1 of 2 branches missed.">					+ ((operationBuilderClassSimpleName != null) ? (&quot;.&quot; + operationBuilderClassSimpleName) : &quot;&quot;);</span>
<span class="fc" id="L1455">			String builderElementName = getOperationBuilderClassElement(operationClassName, parameterName,</span>
<span class="fc" id="L1456">					parameterCaption).getName();</span>
<span class="fc" id="L1457">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="fc" id="L1458">					+ builderClassName + &quot;.class.getName(), \&quot;&quot; + builderElementName + &quot;\&quot;)&quot;</span>
<span class="fc" id="L1459">					+ &quot;\n.setCustomFieldCaption(\&quot;&quot; + MiscUtils.escapeJavaString(parameterCaption) + &quot;\&quot;);\n&quot;);</span>
<span class="fc" id="L1460">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="fc" id="L1461">					+ builderClassName + &quot;.class.getName(), \&quot;&quot; + builderElementName + &quot;\&quot;)&quot;</span>
<span class="fc" id="L1462">					+ &quot;\n.setFormControlEmbeddingForced(true);\n&quot;);</span>
<span class="fc" id="L1463">		}</span>

		public List&lt;String&gt; getAssetClassNameOptions() {
<span class="fc" id="L1466">			List&lt;String&gt; result = new ArrayList&lt;String&gt;();</span>
<span class="fc" id="L1467">			PluginBuilder.INSTANCE.getResources().stream()</span>
<span class="fc" id="L1468">					.map(resource -&gt; PluginBuilder.INSTANCE.getPackageName() + &quot;.&quot; + resource.getResourceTypeName())</span>
<span class="fc" id="L1469">					.forEach(result::add);</span>
<span class="fc" id="L1470">			result.addAll(MiscUtils.getAllResourceMetadatas().stream()</span>
<span class="fc" id="L1471">					.map(metadata -&gt; metadata.getResourceClass().getName()).collect(Collectors.toList()));</span>
<span class="fc" id="L1472">			result.add(Plan.class.getName());</span>
<span class="fc" id="L1473">			result.add(Folder.class.getName());</span>
<span class="fc" id="L1474">			result.add(JAR.class.getName());</span>
<span class="fc" id="L1475">			return result;</span>
		}

		@Override
		public Element getOperationClassElement(String operationClassName, String parameterName) {
<span class="fc" id="L1480">			Structure.SimpleElement result = new Structure.SimpleElement();</span>
<span class="fc" id="L1481">			result.setName(parameterName);</span>
<span class="fc" id="L1482">			result.setTypeNameOrAlias(assetClassName);</span>
<span class="fc" id="L1483">			return result;</span>
		}

		@Override
		protected Element getOperationBuilderClassElement(String operationClassName, String parameterName,
				String parameterCaption) {
<span class="fc" id="L1489">			Structure.SimpleElement result = new Structure.SimpleElement();</span>
<span class="fc" id="L1490">			result.setName(parameterName + &quot;Reference&quot;);</span>
<span class="fc" id="L1491">			result.setTypeNameOrAlias(Reference.class.getName() + &quot;&lt;&quot; + assetClassName + &quot;&gt;&quot;);</span>
<span class="fc" id="L1492">			Structure.Optionality optionality = new Structure.Optionality();</span>
			{
<span class="fc" id="L1494">				optionality.setDefaultValueExpression(&quot;new &quot; + Reference.class.getName() + &quot;&lt;&quot; + assetClassName + &quot;&gt;&quot;</span>
<span class="fc" id="L1495">						+ &quot;(&quot; + assetClassName + &quot;.class)&quot;);</span>
<span class="fc" id="L1496">				result.setOptionality(optionality);</span>
			}
<span class="fc" id="L1498">			return result;</span>
		}

		@Override
		protected String generateBuildExpression(String operationClassName, String parameterName,
				Map&lt;Object, Object&gt; options) {
<span class="fc" id="L1504">			Element operationBuilderElement = getOperationBuilderClassElement(operationClassName, parameterName, &quot;&quot;);</span>
<span class="fc" id="L1505">			return &quot;this.&quot; + operationBuilderElement.getName() + &quot;.resolve()&quot;;</span>
		}

		@Override
		protected String generateBuilderRequiredInnerJavaTypesSourceCode(String operationClassName,
				String parameterName, Map&lt;Object, Object&gt; options) {
<span class="fc" id="L1511">			return null;</span>
		}

		public void validate() throws ValidationError {
<span class="fc bfc" id="L1515" title="All 2 branches covered.">			if (!getAssetClassNameOptions().contains(assetClassName)) {</span>
<span class="fc" id="L1516">				throw new ValidationError(&quot;Invalid referenced asset class name: '&quot; + assetClassName + &quot;'&quot;);</span>
			}
<span class="fc" id="L1518">		}</span>

	}

<span class="fc" id="L1522">	public static class EnumerationParameterNature extends ParameterNature {</span>

<span class="fc" id="L1524">		private Structure.EnumerationStructure structure = new Structure.EnumerationStructure();</span>
		private String defaultValueExpression;
<span class="fc" id="L1526">		private boolean variant = false;</span>
<span class="fc" id="L1527">		private boolean nullable = false;</span>
		private String controlPluginIdentifier;
		private Object controlPluginConfiguration;

		public Structure.EnumerationStructure getStructure() {
<span class="fc" id="L1532">			return structure;</span>
		}

		public void setStructure(Structure.EnumerationStructure structure) {
<span class="fc" id="L1536">			this.structure = structure;</span>
<span class="fc" id="L1537">		}</span>

		public String getDefaultValueExpression() {
<span class="fc" id="L1540">			return defaultValueExpression;</span>
		}

		public void setDefaultValueExpression(String defaultValueExpression) {
<span class="fc" id="L1544">			this.defaultValueExpression = defaultValueExpression;</span>
<span class="fc" id="L1545">		}</span>

		public boolean isVariant() {
<span class="fc" id="L1548">			return variant;</span>
		}

		public void setVariant(boolean variant) {
<span class="fc" id="L1552">			this.variant = variant;</span>
<span class="fc" id="L1553">		}</span>

		public boolean isNullable() {
<span class="fc" id="L1556">			return nullable;</span>
		}

		public void setNullable(boolean nullable) {
<span class="nc" id="L1560">			this.nullable = nullable;</span>
<span class="nc" id="L1561">		}</span>

		public String getControlPluginIdentifier() {
<span class="fc" id="L1564">			return controlPluginIdentifier;</span>
		}

		public void setControlPluginIdentifier(String controlPluginIdentifier) {
<span class="nc" id="L1568">			this.controlPluginIdentifier = controlPluginIdentifier;</span>
<span class="nc" id="L1569">			this.controlPluginConfiguration = PluginBuilder.getControlPluginConfigurationOnIdentifierUpdate(</span>
<span class="nc" id="L1570">					controlPluginIdentifier, controlPluginConfiguration);</span>
<span class="nc" id="L1571">		}</span>

		public Object getControlPluginConfiguration() {
<span class="fc" id="L1574">			return controlPluginConfiguration;</span>
		}

		public void setControlPluginConfiguration(Object controlPluginConfiguration) {
<span class="nc" id="L1578">			this.controlPluginConfiguration = controlPluginConfiguration;</span>
<span class="nc" id="L1579">		}</span>

		public List&lt;String&gt; getControlPluginIdentifierOptions() {
<span class="nc" id="L1582">			IFieldControlInput sampleControlInput = new FieldControlInputProxy(</span>
<span class="nc" id="L1583">					new DefaultFieldControlInput(GUI.INSTANCE.getReflectionUI()) {</span>

						@Override
						public IFieldControlData getControlData() {
<span class="nc" id="L1587">							return new FieldControlDataProxy(super.getControlData()) {</span>

								@Override
								public ITypeInfo getType() {
<span class="nc" id="L1591">									return IEnumerationTypeInfo.NULL_ENUMERATION_TYPE_INFO;</span>
								}

							};
						}
					});
<span class="nc" id="L1597">			SubSwingCustomizer globalSubCustomizer = GUI.INSTANCE</span>
<span class="nc" id="L1598">					.obtainSubCustomizer(GUI.GLOBAL_EXCLUSIVE_CUSTOMIZATIONS);</span>
<span class="nc" id="L1599">			return globalSubCustomizer.getFieldControlPlugins().stream().filter(</span>
<span class="nc" id="L1600">					controlPlugin -&gt; controlPlugin.handles(globalSubCustomizer.getReflectionUI(), sampleControlInput))</span>
<span class="nc" id="L1601">					.map(IFieldControlPlugin::getIdentifier).collect(Collectors.toList());</span>
		}

		@Override
		protected void generateOperationBuilderValidationStatements(CodeBuilder result, String operationClassName,
				String parameterName, String parameterCaption) {
<span class="fc" id="L1607">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String operationClassName, String operationBuilderClassSimpleName, String parameterName,
				String parameterCaption) {
<span class="fc" id="L1613">			getSimpleParameterNatureUtility(operationClassName, parameterName).generateUICustomizationStatements(result,</span>
<span class="fc" id="L1614">					uiCustomizationsVariableName, operationClassName, operationBuilderClassSimpleName, parameterName,</span>
<span class="fc" id="L1615">					parameterCaption);</span>
<span class="fc" id="L1616">		}</span>

		private StructuredElement getEnumerationElementUtility(String operationClassName, String parameterName) {
<span class="fc" id="L1619">			StructuredElement result = new StructuredElement();</span>
<span class="fc" id="L1620">			result.setName(parameterName);</span>
<span class="fc" id="L1621">			result.setStructure(structure);</span>
<span class="fc" id="L1622">			return result;</span>
		}

		private SimpleParameterNature getSimpleParameterNatureUtility(String operationClassName, String parameterName) {
<span class="fc" id="L1626">			SimpleParameterNature result = new SimpleParameterNature() {</span>
				@Override
				protected String adaptVariantGenericParameterTypeName(String typeName) {
<span class="fc" id="L1629">					return typeName;</span>
				}
			};
<span class="fc" id="L1632">			result.setDefaultValueExpression(defaultValueExpression);</span>
<span class="fc" id="L1633">			result.setVariant(variant);</span>
<span class="fc" id="L1634">			result.setTypeNameOrAlias(</span>
<span class="fc" id="L1635">					getEnumerationElementUtility(operationClassName, parameterName).getTypeName(operationClassName));</span>
<span class="fc" id="L1636">			result.setControlPluginIdentifier(controlPluginIdentifier);</span>
<span class="fc" id="L1637">			return result;</span>
		}

		public Element getOperationClassElement(String operationClassName, String parameterName) {
<span class="fc" id="L1641">			return new ElementProxy(getSimpleParameterNatureUtility(operationClassName, parameterName)</span>
<span class="fc" id="L1642">					.getOperationClassElement(operationClassName, parameterName)) {</span>
<span class="fc" id="L1643">				StructuredElement enumerationElement = getEnumerationElementUtility(operationClassName, parameterName);</span>

				@Override
				protected String generateRequiredInnerJavaTypesSourceCode(String parentClassName,
						Map&lt;Object, Object&gt; options) {
<span class="fc" id="L1648">					return enumerationElement.generateRequiredInnerJavaTypesSourceCode(operationClassName, options);</span>
				}
			};
		}

		@Override
		protected Element getOperationBuilderClassElement(String operationClassName, String parameterName,
				String parameterCaption) {
<span class="fc" id="L1656">			return getSimpleParameterNatureUtility(operationClassName, parameterName)</span>
<span class="fc" id="L1657">					.getOperationBuilderClassElement(operationClassName, parameterName, parameterCaption);</span>
		}

		@Override
		protected String generateBuilderRequiredInnerJavaTypesSourceCode(String operationClassName,
				String parameterName, Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1663">			return getSimpleParameterNatureUtility(operationClassName, parameterName)</span>
<span class="nc" id="L1664">					.generateBuilderRequiredInnerJavaTypesSourceCode(operationClassName, parameterName, options);</span>
		}

		@Override
		protected String generateBuildExpression(String operationClassName, String parameterName,
				Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1670">			return getSimpleParameterNatureUtility(operationClassName, parameterName)</span>
<span class="nc" id="L1671">					.generateBuildExpression(operationClassName, parameterName, options);</span>
		}

		public void validate() throws ValidationError {
<span class="fc" id="L1675">			structure.validate(true);</span>
<span class="fc" id="L1676">			PluginBuilder.validateStructure(structure);</span>
<span class="fc" id="L1677">		}</span>

	}

<span class="nc" id="L1681">	public static class GroupParameterNature extends ParameterNature {</span>

<span class="nc" id="L1683">		private boolean nullable = false;</span>

<span class="nc" id="L1685">		private OperationDescriptor internalOperation = new OperationDescriptor() {</span>

			@Override
			protected String getOperationBuilderClassSimpleName() {
<span class="nc" id="L1689">				return &quot;GroupBuilder&quot;;</span>
			}

			@Override
			protected String generateExecutionMethodSourceCode(String className,
					Map&lt;Object, Object&gt; codeGenerationOptions) {
<span class="nc" id="L1695">				return &quot;&quot;;</span>
			}

			@Override
			protected String generateOperationBuilderClassSourceCode(String operationClassName,
					Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1701">				return super.generateOperationBuilderClassSourceCode(operationClassName, options).replace(</span>
<span class="nc" id="L1702">						&quot;implements &quot; + OperationBuilder.class.getName(),</span>
<span class="nc" id="L1703">						&quot;implements &quot; + OperationStructureBuilder.class.getName());</span>
			}

			@Override
			protected String generateOperationResultClassMethodSourceCode(String operationClassName,
					Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1709">				return &quot;&quot;;</span>
			}

			@Override
			protected PlaceHolder getImportsPlaceHolder(String rootClassName) {
<span class="nc" id="L1714">				return PlaceHolder.NULL_PLACEHOLDER;</span>
			}

		};

		public List&lt;ParameterDescriptor&gt; getParameters() {
<span class="nc" id="L1720">			return internalOperation.getParameters();</span>
		}

		public void setParameters(List&lt;ParameterDescriptor&gt; parameters) {
<span class="nc" id="L1724">			internalOperation.setParameters(parameters);</span>
<span class="nc" id="L1725">		}</span>

		public boolean isNullable() {
<span class="nc" id="L1728">			return nullable;</span>
		}

		public void setNullable(boolean nullable) {
<span class="nc" id="L1732">			this.nullable = nullable;</span>
<span class="nc" id="L1733">		}</span>

		@Override
		protected void generateOperationBuilderValidationStatements(CodeBuilder result, String operationClassName,
				String parameterName, String parameterCaption) {
<span class="nc" id="L1738">			String builderElementName = getOperationBuilderClassElement(operationClassName, parameterName,</span>
<span class="nc" id="L1739">					parameterCaption).getName();</span>
<span class="nc" id="L1740">			result.append(&quot;if (recursively) {\n&quot;);</span>
<span class="nc" id="L1741">			result.indenting(() -&gt; {</span>
<span class="nc" id="L1742">				result.append(&quot;try {\n&quot;);</span>
<span class="nc" id="L1743">				result.appendIndented(builderElementName + &quot;.validate(recursively, currentPlan, currentStep);\n&quot;);</span>
<span class="nc" id="L1744">				result.append(&quot;} catch (&quot; + ValidationError.class.getName() + &quot; e) {\n&quot;);</span>
<span class="nc" id="L1745">				result.appendIndented(&quot;throw new &quot; + ValidationError.class.getName() + &quot;(\&quot;Failed to validate '&quot;</span>
<span class="nc" id="L1746">						+ parameterCaption + &quot;'\&quot;, e);\n&quot;);</span>
<span class="nc" id="L1747">				result.append(&quot;}\n&quot;);</span>
<span class="nc" id="L1748">			});</span>
<span class="nc" id="L1749">			result.append(&quot;}\n&quot;);</span>
<span class="nc" id="L1750">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String operationClassName, String operationBuilderClassSimpleName, String parameterName,
				String parameterCaption) {
<span class="nc" id="L1756">			String builderClassName = operationClassName</span>
<span class="nc bnc" id="L1757" title="All 2 branches missed.">					+ ((operationBuilderClassSimpleName != null) ? (&quot;.&quot; + operationBuilderClassSimpleName) : &quot;&quot;);</span>
<span class="nc" id="L1758">			String builderElementName = getOperationBuilderClassElement(operationClassName, parameterName,</span>
<span class="nc" id="L1759">					parameterCaption).getName();</span>
<span class="nc" id="L1760">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="nc" id="L1761">					+ builderClassName + &quot;.class.getName()&quot; + &quot;, \&quot;&quot; + builderElementName</span>
<span class="nc" id="L1762">					+ &quot;)\n.setCustomFieldCaption(\&quot;&quot; + MiscUtils.escapeJavaString(parameterCaption) + &quot;\&quot;);\n&quot;);</span>
<span class="nc" id="L1763">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="nc" id="L1764">					+ builderClassName + &quot;.class.getName()&quot; + &quot;, \&quot;&quot; + builderElementName</span>
<span class="nc" id="L1765">					+ &quot;\&quot;)\n.setValueValidityDetectionForced(true);\n&quot;);</span>
<span class="nc bnc" id="L1766" title="All 2 branches missed.">			if (nullable) {</span>
<span class="nc" id="L1767">				result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="nc" id="L1768">						+ builderClassName + &quot;.class.getName()&quot; + &quot;, \&quot;&quot; + builderElementName</span>
<span class="nc" id="L1769">						+ &quot;\&quot;)\n.setNullValueDistinctForced(true);\n&quot;);</span>
			}
<span class="nc" id="L1771">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="nc" id="L1772">					+ builderClassName + &quot;.class.getName(), \&quot;&quot; + builderElementName + &quot;\&quot;)&quot;</span>
<span class="nc" id="L1773">					+ &quot;\n.setFormControlEmbeddingForced(true);\n&quot;);</span>
<span class="nc" id="L1774">			result.append(getOperationBuilderClassElement(operationClassName, parameterName, parameterCaption)</span>
<span class="nc" id="L1775">					.getFinalTypeNameAdaptedToSourceCode(operationClassName) + &quot;.&quot; + GUI.UI_CUSTOMIZATIONS_METHOD_NAME</span>
<span class="nc" id="L1776">					+ &quot;(&quot; + uiCustomizationsVariableName + &quot;)&quot; + &quot;;\n&quot;);</span>
<span class="nc" id="L1777">		}</span>

		@Override
		public Element getOperationClassElement(String operationClassName, String parameterName) {
<span class="nc" id="L1781">			Structure.StructuredElement result = new Structure.StructuredElement() {</span>
				{
<span class="nc" id="L1783">					setName(parameterName);</span>
<span class="nc" id="L1784">					setStructure(new Structure.ClassicStructure() {</span>
						{
<span class="nc" id="L1786">							String groupStructureTypeName = getTypeName(operationClassName);</span>
<span class="nc bnc" id="L1787" title="All 2 branches missed.">							for (ParameterDescriptor parameter : getParameters()) {</span>
<span class="nc" id="L1788">								getElements().add(parameter.getOperationClassElement(groupStructureTypeName));</span>
							}
						}

						@Override
						public String generateJavaTypeSourceCode(String groupStructureClassName,
								String additionalyImplemented, String additionalyExtended,
								String afterPackageDeclaration, String afterFieldDeclarations,
								String afterMethodDeclarations, Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1797">							internalOperation.setOpertionTypeName(groupStructureClassName);</span>
<span class="nc bnc" id="L1798" title="All 2 branches missed.">							afterMethodDeclarations = ((afterMethodDeclarations != null)</span>
<span class="nc" id="L1799">									? (afterMethodDeclarations + &quot;\n&quot;)</span>
<span class="nc" id="L1800">									: &quot;&quot;)</span>
<span class="nc" id="L1801">									+ internalOperation.generateOperationBuilderClassSourceCode(groupStructureClassName,</span>
<span class="nc" id="L1802">											options);</span>
<span class="nc" id="L1803">							return super.generateJavaTypeSourceCode(groupStructureClassName, additionalyImplemented,</span>
<span class="nc" id="L1804">									additionalyExtended, afterPackageDeclaration, afterFieldDeclarations,</span>
<span class="nc" id="L1805">									afterMethodDeclarations, options);</span>
						}
					});
				}

			};
<span class="nc" id="L1811">			return result;</span>
		}

		@Override
		protected Element getOperationBuilderClassElement(String operationClassName, String parameterName,
				String parameterCaption) {
<span class="nc" id="L1817">			return new Structure.StructuredElement() {</span>
				{
<span class="nc" id="L1819">					setName(parameterName + &quot;GroupBuilder&quot;);</span>
<span class="nc" id="L1820">					setStructure(new Structure.ClassicStructure() {</span>
						{
<span class="nc" id="L1822">							String groupStructureTypeName = getOperationClassElement(operationClassName, parameterName)</span>
<span class="nc" id="L1823">									.getTypeName(operationClassName);</span>
<span class="nc bnc" id="L1824" title="All 2 branches missed.">							for (ParameterDescriptor parameter : getParameters()) {</span>
<span class="nc" id="L1825">								getElements().add(parameter.getOperationBuilderClassElement(groupStructureTypeName));</span>
							}
						}
					});
<span class="nc" id="L1829">					Structure.Optionality optionality = new Structure.Optionality();</span>
					{
<span class="nc" id="L1831">						optionality.setDefaultValueExpression(</span>
<span class="nc" id="L1832">								&quot;new &quot; + getFinalTypeNameAdaptedToSourceCode(operationClassName) + &quot;()&quot;);</span>
<span class="nc" id="L1833">						setOptionality(optionality);</span>
					}

				}

				@Override
				protected String getTypeName(String parentClassName) {
<span class="nc" id="L1840">					return getOperationClassElement(operationClassName, parameterName).getTypeName(operationClassName)</span>
<span class="nc" id="L1841">							+ &quot;$&quot; + internalOperation.getOperationBuilderClassSimpleName();</span>
				}

			};
		}

		@Override
		protected String generateBuildExpression(String operationClassName, String parameterName,
				Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1850">			Element operationBuilderElement = getOperationBuilderClassElement(operationClassName, parameterName, &quot;&quot;);</span>
<span class="nc" id="L1851">			return &quot;this.&quot; + operationBuilderElement.getName() + &quot;.build(context, executionInspector)&quot;;</span>
		}

		@Override
		protected String generateBuilderRequiredInnerJavaTypesSourceCode(String operationClassName,
				String parameterName, Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1857">			return null;</span>
		}

		public void validate() throws ValidationError {
<span class="nc bnc" id="L1861" title="All 2 branches missed.">			for (ParameterDescriptor parameter : getParameters()) {</span>
<span class="nc" id="L1862">				parameter.validate();</span>
			}

<span class="nc" id="L1865">		}</span>
	}

<span class="fc" id="L1868">	public static class DynamicParameterNature extends ParameterNature {</span>

<span class="fc" id="L1870">		private Structure structure = new Structure.ClassicStructure();</span>
		private List&lt;StructureDerivationAlternative&gt; concreteStructureAlternatives;

		public Structure getStructure() {
<span class="fc" id="L1874">			return structure;</span>
		}

		public void setStructure(Structure structure) {
<span class="fc" id="L1878">			this.structure = structure;</span>
<span class="fc" id="L1879">		}</span>

		public List&lt;StructureDerivationAlternative&gt; getConcreteStructureAlternatives() {
<span class="fc" id="L1882">			return concreteStructureAlternatives;</span>
		}

		public void setConcreteStructureAlternatives(
				List&lt;StructureDerivationAlternative&gt; concreteStructureAlternatives) {
<span class="nc" id="L1887">			this.concreteStructureAlternatives = concreteStructureAlternatives;</span>
<span class="nc" id="L1888">		}</span>

		@Override
		protected void generateOperationBuilderValidationStatements(CodeBuilder result, String operationClassName,
				String parameterName, String parameterCaption) {
<span class="fc" id="L1893">			String builderElementName = getOperationBuilderClassElement(operationClassName, parameterName,</span>
<span class="fc" id="L1894">					parameterCaption).getName();</span>
<span class="fc" id="L1895">			result.append(&quot;if (recursively) {\n&quot;);</span>
<span class="fc" id="L1896">			result.indenting(() -&gt; {</span>
<span class="fc" id="L1897">				result.append(&quot;try {\n&quot;);</span>
<span class="fc" id="L1898">				result.appendIndented(builderElementName</span>
<span class="fc" id="L1899">						+ &quot;.getFacade().validate(recursively, currentPlan.getValidationContext(currentStep).getVariableDeclarations());\n&quot;);</span>
<span class="fc" id="L1900">				result.append(&quot;} catch (&quot; + ValidationError.class.getName() + &quot; e) {\n&quot;);</span>
<span class="fc" id="L1901">				result.appendIndented(&quot;throw new &quot; + ValidationError.class.getName() + &quot;(\&quot;Failed to validate '&quot;</span>
<span class="fc" id="L1902">						+ parameterCaption + &quot;'\&quot;, e);\n&quot;);</span>
<span class="fc" id="L1903">				result.append(&quot;}\n&quot;);</span>
<span class="fc" id="L1904">			});</span>
<span class="fc" id="L1905">			result.append(&quot;}\n&quot;);</span>
<span class="fc" id="L1906">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String operationClassName, String operationBuilderClassSimpleName, String parameterName,
				String parameterCaption) {
<span class="fc" id="L1912">			String builderClassName = operationClassName</span>
<span class="pc bpc" id="L1913" title="1 of 2 branches missed.">					+ ((operationBuilderClassSimpleName != null) ? (&quot;.&quot; + operationBuilderClassSimpleName) : &quot;&quot;);</span>
<span class="fc" id="L1914">			String builderElementName = getOperationBuilderClassElement(operationClassName, parameterName,</span>
<span class="fc" id="L1915">					parameterCaption).getName();</span>
<span class="fc" id="L1916">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="fc" id="L1917">					+ builderClassName + &quot;.class.getName(), \&quot;&quot; + builderElementName + &quot;\&quot;)&quot;</span>
<span class="fc" id="L1918">					+ &quot;\n.setCustomFieldCaption(\&quot;\&quot;);\n&quot;);</span>
<span class="fc" id="L1919">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="fc" id="L1920">					+ builderClassName + &quot;.class.getName(), \&quot;&quot; + builderElementName + &quot;\&quot;)&quot;</span>
<span class="fc" id="L1921">					+ &quot;\n.setFormControlEmbeddingForced(true);\n&quot;);</span>
<span class="fc" id="L1922">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="fc" id="L1923">					+ builderClassName + &quot;.class.getName(), \&quot;&quot; + builderElementName + &quot;\&quot;)&quot;</span>
<span class="fc" id="L1924">					+ &quot;\n.setValueValidityDetectionForced(true);\n&quot;);</span>
<span class="fc" id="L1925">		}</span>

		@Override
		public Structure.Element getOperationClassElement(String operationClassName, String parameterName) {
<span class="fc" id="L1929">			Structure.StructuredElement result = new Structure.StructuredElement();</span>
<span class="fc" id="L1930">			result.setName(parameterName);</span>
<span class="fc" id="L1931">			result.setStructure(getStructure());</span>
<span class="fc" id="L1932">			return new Structure.ElementProxy(result) {</span>
				@Override
				protected String generateRequiredInnerJavaTypesSourceCode(String operationClassName,
						Map&lt;Object, Object&gt; options) {
<span class="fc" id="L1936">					options = new HashMap&lt;Object, Object&gt;(options);</span>
<span class="fc" id="L1937">					Structure.ElementAccessMode.PUBLIC_FIELD.set(options);</span>
<span class="pc bpc" id="L1938" title="1 of 2 branches missed.">					if (concreteStructureAlternatives != null) {</span>
<span class="nc" id="L1939">						CodeBuilder result = new CodeBuilder();</span>
<span class="nc" id="L1940">						result.append(&quot;abstract &quot;</span>
<span class="nc" id="L1941">								+ super.generateRequiredInnerJavaTypesSourceCode(operationClassName, options));</span>
<span class="nc bnc" id="L1942" title="All 2 branches missed.">						for (StructureDerivationAlternative alternative : concreteStructureAlternatives) {</span>
<span class="nc" id="L1943">							result.append(&quot;\n&quot; + alternative.generateRequiredInnerJavaTypesSourceCode(</span>
<span class="nc" id="L1944">									operationClassName, getBaseStructureTypeName(operationClassName, parameterName),</span>
<span class="nc" id="L1945">									structure, options));</span>
						}
<span class="nc" id="L1947">						return result.toString();</span>
					} else {
<span class="fc" id="L1949">						return super.generateRequiredInnerJavaTypesSourceCode(operationClassName, options);</span>
					}
				}
			};
		}

		@Override
		protected Element getOperationBuilderClassElement(String operationClassName, String parameterName,
				String parameterCaption) {
<span class="fc" id="L1958">			return new Structure.SimpleElement() {</span>
<span class="fc" id="L1959">				Element base = getOperationClassElement(operationClassName, parameterName);</span>
				{
<span class="fc" id="L1961">					setName(base.getName() + &quot;DynamicBuilder&quot;);</span>
<span class="fc" id="L1962">					setTypeNameOrAlias(RootInstanceBuilder.class.getName());</span>
<span class="fc" id="L1963">					Structure.Optionality optionality = new Structure.Optionality();</span>
					{
						String classNameArgumentExpression;
<span class="pc bpc" id="L1966" title="1 of 2 branches missed.">						if (concreteStructureAlternatives != null) {</span>
<span class="nc" id="L1967">							classNameArgumentExpression = &quot;new &quot; + getConcreteTypeNameAccessorClassName(parameterName)</span>
<span class="nc" id="L1968">									+ &quot;()&quot;;</span>
<span class="nc" id="L1969">						} else {</span>
<span class="fc" id="L1970">							classNameArgumentExpression = base.getFinalTypeNameAdaptedToSourceCode(operationClassName)</span>
<span class="fc" id="L1971">									+ &quot;.class.getName()&quot;;</span>
						}
<span class="fc" id="L1973">						optionality.setDefaultValueExpression(&quot;new &quot; + RootInstanceBuilder.class.getName() + &quot;(\&quot;&quot;</span>
<span class="fc" id="L1974">								+ MiscUtils.escapeJavaString(parameterCaption) + &quot;\&quot;, &quot; + classNameArgumentExpression</span>
<span class="fc" id="L1975">								+ &quot;)&quot;);</span>
<span class="fc" id="L1976">						setOptionality(optionality);</span>
					}
				}

			};
		}

		private String getBaseStructureTypeName(String operationClassName, String parameterName) {
<span class="nc" id="L1984">			return getOperationClassElement(operationClassName, parameterName).getTypeName(operationClassName);</span>
		}

		private String getConcreteTypeNameAccessorClassName(String parameterName) {
<span class="nc" id="L1988">			return parameterName.substring(0, 1).toUpperCase() + parameterName.substring(1) + &quot;InputClassNameAccessor&quot;;</span>
		}

		private String generateConcreteTypeNameAccessorClassSourceCode(String operationClassName, String parameterName,
				Map&lt;Object, Object&gt; options) {
<span class="nc" id="L1993">			CodeBuilder result = new CodeBuilder();</span>
<span class="nc" id="L1994">			result.append(&quot;private class &quot; + getConcreteTypeNameAccessorClassName(parameterName) + &quot; extends &quot;</span>
<span class="nc" id="L1995">					+ Accessor.class.getName() + &quot;&lt;String&gt; {\n&quot;);</span>
<span class="nc" id="L1996">			result.append(&quot;\n&quot;);</span>
<span class="nc" id="L1997">			result.indenting(() -&gt; {</span>
<span class="nc" id="L1998">				result.append(&quot;@Override\n&quot;);</span>
<span class="nc" id="L1999">				result.append(&quot;public String get() {\n&quot;);</span>
<span class="nc" id="L2000">				result.appendIndented(</span>
<span class="nc" id="L2001">						generateConcreteTypeNameGetterBody(operationClassName, parameterName, options) + &quot;\n&quot;);</span>
<span class="nc" id="L2002">				result.append(&quot;}\n&quot;);</span>
<span class="nc" id="L2003">			});</span>
<span class="nc" id="L2004">			result.append(&quot;\n&quot;);</span>
<span class="nc" id="L2005">			result.append(&quot;}&quot;);</span>
<span class="nc" id="L2006">			return result.toString();</span>
		}

		protected String generateConcreteTypeNameGetterBody(String operationClassName, String parameterName,
				Map&lt;Object, Object&gt; options) {
<span class="nc" id="L2011">			CodeBuilder result = new CodeBuilder();</span>
<span class="nc bnc" id="L2012" title="All 2 branches missed.">			for (StructureDerivationAlternative alternative : concreteStructureAlternatives) {</span>
<span class="nc" id="L2013">				result.append(&quot;if (&quot; + alternative.getCondition() + &quot;) {\n&quot;);</span>
<span class="nc" id="L2014">				result.appendIndented(&quot;return &quot;</span>
<span class="nc" id="L2015">						+ alternative.getConcreteStructureTypeName(operationClassName,</span>
<span class="nc" id="L2016">								getBaseStructureTypeName(operationClassName, parameterName), structure)</span>
<span class="nc" id="L2017">						+ &quot;.class.getName();\n&quot;);</span>
<span class="nc" id="L2018">				result.append(&quot;}\n&quot;);</span>
			}
<span class="nc" id="L2020">			result.append(&quot;return null;&quot;);</span>
<span class="nc" id="L2021">			return result.toString();</span>
		}

		@Override
		protected String generateBuildExpression(String operationClassName, String parameterName,
				Map&lt;Object, Object&gt; options) {
<span class="fc" id="L2027">			Element operationElement = getOperationClassElement(operationClassName, parameterName);</span>
<span class="fc" id="L2028">			Element operationBuilderElement = getOperationBuilderClassElement(operationClassName, parameterName, &quot;&quot;);</span>
<span class="fc" id="L2029">			return &quot;(&quot; + operationElement.getFinalTypeNameAdaptedToSourceCode(operationClassName) + &quot;) this.&quot;</span>
<span class="fc" id="L2030">					+ operationBuilderElement.getName() + &quot;.build(new &quot; + InstantiationContext.class.getName()</span>
<span class="fc" id="L2031">					+ &quot;(context.getVariables(), context.getPlan().getValidationContext(context.getCurrentStep()).getVariableDeclarations()))&quot;;</span>
		}

		@Override
		protected String generateBuilderRequiredInnerJavaTypesSourceCode(String operationClassName,
				String parameterName, Map&lt;Object, Object&gt; options) {
<span class="pc bpc" id="L2037" title="1 of 2 branches missed.">			if (concreteStructureAlternatives != null) {</span>
<span class="nc" id="L2038">				return generateConcreteTypeNameAccessorClassSourceCode(operationClassName, parameterName, options);</span>
			}
<span class="fc" id="L2040">			return null;</span>
		}

		public void validate() throws ValidationError {
<span class="fc" id="L2044">			structure.validate(true);</span>
<span class="fc" id="L2045">			PluginBuilder.validateStructure(structure);</span>
<span class="fc" id="L2046">		}</span>
	}

<span class="nc" id="L2049">	public static class StructureDerivationAlternative {</span>

		private String alternativeName;
		private String condition;
<span class="nc" id="L2053">		private Structure.ClassicStructure structureDerivation = new Structure.ClassicStructure();</span>

		public String getAlternativeName() {
<span class="nc" id="L2056">			return alternativeName;</span>
		}

		public void setAlternativeName(String alternativeName) {
<span class="nc" id="L2060">			this.alternativeName = alternativeName;</span>
<span class="nc" id="L2061">		}</span>

		public Structure.ClassicStructure getStructureDerivation() {
<span class="nc" id="L2064">			return structureDerivation;</span>
		}

		public void setStructureDerivation(Structure.ClassicStructure structureDerivation) {
<span class="nc" id="L2068">			this.structureDerivation = structureDerivation;</span>
<span class="nc" id="L2069">		}</span>

		public String getCondition() {
<span class="nc" id="L2072">			return condition;</span>
		}

		public void setCondition(String condition) {
<span class="nc" id="L2076">			this.condition = condition;</span>
<span class="nc" id="L2077">		}</span>

		public String generateRequiredInnerJavaTypesSourceCode(String operationClassName, String baseStructureTypeName,
				Structure baseStructure, Map&lt;Object, Object&gt; options) {
<span class="nc" id="L2081">			Structure.StructuredElement utilityElement = getConcreteStructureUtilityElement(baseStructureTypeName,</span>
<span class="nc" id="L2082">					baseStructure);</span>
<span class="nc" id="L2083">			return utilityElement.generateRequiredInnerJavaTypesSourceCode(operationClassName, options);</span>
		}

		public String getConcreteStructureTypeName(String operationClassName, String baseStructureTypeName,
				Structure baseStructure) {
<span class="nc" id="L2088">			Structure.StructuredElement utilityElement = getConcreteStructureUtilityElement(baseStructureTypeName,</span>
<span class="nc" id="L2089">					baseStructure);</span>
<span class="nc" id="L2090">			return utilityElement.getFinalTypeNameAdaptedToSourceCode(operationClassName);</span>
		}

		private StructuredElement getConcreteStructureUtilityElement(String baseStructureTypeName,
				Structure baseStructure) {
<span class="nc" id="L2095">			return new Structure.StructuredElement() {</span>
				{
<span class="nc" id="L2097">					setName(alternativeName + baseStructureTypeName.replaceAll(&quot;Structure$&quot;, &quot;&quot;));</span>
<span class="nc" id="L2098">					setStructure(new Structure.DerivedClassicStructure(baseStructureTypeName, baseStructure) {</span>
						{
<span class="nc" id="L2100">							getElements().addAll(structureDerivation.getElements());</span>
						}
					});
				}

			};
		}

		public void validate() throws ValidationError {
<span class="nc bnc" id="L2109" title="All 4 branches missed.">			if ((alternativeName == null) || alternativeName.isEmpty()) {</span>
<span class="nc" id="L2110">				throw new ValidationError(&quot;Structure alternative name not provided&quot;);</span>
			}
<span class="nc bnc" id="L2112" title="All 4 branches missed.">			if ((condition == null) || condition.isEmpty()) {</span>
<span class="nc" id="L2113">				throw new ValidationError(&quot;Structure alternative condition not provided&quot;);</span>
			}
<span class="nc" id="L2115">			structureDerivation.validate(true);</span>
<span class="nc" id="L2116">		}</span>

	}

<span class="fc" id="L2120">	public static class ResourceDescriptor extends UIStructureBasedDescriptor {</span>

		private String resourceTypeName;
		private String resourceTypeCaption;
		private byte[] resourceIconImageData;
<span class="fc" id="L2125">		private List&lt;PropertyDescriptor&gt; properties = new ArrayList&lt;PropertyDescriptor&gt;();</span>
		private String additionalValidationStatements;

		public String getResourceTypeName() {
<span class="fc" id="L2129">			return resourceTypeName;</span>
		}

		public void setResourceTypeName(String resourceTypeName) {
<span class="fc" id="L2133">			this.resourceTypeName = resourceTypeName;</span>
<span class="fc" id="L2134">		}</span>

		public String getResourceTypeCaption() {
<span class="fc" id="L2137">			return resourceTypeCaption;</span>
		}

		public void setResourceTypeCaption(String resourceTypeCaption) {
<span class="fc" id="L2141">			this.resourceTypeCaption = resourceTypeCaption;</span>
<span class="fc" id="L2142">		}</span>

		public List&lt;PropertyDescriptor&gt; getProperties() {
<span class="fc" id="L2145">			return properties;</span>
		}

		public void setProperties(List&lt;PropertyDescriptor&gt; properties) {
<span class="fc" id="L2149">			this.properties = properties;</span>
<span class="fc" id="L2150">		}</span>

		public String getAdditionalValidationStatements() {
<span class="fc" id="L2153">			return additionalValidationStatements;</span>
		}

		public void setAdditionalValidationStatements(String additionalValidationStatements) {
<span class="nc" id="L2157">			this.additionalValidationStatements = additionalValidationStatements;</span>
<span class="nc" id="L2158">		}</span>

		public byte[] getResourceIconImageData() {
<span class="nc" id="L2161">			return resourceIconImageData;</span>
		}

		public void setResourceIconImageData(byte[] resourceIconImageData) {
<span class="nc" id="L2165">			this.resourceIconImageData = resourceIconImageData;</span>
<span class="nc" id="L2166">		}</span>

		public void loadIconImage(File file) throws IOException {
<span class="nc" id="L2169">			resourceIconImageData = MiscUtils.readBinary(file);</span>
<span class="nc" id="L2170">		}</span>

		public BufferedImage getIconImage() {
<span class="pc bpc" id="L2173" title="1 of 2 branches missed.">			if (resourceIconImageData == null) {</span>
<span class="fc" id="L2174">				return null;</span>
			}
			try {
<span class="nc" id="L2177">				return ImageIO.read(new ByteArrayInputStream(resourceIconImageData));</span>
<span class="nc" id="L2178">			} catch (IOException e) {</span>
<span class="nc" id="L2179">				throw new UnexpectedError(e);</span>
			}
		}

		public File generateJavaSourceCode(File sourceDirectroy, String packageName) {
<span class="fc" id="L2184">			Map&lt;Object, Object&gt; codeGenerationOptions = Structure.ElementAccessMode.ACCESSORS.singletonOptions();</span>
<span class="fc" id="L2185">			String resourceClassName = packageName + &quot;.&quot; + resourceTypeName;</span>
<span class="fc" id="L2186">			File javaFile = new File(sourceDirectroy, resourceClassName.replace(&quot;.&quot;, &quot;/&quot;) + &quot;.java&quot;);</span>
			try {
<span class="pc bpc" id="L2188" title="1 of 2 branches missed.">				if (!javaFile.getParentFile().exists()) {</span>
<span class="nc" id="L2189">					MiscUtils.createDirectory(javaFile.getParentFile(), true);</span>
				}
<span class="fc" id="L2191">				MiscUtils.write(javaFile, generateJavaSourceCode(packageName, codeGenerationOptions), false);</span>
<span class="pc" id="L2192">			} catch (IOException e) {</span>
<span class="nc" id="L2193">				throw new UnexpectedError(e);</span>
			}
<span class="fc" id="L2195">			return javaFile;</span>
		}

		protected String generateJavaSourceCode(String packageName, Map&lt;Object, Object&gt; codeGenerationOptions) {
<span class="pc bpc" id="L2199" title="1 of 2 branches missed.">			String resourceClassName = ((packageName != null) ? (packageName + &quot;.&quot;) : &quot;&quot;) + resourceTypeName;</span>
<span class="fc" id="L2200">			String extended = Resource.class.getName();</span>
<span class="fc" id="L2201">			Structure.ClassicStructure resourceStructure = new Structure.ClassicStructure();</span>
<span class="fc bfc" id="L2202" title="All 2 branches covered.">			for (PropertyDescriptor property : properties) {</span>
<span class="fc" id="L2203">				resourceStructure.getElements().add(property.getResourceClassElement(resourceClassName));</span>
			}
<span class="fc" id="L2205">			CodeBuilder afterFieldDeclarations = new CodeBuilder();</span>
<span class="fc" id="L2206">			CodeBuilder afterMethodDeclarations = new CodeBuilder();</span>
<span class="fc" id="L2207">			CodeBuilder afterPackageDeclaration = new CodeBuilder();</span>
<span class="fc" id="L2208">			PlaceHolder importsPlaceHolder = getImportsPlaceHolder(resourceClassName);</span>
<span class="fc" id="L2209">			afterPackageDeclaration.append(importsPlaceHolder.getReferenceString());</span>
<span class="fc" id="L2210">			afterMethodDeclarations.append(</span>
<span class="pc bpc" id="L2211" title="1 of 2 branches missed.">					generateUICustomizationsMethodSourceCode((packageName != null) ? (packageName + &quot;.&quot;) : &quot;&quot;) + &quot;\n&quot;);</span>
<span class="fc" id="L2212">			afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="fc" id="L2213">			generateValidationMethodSourceCode(afterMethodDeclarations, resourceClassName, codeGenerationOptions);</span>
<span class="fc" id="L2214">			afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="fc" id="L2215">			afterMethodDeclarations</span>
<span class="fc" id="L2216">					.append(generateMetadataClassSourceCode(resourceClassName, codeGenerationOptions) + &quot;\n&quot;);</span>
<span class="pc bpc" id="L2217" title="1 of 2 branches missed.">			if (getAdditionalFieldDeclarationsSourceCode() != null) {</span>
<span class="nc" id="L2218">				afterFieldDeclarations.append(getAdditionalFieldDeclarationsSourceCode());</span>
			}
<span class="fc bfc" id="L2220" title="All 2 branches covered.">			if (getAdditionalMethodDeclarationsSourceCode() != null) {</span>
<span class="fc" id="L2221">				afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="fc" id="L2222">				afterMethodDeclarations.append(getAdditionalMethodDeclarationsSourceCode());</span>
			}
<span class="fc" id="L2224">			generateAdditionalConstructorsSourceCode(afterFieldDeclarations);</span>
<span class="fc" id="L2225">			return new CodeBuilder(resourceStructure.generateJavaTypeSourceCode(resourceClassName, null, extended,</span>
<span class="fc" id="L2226">					afterPackageDeclaration.toString(), afterFieldDeclarations.toString(),</span>
<span class="fc" id="L2227">					afterMethodDeclarations.toString(), codeGenerationOptions)).registerPlaceHolder(importsPlaceHolder)</span>
<span class="fc" id="L2228">							.toString();</span>
		}

		protected void generateAdditionalConstructorsSourceCode(CodeBuilder result) {
<span class="fc" id="L2232">			result.append(&quot;\n&quot;);</span>
<span class="fc" id="L2233">			result.append(&quot;public &quot; + resourceTypeName + &quot;(String name) {\n&quot;);</span>
<span class="fc" id="L2234">			result.appendIndented(&quot;super(name);\n&quot;);</span>
<span class="fc" id="L2235">			result.append(&quot;}&quot;);</span>
<span class="fc" id="L2236">		}</span>

		protected void generateValidationMethodSourceCode(CodeBuilder result, String resourceClassName,
				Map&lt;Object, Object&gt; codeGenerationOptions) {
<span class="fc" id="L2240">			result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2241">			result.append(</span>
<span class="fc" id="L2242">					&quot;public void validate(boolean recursively) throws &quot; + ValidationError.class.getName() + &quot; {\n&quot;);</span>
<span class="fc" id="L2243">			result.indenting(() -&gt; {</span>
<span class="fc bfc" id="L2244" title="All 2 branches covered.">				for (PropertyDescriptor property : properties) {</span>
<span class="fc" id="L2245">					property.getNature().generateResourceValidationStatements(result, resourceClassName,</span>
<span class="fc" id="L2246">							property.getName(), property.getCaption());</span>
				}
<span class="pc bpc" id="L2248" title="1 of 2 branches missed.">				if (additionalValidationStatements != null) {</span>
<span class="nc" id="L2249">					result.append(additionalValidationStatements + &quot;\n&quot;);</span>
				}
<span class="fc" id="L2251">			});</span>
<span class="fc" id="L2252">			result.append(&quot;}\n&quot;);</span>
<span class="fc" id="L2253">		}</span>

		protected String generateMetadataClassSourceCode(String resourceClassName, Map&lt;Object, Object&gt; options) {
<span class="fc" id="L2256">			String className = &quot;Metadata&quot;;</span>
<span class="fc" id="L2257">			String resourceClassSimpleName = MiscUtils.extractSimpleNameFromClassName(resourceClassName);</span>
<span class="fc" id="L2258">			String implemented = ResourceMetadata.class.getName();</span>
<span class="fc" id="L2259">			CodeBuilder result = new CodeBuilder();</span>
<span class="fc" id="L2260">			result.append(&quot;public static class &quot; + className + &quot; implements &quot; + implemented + &quot;{&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L2261">			result.indenting(() -&gt; {</span>
<span class="fc" id="L2262">				result.append(&quot;\n&quot;);</span>
				{
<span class="fc" id="L2264">					result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2265">					result.append(&quot;public String getResourceTypeName() {\n&quot;);</span>
<span class="fc" id="L2266">					result.appendIndented(&quot;return \&quot;&quot; + resourceTypeCaption + &quot;\&quot;;&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L2267">					result.append(&quot;}\n&quot;);</span>
				}
<span class="fc" id="L2269">				result.append(&quot;\n&quot;);</span>
				{
<span class="fc" id="L2271">					result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2272">					result.append(&quot;public Class&lt;? extends &quot; + Resource.class.getName() + &quot;&gt; getResourceClass() {\n&quot;);</span>
<span class="fc" id="L2273">					result.appendIndented(&quot;return &quot; + resourceClassSimpleName + &quot;.class;&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L2274">					result.append(&quot;}\n&quot;);</span>
				}
<span class="fc" id="L2276">				result.append(&quot;\n&quot;);</span>
				{
<span class="fc" id="L2278">					result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2279">					result.append(&quot;public &quot; + ResourcePath.class.getName() + &quot; getResourceIconImagePath() {\n&quot;);</span>
<span class="fc" id="L2280">					result.appendIndented(&quot;return new &quot; + ResourcePath.class.getName() + &quot;(&quot;</span>
<span class="fc" id="L2281">							+ ResourcePath.class.getName() + &quot;.specifyClassPathResourceLocation(&quot;</span>
<span class="fc" id="L2282">							+ resourceClassSimpleName + &quot;.class.getName().replace(\&quot;.\&quot;, \&quot;/\&quot;) + \&quot;.png\&quot;));&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L2283">					result.append(&quot;}\n&quot;);</span>
				}
<span class="fc" id="L2285">				result.append(&quot;\n&quot;);</span>
<span class="fc" id="L2286">			});</span>
<span class="fc" id="L2287">			result.append(&quot;}&quot;);</span>
<span class="fc" id="L2288">			return result.toString();</span>
		}

		@Override
		protected List&lt;? extends UIElementBasedDescriptor&gt; getUIElements() {
<span class="fc" id="L2293">			return properties;</span>
		}

		@Override
		protected String getDisplayedTypeName(String prefix) {
<span class="fc" id="L2298">			String resourceClassName = prefix + resourceTypeName;</span>
<span class="fc" id="L2299">			return resourceClassName;</span>
		}

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, UIElementBasedDescriptor uiElement,
				String uiCustomizationsVariableName, String displayedTypeName) {
<span class="fc" id="L2305">			PropertyDescriptor property = (PropertyDescriptor) uiElement;</span>
<span class="fc" id="L2306">			String resourceClassName = displayedTypeName;</span>
<span class="fc" id="L2307">			property.getNature().generateUICustomizationStatements(result, uiCustomizationsVariableName,</span>
<span class="fc" id="L2308">					resourceClassName, property.getName(), property.getCaption());</span>
<span class="fc" id="L2309">		}</span>

		public void validate() throws ValidationError {
<span class="pc bpc" id="L2312" title="1 of 4 branches missed.">			if ((resourceTypeName == null) || resourceTypeName.isEmpty()) {</span>
<span class="fc" id="L2313">				throw new ValidationError(&quot;Resource class name not provided&quot;);</span>
			}
<span class="fc bfc" id="L2315" title="All 2 branches covered.">			for (PropertyDescriptor property : properties) {</span>
<span class="fc" id="L2316">				property.validate();</span>
			}
<span class="fc" id="L2318">		}</span>

		public com.otk.jesb.resource.Experiment test() throws Exception {
<span class="pc bpc" id="L2321" title="1 of 2 branches missed.">			if (PluginBuilder.INSTANCE.isTestingPrepared()) {</span>
<span class="nc" id="L2322">				PluginBuilder.INSTANCE.unprepareTesting();</span>
			}
<span class="fc" id="L2324">			PluginBuilder.INSTANCE.prepareTesting();</span>
<span class="fc" id="L2325">			String fullClassName = PluginBuilder.INSTANCE.getPackageName() + &quot;.&quot; + resourceTypeName;</span>
<span class="fc" id="L2326">			Resource resource = (Resource) MiscUtils.getJESBClass(fullClassName).newInstance();</span>
<span class="fc" id="L2327">			return new com.otk.jesb.resource.Experiment(resource);</span>
		}
	}

<span class="fc" id="L2331">	public static class PropertyDescriptor extends UIElementBasedDescriptor {</span>

<span class="fc" id="L2333">		private PropertyNature nature = new SimplePropertyNature();</span>

		public PropertyNature getNature() {
<span class="fc" id="L2336">			return nature;</span>
		}

		public void setNature(PropertyNature nature) {
<span class="fc" id="L2340">			this.nature = nature;</span>
<span class="fc" id="L2341">		}</span>

		public Element getResourceClassElement(String resourceClassName) {
<span class="fc" id="L2344">			return ensureNotReadOnly(nature.getResourceClassElement(resourceClassName, getName(), getCaption()));</span>
		}

		@Override
		protected String getDisplayedFieldName(UIStructureBasedDescriptor parent, String displayedTypeNamePrefix) {
<span class="fc" id="L2349">			String resourceClassName = parent.getDisplayedTypeName(displayedTypeNamePrefix);</span>
<span class="fc" id="L2350">			return getResourceClassElement(resourceClassName).getName();</span>
		}

		public void validate() throws ValidationError {
<span class="pc bpc" id="L2354" title="1 of 4 branches missed.">			if ((getName() == null) || getName().isEmpty()) {</span>
<span class="fc" id="L2355">				throw new ValidationError(&quot;Property name not provided&quot;);</span>
			}
<span class="fc" id="L2357">			nature.validate();</span>
<span class="fc" id="L2358">		}</span>

	}

<span class="fc" id="L2362">	public abstract static class PropertyNature {</span>

		protected abstract void validate() throws ValidationError;

		protected abstract void generateResourceValidationStatements(CodeBuilder result, String resourceClassName,
				String propertyName, String propertyCaption);

		protected abstract void generateUICustomizationStatements(CodeBuilder result,
				String uiCustomizationsVariableName, String resourceClassName, String propertyName,
				String propertyCaption);

		protected abstract Element getResourceClassElement(String resourceClassName, String propertyName,
				String propertyCaption);

	}

<span class="fc" id="L2378">	public static class SimplePropertyNature extends PropertyNature {</span>

<span class="fc" id="L2380">		private SimpleParameterNature internalParameterNature = new SimpleParameterNature();</span>

		public String getTypeNameOrAlias() {
<span class="fc" id="L2383">			return internalParameterNature.getTypeNameOrAlias();</span>
		}

		public void setTypeNameOrAlias(String typeNameOrAlias) {
<span class="nc" id="L2387">			internalParameterNature.setTypeNameOrAlias(typeNameOrAlias);</span>
<span class="nc" id="L2388">		}</span>

		public List&lt;String&gt; getTypeNameOrAliasOptions() {
<span class="fc" id="L2391">			return internalParameterNature.getTypeNameOrAliasOptions();</span>
		}

		public String getDefaultValueExpression() {
<span class="fc" id="L2395">			return internalParameterNature.getDefaultValueExpression();</span>
		}

		public void setDefaultValueExpression(String defaultValueExpression) {
<span class="nc" id="L2399">			internalParameterNature.setDefaultValueExpression(defaultValueExpression);</span>
<span class="nc" id="L2400">		}</span>

		public boolean isVariant() {
<span class="fc" id="L2403">			return internalParameterNature.isVariant();</span>
		}

		public void setVariant(boolean variant) {
<span class="nc" id="L2407">			internalParameterNature.setVariant(variant);</span>
<span class="nc" id="L2408">		}</span>

		public boolean isNullable() {
<span class="fc" id="L2411">			return internalParameterNature.isNullable();</span>
		}

		public void setNullable(boolean nullable) {
<span class="nc" id="L2415">			internalParameterNature.setNullable(nullable);</span>
<span class="nc" id="L2416">		}</span>

		public String getControlPluginIdentifier() {
<span class="fc" id="L2419">			return internalParameterNature.getControlPluginIdentifier();</span>
		}

		public void setControlPluginIdentifier(String controlPluginIdentifier) {
<span class="nc" id="L2423">			internalParameterNature.setControlPluginIdentifier(controlPluginIdentifier);</span>
<span class="nc" id="L2424">		}</span>

		public Object getControlPluginConfiguration() {
<span class="fc" id="L2427">			return (AbstractConfiguration) internalParameterNature.getControlPluginConfiguration();</span>
		}

		public void setControlPluginConfiguration(Object controlPluginConfiguration) {
<span class="nc" id="L2431">			internalParameterNature.setControlPluginConfiguration(controlPluginConfiguration);</span>
<span class="nc" id="L2432">		}</span>

		public List&lt;String&gt; getControlPluginIdentifierOptions() {
<span class="nc" id="L2435">			return internalParameterNature.getControlPluginIdentifierOptions();</span>
		}

		@Override
		protected Element getResourceClassElement(String resourceClassName, String propertyName,
				String propertyCaption) {
<span class="nc" id="L2441">			return internalParameterNature.getOperationBuilderClassElement(resourceClassName, propertyName,</span>
<span class="nc" id="L2442">					propertyCaption);</span>
		}

		@Override
		protected void generateResourceValidationStatements(CodeBuilder result, String resourceClassName,
				String propertyName, String propertyCaption) {
<span class="nc" id="L2448">			internalParameterNature.generateOperationBuilderValidationStatements(result, resourceClassName,</span>
<span class="nc" id="L2449">					propertyName, propertyCaption);</span>
<span class="nc" id="L2450">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String resourceClassName, String propertyName, String propertyCaption) {
<span class="nc" id="L2455">			internalParameterNature.generateUICustomizationStatements(result, uiCustomizationsVariableName,</span>
<span class="nc" id="L2456">					resourceClassName, null, propertyName, propertyCaption);</span>
<span class="nc" id="L2457">		}</span>

		@Override
		protected void validate() throws ValidationError {
<span class="fc" id="L2461">			internalParameterNature.validate();</span>
<span class="fc" id="L2462">		}</span>

	}

<span class="fc" id="L2466">	public static class EnumerationPropertyNature extends PropertyNature {</span>

<span class="fc" id="L2468">		private EnumerationParameterNature internalParameterNature = new EnumerationParameterNature();</span>

		public EnumerationStructure getStructure() {
<span class="fc" id="L2471">			return internalParameterNature.getStructure();</span>
		}

		public void setStructure(EnumerationStructure structure) {
<span class="fc" id="L2475">			internalParameterNature.setStructure(structure);</span>
<span class="fc" id="L2476">		}</span>

		public String getDefaultValueExpression() {
<span class="fc" id="L2479">			return internalParameterNature.getDefaultValueExpression();</span>
		}

		public void setDefaultValueExpression(String defaultValueExpression) {
<span class="fc" id="L2483">			internalParameterNature.setDefaultValueExpression(defaultValueExpression);</span>
<span class="fc" id="L2484">		}</span>

		public boolean isVariant() {
<span class="fc" id="L2487">			return internalParameterNature.isVariant();</span>
		}

		public void setVariant(boolean variant) {
<span class="fc" id="L2491">			internalParameterNature.setVariant(variant);</span>
<span class="fc" id="L2492">		}</span>

		public boolean isNullable() {
<span class="fc" id="L2495">			return internalParameterNature.isNullable();</span>
		}

		public void setNullable(boolean nullable) {
<span class="nc" id="L2499">			internalParameterNature.setNullable(nullable);</span>
<span class="nc" id="L2500">		}</span>

		public String getControlPluginIdentifier() {
<span class="fc" id="L2503">			return internalParameterNature.getControlPluginIdentifier();</span>
		}

		public void setControlPluginIdentifier(String controlPluginIdentifier) {
<span class="nc" id="L2507">			internalParameterNature.setControlPluginIdentifier(controlPluginIdentifier);</span>
<span class="nc" id="L2508">		}</span>

		public Object getControlPluginConfiguration() {
<span class="fc" id="L2511">			return internalParameterNature.getControlPluginConfiguration();</span>
		}

		public void setControlPluginConfiguration(Object controlPluginConfiguration) {
<span class="nc" id="L2515">			internalParameterNature.setControlPluginConfiguration(controlPluginConfiguration);</span>
<span class="nc" id="L2516">		}</span>

		public List&lt;String&gt; getControlPluginIdentifierOptions() {
<span class="nc" id="L2519">			return internalParameterNature.getControlPluginIdentifierOptions();</span>
		}

		@Override
		protected Element getResourceClassElement(String resourceClassName, String propertyName,
				String propertyCaption) {
<span class="fc" id="L2525">			return new ElementProxy(internalParameterNature.getOperationBuilderClassElement(resourceClassName,</span>
<span class="fc" id="L2526">					propertyName, propertyCaption)) {</span>
<span class="fc" id="L2527">				Element operationElement = internalParameterNature.getOperationClassElement(resourceClassName,</span>
<span class="fc" id="L2528">						propertyName);</span>

				@Override
				protected String generateRequiredInnerJavaTypesSourceCode(String parentClassName,
						Map&lt;Object, Object&gt; options) {
<span class="fc" id="L2533">					return operationElement.generateRequiredInnerJavaTypesSourceCode(parentClassName, options);</span>
				}

			};
		}

		@Override
		protected void generateResourceValidationStatements(CodeBuilder result, String resourceClassName,
				String propertyName, String propertyCaption) {
<span class="fc" id="L2542">			internalParameterNature.generateOperationBuilderValidationStatements(result, resourceClassName,</span>
<span class="fc" id="L2543">					propertyName, propertyCaption);</span>
<span class="fc" id="L2544">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String resourceClassName, String propertyName, String propertyCaption) {
<span class="fc" id="L2549">			internalParameterNature.generateUICustomizationStatements(result, uiCustomizationsVariableName,</span>
<span class="fc" id="L2550">					resourceClassName, null, propertyName, propertyCaption);</span>
<span class="fc" id="L2551">		}</span>

		@Override
		protected void validate() throws ValidationError {
<span class="fc" id="L2555">			internalParameterNature.validate();</span>
<span class="fc" id="L2556">		}</span>

	}

<span class="nc" id="L2560">	public static class ReferencePropertyNature extends PropertyNature {</span>

<span class="nc" id="L2562">		private ReferenceParameterNature internalParameterNature = new ReferenceParameterNature();</span>

		public String getAssetClassName() {
<span class="nc" id="L2565">			return internalParameterNature.getAssetClassName();</span>
		}

		public void setAssetClassName(String assetClassName) {
<span class="nc" id="L2569">			internalParameterNature.setAssetClassName(assetClassName);</span>
<span class="nc" id="L2570">		}</span>

		public List&lt;String&gt; getAssetClassNameOptions() {
<span class="nc" id="L2573">			return internalParameterNature.getAssetClassNameOptions();</span>
		}

		@Override
		protected Element getResourceClassElement(String resourceClassName, String propertyName,
				String propertyCaption) {
<span class="nc" id="L2579">			return new ElementProxy(internalParameterNature.getOperationBuilderClassElement(resourceClassName,</span>
<span class="nc" id="L2580">					propertyName, propertyCaption)) {</span>
<span class="nc" id="L2581">				Element operationElement = internalParameterNature.getOperationClassElement(resourceClassName,</span>
<span class="nc" id="L2582">						propertyName);</span>

				@Override
				protected String generateRequiredInnerJavaTypesSourceCode(String parentClassName,
						Map&lt;Object, Object&gt; options) {
<span class="nc" id="L2587">					return operationElement.generateRequiredInnerJavaTypesSourceCode(parentClassName, options);</span>
				}

			};
		}

		@Override
		protected void generateResourceValidationStatements(CodeBuilder result, String resourceClassName,
				String propertyName, String propertyCaption) {
<span class="nc" id="L2596">			internalParameterNature.generateOperationBuilderValidationStatements(result, resourceClassName,</span>
<span class="nc" id="L2597">					propertyName, propertyCaption);</span>
<span class="nc" id="L2598">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String resourceClassName, String propertyName, String propertyCaption) {
<span class="nc" id="L2603">			internalParameterNature.generateUICustomizationStatements(result, uiCustomizationsVariableName,</span>
<span class="nc" id="L2604">					resourceClassName, null, propertyName, propertyCaption);</span>
<span class="nc" id="L2605">		}</span>

		@Override
		protected void validate() throws ValidationError {
<span class="nc" id="L2609">			internalParameterNature.validate();</span>
<span class="nc" id="L2610">		}</span>

	}

<span class="nc" id="L2614">	public static class GroupPropertyNature extends PropertyNature {</span>

<span class="nc" id="L2616">		private boolean nullable = false;</span>

<span class="nc" id="L2618">		private ResourceDescriptor internalResource = new ResourceDescriptor() {</span>

			@Override
			protected String generateMetadataClassSourceCode(String resourceClassName, Map&lt;Object, Object&gt; options) {
<span class="nc" id="L2622">				return &quot;&quot;;</span>
			}

			@Override
			protected String generateJavaSourceCode(String packageName, Map&lt;Object, Object&gt; codeGenerationOptions) {
<span class="nc" id="L2627">				return super.generateJavaSourceCode(packageName, codeGenerationOptions).replace(</span>
<span class="nc" id="L2628">						&quot;extends &quot; + Resource.class.getName(), &quot;implements &quot; + ResourceStructure.class.getName());</span>
			}

			@Override
			protected PlaceHolder getImportsPlaceHolder(String rootClassName) {
<span class="nc" id="L2633">				return PlaceHolder.NULL_PLACEHOLDER;</span>
			}
		};

		public List&lt;PropertyDescriptor&gt; getProperties() {
<span class="nc" id="L2638">			return internalResource.getProperties();</span>
		}

		public void setProperties(List&lt;PropertyDescriptor&gt; properties) {
<span class="nc" id="L2642">			internalResource.setProperties(properties);</span>
<span class="nc" id="L2643">		}</span>

		public boolean isNullable() {
<span class="nc" id="L2646">			return nullable;</span>
		}

		public void setNullable(boolean nullable) {
<span class="nc" id="L2650">			this.nullable = nullable;</span>
<span class="nc" id="L2651">		}</span>

		@Override
		protected void generateResourceValidationStatements(CodeBuilder result, String resourceClassName,
				String propertyName, String propertyCaption) {
<span class="nc" id="L2656">			String elementName = getResourceClassElement(resourceClassName, propertyName, propertyCaption).getName();</span>
<span class="nc" id="L2657">			result.append(&quot;if (recursively) {\n&quot;);</span>
<span class="nc" id="L2658">			result.indenting(() -&gt; {</span>
<span class="nc" id="L2659">				result.append(&quot;try {\n&quot;);</span>
<span class="nc" id="L2660">				result.appendIndented(elementName + &quot;.validate(recursively);\n&quot;);</span>
<span class="nc" id="L2661">				result.append(&quot;} catch (&quot; + ValidationError.class.getName() + &quot; e) {\n&quot;);</span>
<span class="nc" id="L2662">				result.appendIndented(&quot;throw new &quot; + ValidationError.class.getName() + &quot;(\&quot;Failed to validate '&quot;</span>
<span class="nc" id="L2663">						+ propertyCaption + &quot;'\&quot;, e);\n&quot;);</span>
<span class="nc" id="L2664">				result.append(&quot;}\n&quot;);</span>
<span class="nc" id="L2665">			});</span>
<span class="nc" id="L2666">			result.append(&quot;}\n&quot;);</span>
<span class="nc" id="L2667">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String resourceClassName, String propertyName, String propertyCaption) {
<span class="nc" id="L2672">			String uiTypeName = resourceClassName;</span>
<span class="nc" id="L2673">			String uiElementName = getResourceClassElement(resourceClassName, propertyName, propertyCaption).getName();</span>
<span class="nc" id="L2674">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="nc" id="L2675">					+ uiTypeName + &quot;.class.getName()&quot; + &quot;, \&quot;&quot; + uiElementName</span>
<span class="nc" id="L2676">					+ &quot;\&quot;)\n.setValueValidityDetectionForced(true);\n&quot;);</span>
<span class="nc bnc" id="L2677" title="All 2 branches missed.">			if (nullable) {</span>
<span class="nc" id="L2678">				result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="nc" id="L2679">						+ uiTypeName + &quot;.class.getName()&quot; + &quot;, \&quot;&quot; + uiElementName</span>
<span class="nc" id="L2680">						+ &quot;\&quot;)\n.setNullValueDistinctForced(true);\n&quot;);</span>
			}
<span class="nc" id="L2682">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="nc" id="L2683">					+ uiTypeName + &quot;.class.getName(), \&quot;&quot; + uiElementName + &quot;\&quot;)&quot;</span>
<span class="nc" id="L2684">					+ &quot;.\nsetFormControlEmbeddingForced(true);\n&quot;);</span>
<span class="nc" id="L2685">			result.append(getResourceClassElement(resourceClassName, propertyName, propertyCaption)</span>
<span class="nc" id="L2686">					.getFinalTypeNameAdaptedToSourceCode(resourceClassName) + &quot;.&quot; + GUI.UI_CUSTOMIZATIONS_METHOD_NAME</span>
<span class="nc" id="L2687">					+ &quot;(&quot; + uiCustomizationsVariableName + &quot;)&quot; + &quot;;\n&quot;);</span>
<span class="nc" id="L2688">		}</span>

		@Override
		protected Element getResourceClassElement(String resourceClassName, String propertyName,
				String propertyCaption) {
<span class="nc" id="L2693">			Structure.StructuredElement result = new Structure.StructuredElement() {</span>
				{
<span class="nc" id="L2695">					setName(propertyName);</span>
<span class="nc" id="L2696">					setStructure(new Structure.ClassicStructure() {</span>
						{
<span class="nc" id="L2698">							String groupStructureTypeName = getTypeName(resourceClassName);</span>
<span class="nc bnc" id="L2699" title="All 2 branches missed.">							for (PropertyDescriptor property : getProperties()) {</span>
<span class="nc" id="L2700">								getElements().add(property.getResourceClassElement(groupStructureTypeName));</span>
							}
						}

						@Override
						public String generateJavaTypeSourceCode(String groupStructureClassName,
								String additionalyImplemented, String additionalyExtended,
								String afterPackageDeclaration, String afterFieldDeclarations,
								String afterMethodDeclarations, Map&lt;Object, Object&gt; options) {
<span class="nc" id="L2709">							internalResource.setResourceTypeName(groupStructureClassName);</span>
<span class="nc" id="L2710">							String packageName = MiscUtils.extractPackageNameFromClassName(groupStructureClassName);</span>
<span class="nc" id="L2711">							return internalResource.generateJavaSourceCode(packageName, options);</span>
						}
					});
<span class="nc" id="L2714">					Structure.Optionality optionality = new Structure.Optionality();</span>
					{
<span class="nc" id="L2716">						optionality.setDefaultValueExpression(</span>
<span class="nc" id="L2717">								&quot;new &quot; + getFinalTypeNameAdaptedToSourceCode(resourceClassName) + &quot;()&quot;);</span>
<span class="nc" id="L2718">						setOptionality(optionality);</span>
					}
				}
			};
<span class="nc" id="L2722">			return result;</span>
		}

		public void validate() throws ValidationError {
<span class="nc bnc" id="L2726" title="All 2 branches missed.">			for (PropertyDescriptor property : getProperties()) {</span>
<span class="nc" id="L2727">				property.validate();</span>
			}
<span class="nc" id="L2729">		}</span>
	}

<span class="fc" id="L2732">	public static class ActivatorDescriptor extends UIStructureBasedDescriptor {</span>

		private String activatorTypeName;
		private String activatorTypeCaption;
		private byte[] activatorIconImageData;
<span class="fc" id="L2737">		private List&lt;AttributeDescriptor&gt; attributes = new ArrayList&lt;AttributeDescriptor&gt;();</span>
		private ClassOptionDescriptor inputClassOption;
		private ClassOptionDescriptor outputClassOption;
		private String additionalValidationStatements;
		private String handlerInitializationStatements;
		private String handlerFinalizationStatements;

		public String getActivatorTypeName() {
<span class="fc" id="L2745">			return activatorTypeName;</span>
		}

		public void setActivatorTypeName(String activatorTypeName) {
<span class="fc" id="L2749">			this.activatorTypeName = activatorTypeName;</span>
<span class="fc" id="L2750">		}</span>

		public String getActivatorTypeCaption() {
<span class="fc" id="L2753">			return activatorTypeCaption;</span>
		}

		public void setActivatorTypeCaption(String activatorTypeCaption) {
<span class="fc" id="L2757">			this.activatorTypeCaption = activatorTypeCaption;</span>
<span class="fc" id="L2758">		}</span>

		public String getHandlerInitializationStatements() {
<span class="fc" id="L2761">			return handlerInitializationStatements;</span>
		}

		public void setHandlerInitializationStatements(String handlerInitializationStatements) {
<span class="fc" id="L2765">			this.handlerInitializationStatements = handlerInitializationStatements;</span>
<span class="fc" id="L2766">		}</span>

		public String getHandlerFinalizationStatements() {
<span class="fc" id="L2769">			return handlerFinalizationStatements;</span>
		}

		public void setHandlerFinalizationStatements(String handlerFinalizationStatements) {
<span class="nc" id="L2773">			this.handlerFinalizationStatements = handlerFinalizationStatements;</span>
<span class="nc" id="L2774">		}</span>

		public List&lt;AttributeDescriptor&gt; getAttributes() {
<span class="fc" id="L2777">			return attributes;</span>
		}

		public void setAttributes(List&lt;AttributeDescriptor&gt; attributes) {
<span class="fc" id="L2781">			this.attributes = attributes;</span>
<span class="fc" id="L2782">		}</span>

		public ClassOptionDescriptor getInputClassOption() {
<span class="fc" id="L2785">			return inputClassOption;</span>
		}

		public void setInputClassOption(ClassOptionDescriptor inputClassOption) {
<span class="nc" id="L2789">			this.inputClassOption = inputClassOption;</span>
<span class="nc" id="L2790">		}</span>

		public ClassOptionDescriptor getOutputClassOption() {
<span class="fc" id="L2793">			return outputClassOption;</span>
		}

		public void setOutputClassOption(ClassOptionDescriptor outputClassOption) {
<span class="nc" id="L2797">			this.outputClassOption = outputClassOption;</span>
<span class="nc" id="L2798">		}</span>

		public String getAdditionalValidationStatements() {
<span class="fc" id="L2801">			return additionalValidationStatements;</span>
		}

		public void setAdditionalValidationStatements(String additionalValidationStatements) {
<span class="nc" id="L2805">			this.additionalValidationStatements = additionalValidationStatements;</span>
<span class="nc" id="L2806">		}</span>

		public byte[] getActivatorIconImageData() {
<span class="nc" id="L2809">			return activatorIconImageData;</span>
		}

		public void setActivatorIconImageData(byte[] activatorIconImageData) {
<span class="nc" id="L2813">			this.activatorIconImageData = activatorIconImageData;</span>
<span class="nc" id="L2814">		}</span>

		public void loadIconImage(File file) throws IOException {
<span class="nc" id="L2817">			activatorIconImageData = MiscUtils.readBinary(file);</span>
<span class="nc" id="L2818">		}</span>

		public BufferedImage getIconImage() {
<span class="pc bpc" id="L2821" title="1 of 2 branches missed.">			if (activatorIconImageData == null) {</span>
<span class="fc" id="L2822">				return null;</span>
			}
			try {
<span class="nc" id="L2825">				return ImageIO.read(new ByteArrayInputStream(activatorIconImageData));</span>
<span class="nc" id="L2826">			} catch (IOException e) {</span>
<span class="nc" id="L2827">				throw new UnexpectedError(e);</span>
			}
		}

		public File generateJavaSourceCode(File sourceDirectroy, String packageName) {
<span class="fc" id="L2832">			Map&lt;Object, Object&gt; codeGenerationOptions = Structure.ElementAccessMode.ACCESSORS.singletonOptions();</span>
<span class="fc" id="L2833">			String activatorClassName = packageName + &quot;.&quot; + activatorTypeName;</span>
<span class="fc" id="L2834">			File javaFile = new File(sourceDirectroy, activatorClassName.replace(&quot;.&quot;, &quot;/&quot;) + &quot;.java&quot;);</span>
			try {
<span class="pc bpc" id="L2836" title="1 of 2 branches missed.">				if (!javaFile.getParentFile().exists()) {</span>
<span class="nc" id="L2837">					MiscUtils.createDirectory(javaFile.getParentFile(), true);</span>
				}
<span class="fc" id="L2839">				MiscUtils.write(javaFile, generateJavaSourceCode(packageName, codeGenerationOptions), false);</span>
<span class="pc" id="L2840">			} catch (IOException e) {</span>
<span class="nc" id="L2841">				throw new UnexpectedError(e);</span>
			}
<span class="fc" id="L2843">			return javaFile;</span>
		}

		protected String generateJavaSourceCode(String packageName, Map&lt;Object, Object&gt; codeGenerationOptions) {
<span class="pc bpc" id="L2847" title="1 of 2 branches missed.">			String activatorClassName = ((packageName != null) ? (packageName + &quot;.&quot;) : &quot;&quot;) + activatorTypeName;</span>
<span class="fc" id="L2848">			String extended = Activator.class.getName();</span>
<span class="fc" id="L2849">			Structure.ClassicStructure activatorStructure = new Structure.ClassicStructure();</span>
<span class="fc bfc" id="L2850" title="All 2 branches covered.">			for (AttributeDescriptor attribute : attributes) {</span>
<span class="fc" id="L2851">				activatorStructure.getElements().add(attribute.getActivatorClassElement(activatorClassName));</span>
			}
<span class="fc" id="L2853">			CodeBuilder afterPackageDeclaration = new CodeBuilder();</span>
<span class="fc" id="L2854">			CodeBuilder afterFieldDeclarations = new CodeBuilder();</span>
<span class="fc" id="L2855">			CodeBuilder afterMethodDeclarations = new CodeBuilder();</span>
<span class="fc" id="L2856">			CodeBuilder innerClassesDeclarations = new CodeBuilder();</span>
<span class="fc" id="L2857">			PlaceHolder importsPlaceHolder = getImportsPlaceHolder(activatorClassName);</span>
<span class="fc" id="L2858">			afterPackageDeclaration.append(importsPlaceHolder.getReferenceString());</span>
<span class="fc" id="L2859">			afterFieldDeclarations.append(getActivationHandlerFieldDeclartionSourceCode() + &quot;\n&quot;);</span>
<span class="fc" id="L2860">			generateInputSourceCode(activatorClassName, afterMethodDeclarations, innerClassesDeclarations,</span>
<span class="fc" id="L2861">					codeGenerationOptions);</span>
<span class="fc" id="L2862">			afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="fc" id="L2863">			generateOutputSourceCode(activatorClassName, afterMethodDeclarations, innerClassesDeclarations,</span>
<span class="fc" id="L2864">					codeGenerationOptions);</span>
<span class="fc" id="L2865">			afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="fc" id="L2866">			generateTriggerMethodsSourceCode(afterMethodDeclarations);</span>
<span class="fc" id="L2867">			afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="fc" id="L2868">			afterMethodDeclarations.append(</span>
<span class="pc bpc" id="L2869" title="1 of 2 branches missed.">					generateUICustomizationsMethodSourceCode((packageName != null) ? (packageName + &quot;.&quot;) : &quot;&quot;) + &quot;\n&quot;);</span>
<span class="fc" id="L2870">			afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="fc" id="L2871">			generateValidationMethodSourceCode(afterMethodDeclarations, activatorClassName);</span>
<span class="fc" id="L2872">			innerClassesDeclarations</span>
<span class="fc" id="L2873">					.append(generateMetadataClassSourceCode(activatorClassName, codeGenerationOptions) + &quot;\n&quot;);</span>
<span class="pc bpc" id="L2874" title="1 of 2 branches missed.">			if (getAdditionalFieldDeclarationsSourceCode() != null) {</span>
<span class="nc" id="L2875">				afterFieldDeclarations.append(getAdditionalFieldDeclarationsSourceCode() + &quot;\n&quot;);</span>
			}
<span class="pc bpc" id="L2877" title="1 of 2 branches missed.">			if (getAdditionalMethodDeclarationsSourceCode() != null) {</span>
<span class="nc" id="L2878">				afterMethodDeclarations.append(&quot;\n&quot;);</span>
<span class="nc" id="L2879">				afterMethodDeclarations.append(getAdditionalMethodDeclarationsSourceCode() + &quot;\n&quot;);</span>
			}
<span class="fc" id="L2881">			return new CodeBuilder(activatorStructure.generateJavaTypeSourceCode(activatorClassName, null, extended,</span>
<span class="fc" id="L2882">					afterPackageDeclaration.toString(), afterFieldDeclarations.toString(),</span>
<span class="fc" id="L2883">					afterMethodDeclarations.toString() + &quot;\n&quot; + innerClassesDeclarations.toString(),</span>
<span class="fc" id="L2884">					codeGenerationOptions)).registerPlaceHolder(importsPlaceHolder).toString();</span>
		}

		protected String getActivationHandlerFieldDeclartionSourceCode() {
<span class="fc" id="L2888">			return &quot;private &quot; + com.otk.jesb.activation.ActivationHandler.class.getName() + &quot; activationHandler;&quot;;</span>
		}

		protected void generateValidationMethodSourceCode(CodeBuilder result, String activatorClassName) {
<span class="fc" id="L2892">			result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2893">			result.append(&quot;public void validate(boolean recursively, &quot; + Plan.class.getName() + &quot; plan) throws &quot;</span>
<span class="fc" id="L2894">					+ ValidationError.class.getName() + &quot; {\n&quot;);</span>
<span class="fc" id="L2895">			result.indenting(() -&gt; {</span>
<span class="fc" id="L2896">				result.append(&quot;super.validate(recursively, plan);\n&quot;);</span>
<span class="fc bfc" id="L2897" title="All 2 branches covered.">				for (AttributeDescriptor attribute : attributes) {</span>
<span class="fc" id="L2898">					attribute.getNature().generateActivatorValidationStatements(result, activatorClassName,</span>
<span class="fc" id="L2899">							attribute.getName(), attribute.getCaption());</span>
				}
<span class="pc bpc" id="L2901" title="1 of 2 branches missed.">				if (additionalValidationStatements != null) {</span>
<span class="nc" id="L2902">					result.append(additionalValidationStatements + &quot;\n&quot;);</span>
				}
<span class="fc" id="L2904">			});</span>
<span class="fc" id="L2905">			result.append(&quot;}\n&quot;);</span>
<span class="fc" id="L2906">		}</span>

		protected void generateTriggerMethodsSourceCode(CodeBuilder result) {
			{
<span class="fc" id="L2910">				result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2911">				result.append(&quot;public boolean isAutomaticallyTriggerable() {\n&quot;);</span>
<span class="fc" id="L2912">				result.appendIndented(&quot;return true;\n&quot;);</span>
<span class="fc" id="L2913">				result.append(&quot;}&quot;);</span>
			}
<span class="fc" id="L2915">			result.append(&quot;\n&quot;);</span>
			{
<span class="fc" id="L2917">				result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2918">				result.append(&quot;public void initializeAutomaticTrigger(&quot; + ActivationHandler.class.getName()</span>
<span class="fc" id="L2919">						+ &quot; activationHandler) throws Exception {\n&quot;);</span>
<span class="fc" id="L2920">				result.appendIndented(&quot;this.activationHandler = activationHandler;\n&quot;);</span>
<span class="fc bfc" id="L2921" title="All 2 branches covered.">				if (handlerInitializationStatements != null) {</span>
<span class="fc" id="L2922">					result.appendIndented(handlerInitializationStatements + &quot;\n&quot;);</span>
				}
<span class="fc" id="L2924">				result.append(&quot;}\n&quot;);</span>
			}
<span class="fc" id="L2926">			result.append(&quot;\n&quot;);</span>
			{
<span class="fc" id="L2928">				result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2929">				result.append(&quot;public void finalizeAutomaticTrigger() throws Exception {\n&quot;);</span>
<span class="pc bpc" id="L2930" title="1 of 2 branches missed.">				if (handlerFinalizationStatements != null) {</span>
<span class="nc" id="L2931">					result.appendIndented(handlerFinalizationStatements + &quot;\n&quot;);</span>
				}
<span class="fc" id="L2933">				result.appendIndented(&quot;this.activationHandler = null;\n&quot;);</span>
<span class="fc" id="L2934">				result.append(&quot;}\n&quot;);</span>
			}
<span class="fc" id="L2936">			result.append(&quot;\n&quot;);</span>
			{
<span class="fc" id="L2938">				result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2939">				result.append(&quot;public boolean isAutomaticTriggerReady() {\n&quot;);</span>
<span class="fc" id="L2940">				result.appendIndented(&quot;return activationHandler != null;\n&quot;);</span>
<span class="fc" id="L2941">				result.append(&quot;}\n&quot;);</span>
			}

<span class="fc" id="L2944">		}</span>

		protected void generateOutputSourceCode(String activatorClassName, CodeBuilder additionalMethodDeclarations,
				CodeBuilder additionalInnerClassesDeclarations, Map&lt;Object, Object&gt; codeGenerationOptions) {
<span class="fc" id="L2948">			additionalMethodDeclarations.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2949">			additionalMethodDeclarations.append(&quot;public Class&lt;?&gt; getOutputClass() {\n&quot;);</span>
<span class="pc bpc" id="L2950" title="1 of 2 branches missed.">			if (outputClassOption == null) {</span>
<span class="fc" id="L2951">				additionalMethodDeclarations.appendIndented(&quot;return null;\n&quot;);</span>
<span class="fc" id="L2952">			} else {</span>
<span class="nc" id="L2953">				additionalInnerClassesDeclarations.append(outputClassOption</span>
<span class="nc" id="L2954">						.generateClassesSourceCode(activatorClassName, &quot;outputClass&quot;, codeGenerationOptions) + &quot;\n&quot;);</span>
<span class="nc" id="L2955">				additionalMethodDeclarations</span>
<span class="nc" id="L2956">						.appendIndented(outputClassOption.generateClassOptionMethodBody(activatorClassName,</span>
<span class="nc" id="L2957">								&quot;outputClass&quot;, codeGenerationOptions) + &quot;\n&quot;);</span>
			}
<span class="fc" id="L2959">			additionalMethodDeclarations.append(&quot;}\n&quot;);</span>
<span class="fc" id="L2960">		}</span>

		protected void generateInputSourceCode(String activatorClassName, CodeBuilder additionalMethodDeclarations,
				CodeBuilder additionalInnerClassesDeclarations, Map&lt;Object, Object&gt; codeGenerationOptions) {
<span class="fc" id="L2964">			additionalMethodDeclarations.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2965">			additionalMethodDeclarations.append(&quot;public Class&lt;?&gt; getInputClass() {\n&quot;);</span>
<span class="pc bpc" id="L2966" title="1 of 2 branches missed.">			if (inputClassOption == null) {</span>
<span class="fc" id="L2967">				additionalMethodDeclarations.appendIndented(&quot;return null;\n&quot;);</span>
<span class="fc" id="L2968">			} else {</span>
<span class="nc" id="L2969">				additionalInnerClassesDeclarations.append(inputClassOption.generateClassesSourceCode(activatorClassName,</span>
<span class="nc" id="L2970">						&quot;inputClass&quot;, codeGenerationOptions) + &quot;\n&quot;);</span>
<span class="nc" id="L2971">				additionalMethodDeclarations.appendIndented(inputClassOption</span>
<span class="nc" id="L2972">						.generateClassOptionMethodBody(activatorClassName, &quot;inputClass&quot;, codeGenerationOptions) + &quot;\n&quot;);</span>
			}
<span class="fc" id="L2974">			additionalMethodDeclarations.append(&quot;}\n&quot;);</span>
<span class="fc" id="L2975">		}</span>

		protected String generateMetadataClassSourceCode(String resourceClassName, Map&lt;Object, Object&gt; options) {
<span class="fc" id="L2978">			String className = &quot;Metadata&quot;;</span>
<span class="fc" id="L2979">			String activatorClassSimpleName = MiscUtils.extractSimpleNameFromClassName(resourceClassName);</span>
<span class="fc" id="L2980">			String implemented = ActivatorMetadata.class.getName();</span>
<span class="fc" id="L2981">			CodeBuilder result = new CodeBuilder();</span>
<span class="fc" id="L2982">			result.append(&quot;public static class &quot; + className + &quot; implements &quot; + implemented + &quot;{&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L2983">			result.indenting(() -&gt; {</span>
<span class="fc" id="L2984">				result.append(&quot;\n&quot;);</span>
				{
<span class="fc" id="L2986">					result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2987">					result.append(&quot;public String getActivatorName() {\n&quot;);</span>
<span class="fc" id="L2988">					result.appendIndented(&quot;return \&quot;&quot; + activatorTypeCaption + &quot;\&quot;;&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L2989">					result.append(&quot;}\n&quot;);</span>
				}
<span class="fc" id="L2991">				result.append(&quot;\n&quot;);</span>
				{
<span class="fc" id="L2993">					result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L2994">					result.append(&quot;public Class&lt;? extends &quot; + Activator.class.getName() + &quot;&gt; getActivatorClass() {\n&quot;);</span>
<span class="fc" id="L2995">					result.appendIndented(&quot;return &quot; + activatorClassSimpleName + &quot;.class;&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L2996">					result.append(&quot;}\n&quot;);</span>
				}
<span class="fc" id="L2998">				result.append(&quot;\n&quot;);</span>
				{
<span class="fc" id="L3000">					result.append(&quot;@Override\n&quot;);</span>
<span class="fc" id="L3001">					result.append(&quot;public &quot; + ResourcePath.class.getName() + &quot; getActivatorIconImagePath() {\n&quot;);</span>
<span class="fc" id="L3002">					result.appendIndented(&quot;return new &quot; + ResourcePath.class.getName() + &quot;(&quot;</span>
<span class="fc" id="L3003">							+ ResourcePath.class.getName() + &quot;.specifyClassPathResourceLocation(&quot;</span>
<span class="fc" id="L3004">							+ activatorClassSimpleName + &quot;.class.getName().replace(\&quot;.\&quot;, \&quot;/\&quot;) + \&quot;.png\&quot;));&quot; + &quot;\n&quot;);</span>
<span class="fc" id="L3005">					result.append(&quot;}\n&quot;);</span>
				}
<span class="fc" id="L3007">				result.append(&quot;\n&quot;);</span>
<span class="fc" id="L3008">			});</span>
<span class="fc" id="L3009">			result.append(&quot;}&quot;);</span>
<span class="fc" id="L3010">			return result.toString();</span>
		}

		@Override
		protected List&lt;? extends UIElementBasedDescriptor&gt; getUIElements() {
<span class="fc" id="L3015">			return attributes;</span>
		}

		@Override
		protected String getDisplayedTypeName(String prefix) {
<span class="fc" id="L3020">			String activatorClassName = prefix + activatorTypeName;</span>
<span class="fc" id="L3021">			return activatorClassName;</span>
		}

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, UIElementBasedDescriptor uiElement,
				String uiCustomizationsVariableName, String displayedTypeName) {
<span class="fc" id="L3027">			AttributeDescriptor attribute = (AttributeDescriptor) uiElement;</span>
<span class="fc" id="L3028">			String activatorClassName = displayedTypeName;</span>
<span class="fc" id="L3029">			attribute.getNature().generateUICustomizationStatements(result, uiCustomizationsVariableName,</span>
<span class="fc" id="L3030">					activatorClassName, attribute.getName(), attribute.getCaption());</span>
<span class="fc" id="L3031">		}</span>

		public void validate() throws ValidationError {
<span class="pc bpc" id="L3034" title="1 of 4 branches missed.">			if ((activatorTypeName == null) || activatorTypeName.isEmpty()) {</span>
<span class="fc" id="L3035">				throw new ValidationError(&quot;Activator class name not provided&quot;);</span>
			}
<span class="fc bfc" id="L3037" title="All 2 branches covered.">			for (AttributeDescriptor attribute : attributes) {</span>
<span class="fc" id="L3038">				attribute.validate();</span>
			}
<span class="fc" id="L3040">		}</span>

		public com.otk.jesb.activation.Experiment test() throws Exception {
<span class="pc bpc" id="L3043" title="1 of 2 branches missed.">			if (PluginBuilder.INSTANCE.isTestingPrepared()) {</span>
<span class="nc" id="L3044">				PluginBuilder.INSTANCE.unprepareTesting();</span>
			}
<span class="fc" id="L3046">			PluginBuilder.INSTANCE.prepareTesting();</span>
<span class="fc" id="L3047">			String fullClassName = PluginBuilder.INSTANCE.getPackageName() + &quot;.&quot; + activatorTypeName;</span>
<span class="fc" id="L3048">			Activator activator = (Activator) MiscUtils.getJESBClass(fullClassName).newInstance();</span>
<span class="fc" id="L3049">			return new com.otk.jesb.activation.Experiment(activator);</span>
		}
	}

<span class="fc" id="L3053">	public static class AttributeDescriptor extends UIElementBasedDescriptor {</span>

<span class="fc" id="L3055">		private AttributeNature nature = new SimpleAttributeNature();</span>

		public AttributeNature getNature() {
<span class="fc" id="L3058">			return nature;</span>
		}

		public void setNature(AttributeNature nature) {
<span class="fc" id="L3062">			this.nature = nature;</span>
<span class="fc" id="L3063">		}</span>

		public Element getActivatorClassElement(String activatorClassName) {
<span class="fc" id="L3066">			return ensureNotReadOnly(nature.getActivatorClassElement(activatorClassName, getName(), getCaption()));</span>
		}

		@Override
		protected String getDisplayedFieldName(UIStructureBasedDescriptor parent, String displayedTypeNamePrefix) {
<span class="fc" id="L3071">			String activatorClassName = parent.getDisplayedTypeName(displayedTypeNamePrefix);</span>
<span class="fc" id="L3072">			return getActivatorClassElement(activatorClassName).getName();</span>
		}

		public void validate() throws ValidationError {
<span class="pc bpc" id="L3076" title="1 of 4 branches missed.">			if ((getName() == null) || getName().isEmpty()) {</span>
<span class="fc" id="L3077">				throw new ValidationError(&quot;Attribute name not provided&quot;);</span>
			}
<span class="fc" id="L3079">			nature.validate();</span>
<span class="fc" id="L3080">		}</span>

	}

<span class="fc" id="L3084">	public abstract static class AttributeNature {</span>

		protected abstract void validate() throws ValidationError;

		protected abstract void generateActivatorValidationStatements(CodeBuilder result, String activatorClassName,
				String attributeName, String attributeCaption);

		protected abstract void generateUICustomizationStatements(CodeBuilder result,
				String uiCustomizationsVariableName, String activatorClassName, String attributeName,
				String attributeCaption);

		protected abstract Element getActivatorClassElement(String activatorClassName, String attributeName,
				String attributeCaption);
	}

<span class="fc" id="L3099">	public static class SimpleAttributeNature extends AttributeNature {</span>

<span class="fc" id="L3101">		private SimpleParameterNature internalParameterNature = new SimpleParameterNature();</span>

		public String getTypeNameOrAlias() {
<span class="fc" id="L3104">			return internalParameterNature.getTypeNameOrAlias();</span>
		}

		public void setTypeNameOrAlias(String typeNameOrAlias) {
<span class="fc" id="L3108">			internalParameterNature.setTypeNameOrAlias(typeNameOrAlias);</span>
<span class="fc" id="L3109">		}</span>

		public List&lt;String&gt; getTypeNameOrAliasOptions() {
<span class="fc" id="L3112">			return internalParameterNature.getTypeNameOrAliasOptions();</span>
		}

		public String getDefaultValueExpression() {
<span class="fc" id="L3116">			return internalParameterNature.getDefaultValueExpression();</span>
		}

		public void setDefaultValueExpression(String defaultValueExpression) {
<span class="fc" id="L3120">			internalParameterNature.setDefaultValueExpression(defaultValueExpression);</span>
<span class="fc" id="L3121">		}</span>

		public boolean isVariant() {
<span class="fc" id="L3124">			return internalParameterNature.isVariant();</span>
		}

		public void setVariant(boolean variant) {
<span class="nc" id="L3128">			internalParameterNature.setVariant(variant);</span>
<span class="nc" id="L3129">		}</span>

		public boolean isNullable() {
<span class="fc" id="L3132">			return internalParameterNature.isNullable();</span>
		}

		public void setNullable(boolean nullable) {
<span class="nc" id="L3136">			internalParameterNature.setNullable(nullable);</span>
<span class="nc" id="L3137">		}</span>

		public String getControlPluginIdentifier() {
<span class="fc" id="L3140">			return internalParameterNature.getControlPluginIdentifier();</span>
		}

		public void setControlPluginIdentifier(String controlPluginIdentifier) {
<span class="fc" id="L3144">			internalParameterNature.setControlPluginIdentifier(controlPluginIdentifier);</span>
<span class="fc" id="L3145">		}</span>

		public Object getControlPluginConfiguration() {
<span class="fc" id="L3148">			return internalParameterNature.getControlPluginConfiguration();</span>
		}

		public void setControlPluginConfiguration(Object controlPluginConfiguration) {
<span class="nc" id="L3152">			internalParameterNature.setControlPluginConfiguration(controlPluginConfiguration);</span>
<span class="nc" id="L3153">		}</span>

		public List&lt;String&gt; getControlPluginIdentifierOptions() {
<span class="fc" id="L3156">			return internalParameterNature.getControlPluginIdentifierOptions();</span>
		}

		@Override
		protected void generateActivatorValidationStatements(CodeBuilder result, String activatorClassName,
				String attributeName, String attributeCaption) {
<span class="fc" id="L3162">			internalParameterNature.generateOperationBuilderValidationStatements(result, activatorClassName,</span>
<span class="fc" id="L3163">					attributeName, attributeCaption);</span>
<span class="fc" id="L3164">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String activatorClassName, String attributeName, String attributeCaption) {
<span class="fc" id="L3169">			internalParameterNature.generateUICustomizationStatements(result, uiCustomizationsVariableName,</span>
<span class="fc" id="L3170">					activatorClassName, null, attributeName, attributeCaption);</span>
<span class="fc" id="L3171">		}</span>

		@Override
		protected Element getActivatorClassElement(String activatorClassName, String attributeName,
				String attributeCaption) {
<span class="fc" id="L3176">			return internalParameterNature.getOperationBuilderClassElement(activatorClassName, attributeName,</span>
<span class="fc" id="L3177">					attributeCaption);</span>
		}

		@Override
		protected void validate() throws ValidationError {
<span class="fc" id="L3182">			internalParameterNature.validate();</span>
<span class="fc" id="L3183">		}</span>

	}

<span class="nc" id="L3187">	public static class EnumerationAttributeNature extends AttributeNature {</span>

<span class="nc" id="L3189">		private EnumerationParameterNature internalParameterNature = new EnumerationParameterNature();</span>

		public EnumerationStructure getStructure() {
<span class="nc" id="L3192">			return internalParameterNature.getStructure();</span>
		}

		public void setStructure(EnumerationStructure structure) {
<span class="nc" id="L3196">			internalParameterNature.setStructure(structure);</span>
<span class="nc" id="L3197">		}</span>

		public String getDefaultValueExpression() {
<span class="nc" id="L3200">			return internalParameterNature.getDefaultValueExpression();</span>
		}

		public void setDefaultValueExpression(String defaultValueExpression) {
<span class="nc" id="L3204">			internalParameterNature.setDefaultValueExpression(defaultValueExpression);</span>
<span class="nc" id="L3205">		}</span>

		public boolean isVariant() {
<span class="nc" id="L3208">			return internalParameterNature.isVariant();</span>
		}

		public void setVariant(boolean variant) {
<span class="nc" id="L3212">			internalParameterNature.setVariant(variant);</span>
<span class="nc" id="L3213">		}</span>

		public boolean isNullable() {
<span class="nc" id="L3216">			return internalParameterNature.isNullable();</span>
		}

		public void setNullable(boolean nullable) {
<span class="nc" id="L3220">			internalParameterNature.setNullable(nullable);</span>
<span class="nc" id="L3221">		}</span>

		public String getControlPluginIdentifier() {
<span class="nc" id="L3224">			return internalParameterNature.getControlPluginIdentifier();</span>
		}

		public void setControlPluginIdentifier(String controlPluginIdentifier) {
<span class="nc" id="L3228">			internalParameterNature.setControlPluginIdentifier(controlPluginIdentifier);</span>
<span class="nc" id="L3229">		}</span>

		public Object getControlPluginConfiguration() {
<span class="nc" id="L3232">			return internalParameterNature.getControlPluginConfiguration();</span>
		}

		public void setControlPluginConfiguration(Object controlPluginConfiguration) {
<span class="nc" id="L3236">			internalParameterNature.setControlPluginConfiguration(controlPluginConfiguration);</span>
<span class="nc" id="L3237">		}</span>

		public List&lt;String&gt; getControlPluginIdentifierOptions() {
<span class="nc" id="L3240">			return internalParameterNature.getControlPluginIdentifierOptions();</span>
		}

		@Override
		protected Element getActivatorClassElement(String activatorClassName, String attributeName,
				String attributeCaption) {
<span class="nc" id="L3246">			return new ElementProxy(internalParameterNature.getOperationBuilderClassElement(activatorClassName,</span>
<span class="nc" id="L3247">					attributeName, attributeCaption)) {</span>
<span class="nc" id="L3248">				Element operationElement = internalParameterNature.getOperationClassElement(activatorClassName,</span>
<span class="nc" id="L3249">						attributeName);</span>

				@Override
				protected String generateRequiredInnerJavaTypesSourceCode(String parentClassName,
						Map&lt;Object, Object&gt; options) {
<span class="nc" id="L3254">					return operationElement.generateRequiredInnerJavaTypesSourceCode(parentClassName, options);</span>
				}

			};
		}

		@Override
		protected void generateActivatorValidationStatements(CodeBuilder result, String activatorClassName,
				String attributeName, String attributeCaption) {
<span class="nc" id="L3263">			internalParameterNature.generateOperationBuilderValidationStatements(result, activatorClassName,</span>
<span class="nc" id="L3264">					attributeName, attributeCaption);</span>
<span class="nc" id="L3265">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String activatorClassName, String attributeName, String attributeCaption) {
<span class="nc" id="L3270">			internalParameterNature.generateUICustomizationStatements(result, uiCustomizationsVariableName,</span>
<span class="nc" id="L3271">					activatorClassName, null, attributeName, attributeCaption);</span>
<span class="nc" id="L3272">		}</span>

		@Override
		protected void validate() throws ValidationError {
<span class="nc" id="L3276">			internalParameterNature.validate();</span>
<span class="nc" id="L3277">		}</span>

	}

<span class="nc" id="L3281">	public static class ReferenceAttributeNature extends AttributeNature {</span>

<span class="nc" id="L3283">		private ReferenceParameterNature internalParameterNature = new ReferenceParameterNature();</span>

		public String getAssetClassName() {
<span class="nc" id="L3286">			return internalParameterNature.getAssetClassName();</span>
		}

		public void setAssetClassName(String assetClassName) {
<span class="nc" id="L3290">			internalParameterNature.setAssetClassName(assetClassName);</span>
<span class="nc" id="L3291">		}</span>

		public List&lt;String&gt; getAssetClassNameOptions() {
<span class="nc" id="L3294">			return internalParameterNature.getAssetClassNameOptions();</span>
		}

		@Override
		protected Element getActivatorClassElement(String activatorClassName, String attributeName,
				String attributeCaption) {
<span class="nc" id="L3300">			return new ElementProxy(internalParameterNature.getOperationBuilderClassElement(activatorClassName,</span>
<span class="nc" id="L3301">					attributeName, attributeCaption)) {</span>
<span class="nc" id="L3302">				Element operationElement = internalParameterNature.getOperationClassElement(activatorClassName,</span>
<span class="nc" id="L3303">						attributeName);</span>

				@Override
				protected String generateRequiredInnerJavaTypesSourceCode(String parentClassName,
						Map&lt;Object, Object&gt; options) {
<span class="nc" id="L3308">					return operationElement.generateRequiredInnerJavaTypesSourceCode(parentClassName, options);</span>
				}

			};
		}

		@Override
		protected void generateActivatorValidationStatements(CodeBuilder result, String activatorClassName,
				String attributeName, String attributeCaption) {
<span class="nc" id="L3317">			internalParameterNature.generateOperationBuilderValidationStatements(result, activatorClassName,</span>
<span class="nc" id="L3318">					attributeName, attributeCaption);</span>
<span class="nc" id="L3319">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String activatorClassName, String attributeName, String attributeCaption) {
<span class="nc" id="L3324">			internalParameterNature.generateUICustomizationStatements(result, uiCustomizationsVariableName,</span>
<span class="nc" id="L3325">					activatorClassName, null, attributeName, attributeCaption);</span>
<span class="nc" id="L3326">		}</span>

		@Override
		protected void validate() throws ValidationError {
<span class="nc" id="L3330">			internalParameterNature.validate();</span>
<span class="nc" id="L3331">		}</span>

	}

<span class="nc" id="L3335">	public static class GroupAttributeNature extends AttributeNature {</span>

<span class="nc" id="L3337">		private boolean nullable = false;</span>

<span class="nc" id="L3339">		private ActivatorDescriptor internalActivator = new ActivatorDescriptor() {</span>

			@Override
			protected void generateTriggerMethodsSourceCode(CodeBuilder additionalMethodDeclarations) {
<span class="nc" id="L3343">			}</span>

			@Override
			protected void generateOutputSourceCode(String activatorClassName, CodeBuilder additionalMethodDeclarations,
					CodeBuilder additionalInnerClassesDeclarations, Map&lt;Object, Object&gt; codeGenerationOptions) {
<span class="nc" id="L3348">			}</span>

			@Override
			protected void generateInputSourceCode(String activatorClassName, CodeBuilder additionalMethodDeclarations,
					CodeBuilder additionalInnerClassesDeclarations, Map&lt;Object, Object&gt; codeGenerationOptions) {
<span class="nc" id="L3353">			}</span>

			@Override
			protected String generateMetadataClassSourceCode(String resourceClassName, Map&lt;Object, Object&gt; options) {
<span class="nc" id="L3357">				return &quot;&quot;;</span>
			}

			@Override
			protected String getActivationHandlerFieldDeclartionSourceCode() {
<span class="nc" id="L3362">				return &quot;&quot;;</span>
			}

			@Override
			protected void generateValidationMethodSourceCode(CodeBuilder result, String activatorClassName) {
<span class="nc" id="L3367">				CodeBuilder tmp = new CodeBuilder();</span>
<span class="nc" id="L3368">				super.generateValidationMethodSourceCode(tmp, activatorClassName);</span>
<span class="nc" id="L3369">				result.append(tmp.toString().replace(&quot;super.validate(recursively, plan);\n&quot;, &quot;&quot;));</span>
<span class="nc" id="L3370">			}</span>

			@Override
			protected String generateJavaSourceCode(String packageName, Map&lt;Object, Object&gt; codeGenerationOptions) {
<span class="nc" id="L3374">				return super.generateJavaSourceCode(packageName, codeGenerationOptions).replace(</span>
<span class="nc" id="L3375">						&quot;extends &quot; + Activator.class.getName(), &quot;implements &quot; + ActivatorStructure.class.getName());</span>
			}

			@Override
			protected PlaceHolder getImportsPlaceHolder(String rootClassName) {
<span class="nc" id="L3380">				return PlaceHolder.NULL_PLACEHOLDER;</span>
			}
		};

		public List&lt;AttributeDescriptor&gt; getAttributes() {
<span class="nc" id="L3385">			return internalActivator.getAttributes();</span>
		}

		public void setAttributes(List&lt;AttributeDescriptor&gt; attributes) {
<span class="nc" id="L3389">			internalActivator.setAttributes(attributes);</span>
<span class="nc" id="L3390">		}</span>

		public boolean isNullable() {
<span class="nc" id="L3393">			return nullable;</span>
		}

		public void setNullable(boolean nullable) {
<span class="nc" id="L3397">			this.nullable = nullable;</span>
<span class="nc" id="L3398">		}</span>

		@Override
		protected void generateActivatorValidationStatements(CodeBuilder result, String activatorClassName,
				String attributeName, String attributeCaption) {
<span class="nc" id="L3403">			String elementName = getActivatorClassElement(activatorClassName, attributeName, attributeCaption)</span>
<span class="nc" id="L3404">					.getName();</span>
<span class="nc" id="L3405">			result.append(&quot;if (recursively) {\n&quot;);</span>
<span class="nc" id="L3406">			result.indenting(() -&gt; {</span>
<span class="nc" id="L3407">				result.append(&quot;try {\n&quot;);</span>
<span class="nc" id="L3408">				result.appendIndented(elementName + &quot;.validate(recursively, plan);\n&quot;);</span>
<span class="nc" id="L3409">				result.append(&quot;} catch (&quot; + ValidationError.class.getName() + &quot; e) {\n&quot;);</span>
<span class="nc" id="L3410">				result.appendIndented(&quot;throw new &quot; + ValidationError.class.getName() + &quot;(\&quot;Failed to validate '&quot;</span>
<span class="nc" id="L3411">						+ attributeCaption + &quot;'\&quot;, e);\n&quot;);</span>
<span class="nc" id="L3412">				result.append(&quot;}\n&quot;);</span>
<span class="nc" id="L3413">			});</span>
<span class="nc" id="L3414">			result.append(&quot;}\n&quot;);</span>
<span class="nc" id="L3415">		}</span>

		@Override
		protected void generateUICustomizationStatements(CodeBuilder result, String uiCustomizationsVariableName,
				String activatorClassName, String attributeName, String attributeCaption) {
<span class="nc" id="L3420">			String uiTypeName = activatorClassName;</span>
<span class="nc" id="L3421">			String uiElementName = getActivatorClassElement(activatorClassName, attributeName, attributeCaption)</span>
<span class="nc" id="L3422">					.getName();</span>
<span class="nc" id="L3423">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="nc" id="L3424">					+ uiTypeName + &quot;.class.getName()&quot; + &quot;, \&quot;&quot; + uiElementName</span>
<span class="nc" id="L3425">					+ &quot;\&quot;)\n.setValueValidityDetectionForced(true);\n&quot;);</span>
<span class="nc bnc" id="L3426" title="All 2 branches missed.">			if (nullable) {</span>
<span class="nc" id="L3427">				result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="nc" id="L3428">						+ uiTypeName + &quot;.class.getName()&quot; + &quot;, \&quot;&quot; + uiElementName</span>
<span class="nc" id="L3429">						+ &quot;\&quot;)\n.setNullValueDistinctForced(true);\n&quot;);</span>
			}
<span class="nc" id="L3431">			result.append(InfoCustomizations.class.getName() + &quot;.getFieldCustomization(infoCustomizations, &quot;</span>
<span class="nc" id="L3432">					+ uiTypeName + &quot;.class.getName(), \&quot;&quot; + uiElementName + &quot;\&quot;)&quot;</span>
<span class="nc" id="L3433">					+ &quot;.setFormControlEmbeddingForced(true);\n&quot;);</span>
<span class="nc" id="L3434">			result.append(getActivatorClassElement(activatorClassName, attributeName, attributeCaption)</span>
<span class="nc" id="L3435">					.getFinalTypeNameAdaptedToSourceCode(activatorClassName) + &quot;.&quot; + GUI.UI_CUSTOMIZATIONS_METHOD_NAME</span>
<span class="nc" id="L3436">					+ &quot;(&quot; + uiCustomizationsVariableName + &quot;)&quot; + &quot;;\n&quot;);</span>
<span class="nc" id="L3437">		}</span>

		@Override
		protected Element getActivatorClassElement(String activatorClassName, String attributeName,
				String attributeCaption) {
<span class="nc" id="L3442">			Structure.StructuredElement result = new Structure.StructuredElement() {</span>
				{
<span class="nc" id="L3444">					setName(attributeName);</span>
<span class="nc" id="L3445">					setStructure(new Structure.ClassicStructure() {</span>
						{
<span class="nc" id="L3447">							String groupStructureTypeName = getTypeName(activatorClassName);</span>
<span class="nc bnc" id="L3448" title="All 2 branches missed.">							for (AttributeDescriptor attribute : getAttributes()) {</span>
<span class="nc" id="L3449">								getElements().add(attribute.getActivatorClassElement(groupStructureTypeName));</span>
							}
						}

						@Override
						public String generateJavaTypeSourceCode(String groupStructureClassName,
								String additionalyImplemented, String additionalyExtended,
								String afterPackageDeclartion, String afterFieldDeclarations,
								String afterMethodDeclarations, Map&lt;Object, Object&gt; options) {
<span class="nc" id="L3458">							internalActivator.setActivatorTypeName(groupStructureClassName);</span>
<span class="nc" id="L3459">							String packageName = MiscUtils.extractPackageNameFromClassName(groupStructureClassName);</span>
<span class="nc" id="L3460">							return internalActivator.generateJavaSourceCode(packageName, options);</span>
						}
					});
<span class="nc" id="L3463">					Structure.Optionality optionality = new Structure.Optionality();</span>
					{
<span class="nc" id="L3465">						optionality.setDefaultValueExpression(</span>
<span class="nc" id="L3466">								&quot;new &quot; + getFinalTypeNameAdaptedToSourceCode(activatorClassName) + &quot;()&quot;);</span>
<span class="nc" id="L3467">						setOptionality(optionality);</span>
					}
				}
			};
<span class="nc" id="L3471">			return result;</span>
		}

		public void validate() throws ValidationError {
<span class="nc bnc" id="L3475" title="All 2 branches missed.">			for (AttributeDescriptor attribute : getAttributes()) {</span>
<span class="nc" id="L3476">				attribute.validate();</span>
			}
<span class="nc" id="L3478">		}</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span>j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</div></body></html>