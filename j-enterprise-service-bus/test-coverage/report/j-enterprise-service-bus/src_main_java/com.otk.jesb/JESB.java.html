<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>JESB.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</a> &gt; <a href="../../index.html" class="el_group">j-enterprise-service-bus</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">com.otk.jesb</a> &gt; <span class="el_source">JESB.java</span></div><h1>JESB.java</h1><pre class="source lang-java linenums">package com.otk.jesb;

import java.io.File;
import java.io.IOException;
import java.io.PrintStream;
import java.util.Arrays;
import java.util.stream.Collectors;

import javax.swing.SwingUtilities;

import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.CommandLineParser;
import org.apache.commons.cli.DefaultParser;
import org.apache.commons.cli.Option;
import org.apache.commons.cli.Options;
import org.apache.commons.cli.ParseException;
import org.apache.commons.cli.help.HelpFormatter;

import com.otk.jesb.solution.Plan;
import com.otk.jesb.solution.Solution;
import com.otk.jesb.ui.GUI;
import com.otk.jesb.ui.Preferences;
import com.otk.jesb.util.DuplicatedInputStreamSource;

/**
 * This is the main class of the application. The {@link #main(String[])} method
 * (run with the '--help' argument to get more details) allows to open the
 * graphical editor or directly launch the execution of a {@link Solution}.
 * 
 * @author olitank
 *
 */
<span class="nc" id="L33">public class JESB {</span>

<span class="fc" id="L35">	public static final String DEBUG_PROPERTY_KEY = JESB.class.getPackage().getName() + &quot;.debug&quot;;</span>

	private static final String RUNNER_SWITCH_ARGUMENT = &quot;run-solution&quot;;
	private static final String ENVIRONMENT_SETTINGS_OPTION_ARGUMENT = &quot;env-settings&quot;;
	private static final String SYSTEM_PROPERTIES_DEFINITION_ARGUMENT = &quot;define&quot;;
	private static final String HELP_OPTION_ARGUMENT = &quot;help&quot;;

<span class="fc" id="L42">	private static PrintStream standardOutput = System.out;</span>
<span class="fc" id="L43">	private static PrintStream standardError = System.err;</span>
<span class="fc" id="L44">	private static DuplicatedInputStreamSource standardInputSource = new DuplicatedInputStreamSource(System.in);</span>
<span class="fc" id="L45">	private static Runner runner;</span>

	public static PrintStream getStandardOutput() {
<span class="fc" id="L48">		return JESB.standardOutput;</span>
	}

	public static void setStandardOutput(PrintStream standardOutput) {
<span class="fc" id="L52">		JESB.standardOutput = standardOutput;</span>
<span class="fc" id="L53">	}</span>

	public static PrintStream getStandardError() {
<span class="nc" id="L56">		return JESB.standardError;</span>
	}

	public static void setStandardError(PrintStream standardError) {
<span class="fc" id="L60">		JESB.standardError = standardError;</span>
<span class="fc" id="L61">	}</span>

	public static DuplicatedInputStreamSource getStandardInputSource() {
<span class="fc" id="L64">		return JESB.standardInputSource;</span>
	}

	public static void setStandardInputSource(DuplicatedInputStreamSource standardInputSource) {
<span class="nc" id="L68">		JESB.standardInputSource = standardInputSource;</span>
<span class="nc" id="L69">	}</span>

	public static boolean isDebugModeActive() {
<span class="fc" id="L72">		return Boolean.valueOf(System.getProperty(DEBUG_PROPERTY_KEY, Boolean.FALSE.toString()));</span>
	}

	private static IllegalArgumentException newIllegalArgumentException(Exception e, String[] args, Options options) {
<span class="nc" id="L76">		return new IllegalArgumentException(&quot;Unexpected arguments: &quot; + Arrays.toString(args) + &quot;\n&quot; + &quot;Expected:&quot;</span>
<span class="nc" id="L77">				+ getCommandLineSyntax(&quot;&quot;, options), e);</span>
	}

	private static String getCommandLineSyntax(String executableName, Options options) {
<span class="nc" id="L81">		HelpFormatter helpFormatter = HelpFormatter.builder().get();</span>
<span class="nc" id="L82">		String syntax = executableName + &quot; --help | [[&lt;DIRECTORY_PATH&gt; | &lt;ARCHIVE_FILE_PATH&gt;] &quot;</span>
<span class="nc" id="L83">				+ helpFormatter.toSyntaxOptions(options) + &quot;]&quot;;</span>
<span class="nc" id="L84">		String optionDescriptions = &quot;\t* DIRECTORY_PATH: The path to a solution directory to load&quot; + &quot;\n&quot;</span>
				+ &quot;\tARCHIVE_FILE_PATH: The path to a solution archive file to load\n&quot;
<span class="nc" id="L86">				+ options.getOptions().stream()</span>
<span class="nc" id="L87">						.map(option -&gt; &quot;\t* &quot;</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">								+ ((option.getArgName() != null) ? option.getArgName() : (&quot;--&quot; + option.getLongOpt()))</span>
<span class="nc" id="L89">								+ &quot;: &quot; + option.getDescription())</span>
<span class="nc" id="L90">						.collect(Collectors.joining(&quot;\n&quot;));</span>
<span class="nc" id="L91">		return syntax + &quot;\n&quot; + optionDescriptions;</span>
	}

	private static void setupSampleSolution() {
<span class="fc" id="L95">		Plan plan = new Plan(&quot;Sample&quot;);</span>
<span class="fc" id="L96">		Solution.INSTANCE.getContents().add(plan);</span>
<span class="fc" id="L97">	}</span>

	public static void main(String[] args) throws Exception {
<span class="fc" id="L100">		Options options = new Options();</span>
<span class="fc" id="L101">		options.addOption(Option.builder().longOpt(RUNNER_SWITCH_ARGUMENT).desc(&quot;Only execute the solution&quot;).get());</span>
<span class="fc" id="L102">		options.addOption(Option.builder().longOpt(ENVIRONMENT_SETTINGS_OPTION_ARGUMENT).hasArg()</span>
<span class="fc" id="L103">				.argName(&quot;ENVIRONMENT_SETTINGS_FILE_PATH&quot;).desc(&quot;Specify the solution environment settings file&quot;)</span>
<span class="fc" id="L104">				.get());</span>
<span class="fc" id="L105">		options.addOption(Option.builder().longOpt(SYSTEM_PROPERTIES_DEFINITION_ARGUMENT).hasArgs().valueSeparator(',')</span>
<span class="fc" id="L106">				.argName(&quot;SYSTEM_PROPERTIES_DEFINITION&quot;)</span>
<span class="fc" id="L107">				.desc(&quot;Define system properties (Example: --&quot; + SYSTEM_PROPERTIES_DEFINITION_ARGUMENT</span>
						+ &quot; propertyName1=propertyValue1,propertyName2=propertyValue2)&quot;)
<span class="fc" id="L109">				.get());</span>
<span class="pc bpc" id="L110" title="3 of 4 branches missed.">		if ((args.length == 1) &amp;&amp; args[0].equals(&quot;--&quot; + HELP_OPTION_ARGUMENT)) {</span>
<span class="nc" id="L111">			System.out.println(&quot;Expected arguments:&quot; + getCommandLineSyntax(&quot;&quot;, options));</span>
<span class="nc" id="L112">			return;</span>
		}
<span class="fc" id="L114">		CommandLine commandLine = null;</span>
		try {
<span class="fc" id="L116">			CommandLineParser CommandLineParser = new DefaultParser();</span>
<span class="fc" id="L117">			commandLine = CommandLineParser.parse(options, args);</span>
<span class="pc" id="L118">		} catch (ParseException e) {</span>
<span class="nc" id="L119">			throw newIllegalArgumentException(e, args, options);</span>
		}
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">		if (commandLine.hasOption(SYSTEM_PROPERTIES_DEFINITION_ARGUMENT)) {</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">			for (String propertyDefinition : commandLine.getOptionValues(SYSTEM_PROPERTIES_DEFINITION_ARGUMENT)) {</span>
<span class="nc" id="L123">				int separatorPosition = propertyDefinition.indexOf(&quot;=&quot;);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">				if (separatorPosition == -1) {</span>
<span class="nc" id="L125">					throw new IllegalArgumentException(&quot;Invalid system property definition string: '&quot;</span>
<span class="nc" id="L126">							+ propertyDefinition + &quot;': 'key=value' format expected&quot;);</span>
				}
<span class="nc" id="L128">				String propertyName = propertyDefinition.substring(0, separatorPosition);</span>
<span class="nc" id="L129">				String propertyValue = propertyDefinition.substring(separatorPosition + 1);</span>
<span class="nc" id="L130">				System.setProperty(propertyName, propertyValue);</span>
			}
		}
<span class="fc" id="L133">		String[] remainingArgs = commandLine.getArgs();</span>
		File fileOrFolder;
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">		if (remainingArgs.length == 1) {</span>
<span class="nc" id="L136">			fileOrFolder = new File(remainingArgs[0]);</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">		} else if (remainingArgs.length == 0) {</span>
<span class="fc" id="L138">			fileOrFolder = null;</span>
<span class="fc" id="L139">		} else {</span>
<span class="nc" id="L140">			throw newIllegalArgumentException(null, args, options);</span>
		}
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">		if (commandLine.hasOption(RUNNER_SWITCH_ARGUMENT)) {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">			if (fileOrFolder == null) {</span>
<span class="nc" id="L144">				throw newIllegalArgumentException(new Exception(&quot;Missing &lt;DIRECTORY_PATH&gt; or &lt;ARCHIVE_FILE_PATH&gt;&quot;),</span>
<span class="nc" id="L145">						args, options);</span>
			}
<span class="nc" id="L147">			LogFile runnerlogFile = new LogFile(new File(fileOrFolder.getName() + &quot;.log&quot;));</span>
<span class="nc" id="L148">			Log.set(runnerlogFile);</span>
<span class="nc" id="L149">			Log.setVerbosityStatusSupplier(() -&gt; Boolean.valueOf(System</span>
<span class="nc" id="L150">					.getProperty(JESB.class.getPackage().getName() + &quot;.runnerLogVerbose&quot;, Boolean.FALSE.toString())));</span>
<span class="nc" id="L151">			System.setOut(runnerlogFile.getPrintStream(System.out, LogFile.VERBOSE_LEVEL_NAME,</span>
<span class="nc" id="L152">					Log.getVerbosityStatusSupplier()));</span>
<span class="nc" id="L153">			System.setErr(runnerlogFile.getPrintStream(System.err, LogFile.VERBOSE_LEVEL_NAME,</span>
<span class="nc" id="L154">					Log.getVerbosityStatusSupplier()));</span>
<span class="nc" id="L155">		} else {</span>
<span class="fc" id="L156">			Log.set(Console.DEFAULT);</span>
<span class="fc" id="L157">			Log.setVerbosityStatusSupplier(() -&gt; Preferences.INSTANCE.isLogVerbose());</span>
<span class="fc" id="L158">			setStandardOutput(Console.DEFAULT.getPrintStream(System.out, () -&gt; true));</span>
<span class="pc" id="L159">			setStandardError(Console.DEFAULT.getPrintStream(System.err, () -&gt; true));</span>
<span class="fc" id="L160">			System.setOut(Console.DEFAULT.getPrintStream(System.out, LogFile.VERBOSE_LEVEL_NAME, &quot;#009999&quot;, &quot;#00FFFF&quot;,</span>
<span class="fc" id="L161">					Log.getVerbosityStatusSupplier()));</span>
<span class="fc" id="L162">			System.setErr(Console.DEFAULT.getPrintStream(System.err, LogFile.VERBOSE_LEVEL_NAME, &quot;#009999&quot;, &quot;#00FFFF&quot;,</span>
<span class="fc" id="L163">					Log.getVerbosityStatusSupplier()));</span>
<span class="fc" id="L164">			Console.DEFAULT.setPendingInputLineConsumer(line -&gt; {</span>
<span class="nc" id="L165">				JESB.getStandardInputSource().pushLine(line);</span>
<span class="nc" id="L166">				JESB.getStandardOutput().println(line);</span>
<span class="nc" id="L167">			});</span>
		}
<span class="fc" id="L169">		Log.get().information(&quot;Starting up...&quot;);</span>
<span class="fc" id="L170">		Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; {</span>
<span class="fc" id="L171">			Log.get().information(&quot;Shutting down...&quot;);</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">			if (runner != null) {</span>
				try {
<span class="nc" id="L174">					runner.close();</span>
<span class="nc" id="L175">				} catch (Exception e) {</span>
<span class="nc" id="L176">					Log.get().error(e);</span>
				}
			}
<span class="fc" id="L179">		}));</span>
<span class="fc" id="L180">		Thread.setDefaultUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() {</span>
			@Override
			public void uncaughtException(Thread t, Throwable e) {
<span class="nc" id="L183">				Log.get().error(e);</span>
<span class="nc" id="L184">			}</span>
		});
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">		if (fileOrFolder != null) {</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">			if (fileOrFolder.isDirectory()) {</span>
<span class="nc" id="L188">				Solution.INSTANCE.loadFromDirectory(fileOrFolder);</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">			} else if (fileOrFolder.isFile()) {</span>
<span class="nc" id="L190">				Solution.INSTANCE.loadFromArchiveFile(fileOrFolder);</span>
<span class="nc" id="L191">			} else {</span>
<span class="nc" id="L192">				throw newIllegalArgumentException(</span>
<span class="nc" id="L193">						new IOException(&quot;Invalid solution directory or archive file: '&quot; + fileOrFolder + &quot;'&quot;), args,</span>
<span class="nc" id="L194">						options);</span>
			}
		} else {
<span class="fc" id="L197">			setupSampleSolution();</span>
		}
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">		if (commandLine.hasOption(RUNNER_SWITCH_ARGUMENT)) {</span>
<span class="nc" id="L200">			runner = new Runner(Solution.INSTANCE, false);</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">			if (commandLine.hasOption(ENVIRONMENT_SETTINGS_OPTION_ARGUMENT)) {</span>
<span class="nc" id="L202">				Solution.INSTANCE.getEnvironmentSettings()</span>
<span class="nc" id="L203">						.importProperties(new File(commandLine.getOptionValue(ENVIRONMENT_SETTINGS_OPTION_ARGUMENT)));</span>
			}
<span class="nc" id="L205">			runner.open();</span>
<span class="nc" id="L206">		} else {</span>
<span class="fc" id="L207">			SwingUtilities.invokeLater(new Runnable() {</span>
				@Override
				public void run() {
<span class="fc" id="L210">					GUI.INSTANCE.openObjectFrame(Solution.INSTANCE);</span>
<span class="fc" id="L211">				}</span>
			});
		}
<span class="fc" id="L214">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span>j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</div></body></html>