<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>CompiledFunction.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</a> &gt; <a href="../../index.html" class="el_group">j-enterprise-service-bus</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">com.otk.jesb.compiler</a> &gt; <span class="el_source">CompiledFunction.java</span></div><h1>CompiledFunction.java</h1><pre class="source lang-java linenums">package com.otk.jesb.compiler;

import java.lang.reflect.InvocationTargetException;
import java.lang.reflect.Parameter;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import com.otk.jesb.StandardError;
import com.otk.jesb.UnexpectedError;
import com.otk.jesb.Variable;
import com.otk.jesb.VariableDeclaration;
import com.otk.jesb.util.MiscUtils;

public class CompiledFunction&lt;T&gt; {

	private Class&lt;?&gt; functionClass;
	private String functionClassSource;

<span class="fc" id="L20">	private CompiledFunction(Class&lt;?&gt; functionClass, String functionClassSource) {</span>
<span class="fc" id="L21">		this.functionClass = functionClass;</span>
<span class="fc" id="L22">		this.functionClassSource = functionClassSource;</span>
<span class="fc" id="L23">	}</span>

	public Class&lt;?&gt; getFunctionClass() {
<span class="fc" id="L26">		return functionClass;</span>
	}

	public String getFunctionClassSource() {
<span class="fc" id="L30">		return functionClassSource;</span>
	}

	public static &lt;T&gt; CompiledFunction&lt;T&gt; get(String functionBody, List&lt;VariableDeclaration&gt; variableDeclarations,
			Class&lt;T&gt; returnType) throws CompilationError {
<span class="fc" id="L35">		String functionClassName = CompiledFunction.class.getPackage().getName() + &quot;.&quot;</span>
<span class="fc" id="L36">				+ CompiledFunction.class.getSimpleName() + MiscUtils.getDigitalUniqueIdentifier();</span>
<span class="fc" id="L37">		String preBody = &quot;&quot;;</span>
<span class="fc" id="L38">		preBody += &quot;package &quot; + MiscUtils.extractPackageNameFromClassName(functionClassName) + &quot;;&quot; + &quot;\n&quot;;</span>
<span class="fc" id="L39">		preBody += &quot;public class &quot; + MiscUtils.extractSimpleNameFromClassName(functionClassName) + &quot;{&quot; + &quot;\n&quot;;</span>
<span class="fc" id="L40">		preBody += &quot;public static &quot; + MiscUtils.adaptClassNameToSourceCode(returnType.getName()) + &quot; execute(&quot;;</span>
<span class="fc" id="L41">		List&lt;String&gt; declrartionStrings = new ArrayList&lt;String&gt;();</span>
<span class="fc bfc" id="L42" title="All 2 branches covered.">		for (VariableDeclaration declaration : variableDeclarations) {</span>
<span class="fc" id="L43">			declrartionStrings.add(MiscUtils.adaptClassNameToSourceCode(declaration.getVariableType().getName()) + &quot; &quot;</span>
<span class="fc" id="L44">					+ declaration.getVariableName());</span>
		}
<span class="fc bfc" id="L46" title="All 2 branches covered.">		if (declrartionStrings.size() &gt; 0) {</span>
<span class="fc" id="L47">			preBody += &quot;\n    &quot; + MiscUtils.stringJoin(declrartionStrings, &quot;,\n    &quot;) + &quot;\n&quot;;</span>
		}
<span class="fc" id="L49">		preBody += &quot;) throws &quot; + Throwable.class.getName() + &quot;{&quot; + &quot;\n&quot;;</span>
<span class="fc" id="L50">		String postBody = &quot;\n&quot;;</span>
<span class="fc" id="L51">		postBody += &quot;}&quot; + &quot;\n&quot;;</span>
<span class="fc" id="L52">		postBody += &quot;}&quot;;</span>
<span class="fc" id="L53">		String functionClassSource = preBody + functionBody + postBody;</span>
		Class&lt;?&gt; functionClass;
		try {
<span class="fc" id="L56">			functionClass = MiscUtils.IN_MEMORY_COMPILER.compile(functionClassName, functionClassSource);</span>
<span class="pc" id="L57">		} catch (CompilationError e) {</span>
<span class="nc" id="L58">			int startPosition = e.getStartPosition() - preBody.length();</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">			if (startPosition &lt; 0) {</span>
<span class="nc" id="L60">				startPosition = 0;</span>
			}
<span class="nc bnc" id="L62" title="All 2 branches missed.">			if (startPosition &gt;= functionBody.length()) {</span>
<span class="nc" id="L63">				startPosition = 0;</span>
			}
<span class="nc" id="L65">			int endPosition = e.getEndPosition() - preBody.length();</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">			if (endPosition &lt; 0) {</span>
<span class="nc" id="L67">				endPosition = functionBody.length() - 1;</span>
			}
<span class="nc bnc" id="L69" title="All 2 branches missed.">			if (endPosition &gt;= functionBody.length()) {</span>
<span class="nc" id="L70">				endPosition = functionBody.length() - 1;</span>
			}
<span class="nc" id="L72">			throw new CompilationError(startPosition, endPosition, e.getMessage(), null, functionBody, e);</span>
		}
<span class="fc" id="L74">		return new CompiledFunction&lt;T&gt;(functionClass, functionClassSource);</span>
	}

	@SuppressWarnings(&quot;unchecked&quot;)
	public T call(Variable... variables) throws FunctionCallError {
<span class="fc" id="L79">		return (T)call(Arrays.asList(variables));</span>
	}

	public Object call(List&lt;Variable&gt; variables) throws FunctionCallError {
<span class="fc" id="L83">		Object[] functionParameterValues = new Object[functionClass.getMethods()[0].getParameterCount()];</span>
<span class="fc" id="L84">		int i = 0;</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">		for (Parameter param : functionClass.getMethods()[0].getParameters()) {</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">			for (Variable variable : MiscUtils.getReverse(variables)) {</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">				if (param.getName().equals(variable.getName())) {</span>
<span class="fc" id="L88">					functionParameterValues[i] = variable.getValue();</span>
<span class="fc" id="L89">					break;</span>
				}
			}
<span class="fc" id="L92">			i++;</span>
		}
		try {
<span class="fc" id="L95">			return functionClass.getMethods()[0].invoke(null, functionParameterValues);</span>
<span class="nc" id="L96">		} catch (IllegalAccessException e) {</span>
<span class="nc" id="L97">			throw new UnexpectedError(e);</span>
<span class="nc" id="L98">		} catch (IllegalArgumentException e) {</span>
<span class="nc" id="L99">			throw new UnexpectedError(e);</span>
<span class="nc" id="L100">		} catch (SecurityException e) {</span>
<span class="nc" id="L101">			throw new UnexpectedError(e);</span>
<span class="nc" id="L102">		} catch (Throwable t) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">			if (t instanceof InvocationTargetException) {</span>
<span class="nc" id="L104">				t = ((InvocationTargetException) t).getTargetException();</span>
			}
<span class="nc" id="L106">			throw new FunctionCallError(this, t);</span>
		}
	}

	public static class FunctionCallError extends StandardError {

		private static final long serialVersionUID = 1L;

		private CompiledFunction&lt;?&gt; compiledFunction;

		public FunctionCallError(CompiledFunction&lt;?&gt; compiledFunction, Throwable cause) {
<span class="nc" id="L117">			super(cause);</span>
<span class="nc" id="L118">			this.compiledFunction = compiledFunction;</span>
<span class="nc" id="L119">		}</span>

		@Override
		public String getMessage() {
<span class="nc" id="L123">			return getCause().toString() + &quot;\n&quot; + describeSource();</span>
		}

		public String describeSource() {
			String result;
<span class="nc" id="L128">			Throwable t = getCause();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">			if ((t.getStackTrace().length &gt; 0)</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">					&amp;&amp; t.getStackTrace()[0].getClassName().equals(compiledFunction.getFunctionClass().getName())</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">					&amp;&amp; (t.getStackTrace()[0].getLineNumber() &gt; 0)) {</span>
<span class="nc" id="L132">				result = &quot;/* The instruction that raised the exception */\n&quot; + compiledFunction.getFunctionClassSource()</span>
<span class="nc" id="L133">						.split(&quot;\n&quot;)[t.getStackTrace()[0].getLineNumber() - 1];</span>
<span class="nc" id="L134">			} else {</span>
<span class="nc" id="L135">				result = &quot;/* The source code of the function that crashed (&quot;</span>
<span class="nc" id="L136">						+ compiledFunction.getFunctionClass().getSimpleName() + &quot;.java) */\n&quot;</span>
<span class="nc" id="L137">						+ compiledFunction.getFunctionClassSource();</span>
			}
<span class="nc" id="L139">			return result;</span>
		}

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span>j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</div></body></html>