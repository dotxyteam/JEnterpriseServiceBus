<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>JConnection.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</a> &gt; <a href="../../index.html" class="el_group">j-enterprise-service-bus</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">com.otk.jesb.ui.diagram</a> &gt; <span class="el_source">JConnection.java</span></div><h1>JConnection.java</h1><pre class="source lang-java linenums">package com.otk.jesb.ui.diagram;

import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.Point;
import java.awt.Polygon;
import java.awt.Rectangle;
import java.awt.Shape;
import java.awt.geom.AffineTransform;
import java.awt.geom.Point2D;
import java.awt.geom.Rectangle2D;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import com.otk.jesb.util.MiscUtils;
import com.otk.jesb.util.Pair;

<span class="fc" id="L19">public class JConnection extends JDiagramObject {</span>

	private JNode startNode;
	private JNode endNode;
<span class="fc" id="L23">	private boolean selected = false;</span>

	public JNode getStartNode() {
<span class="nc" id="L26">		return startNode;</span>
	}

	public void setStartNode(JNode startNode) {
<span class="fc" id="L30">		this.startNode = startNode;</span>
<span class="fc" id="L31">	}</span>

	public JNode getEndNode() {
<span class="nc" id="L34">		return endNode;</span>
	}

	public void setEndNode(JNode endNode) {
<span class="fc" id="L38">		this.endNode = endNode;</span>
<span class="fc" id="L39">	}</span>

	public boolean isSelected() {
<span class="fc" id="L42">		return selected;</span>
	}

	public void setSelected(boolean selected) {
<span class="fc" id="L46">		this.selected = selected;</span>
<span class="fc" id="L47">	}</span>

	@Override
	public void paint(Graphics g, JDiagram diagram) {
<span class="fc" id="L51">		MiscUtils.improveRenderingQuality((Graphics2D) g);</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">		g.setColor(selected ? diagram.getSelectionColor() : diagram.getConnectionColor());</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">		for (Polygon polygon : computePolygons(diagram.getConnectionLineThickness(),</span>
<span class="fc" id="L54">				diagram.getConnectionArrowSize())) {</span>
<span class="fc" id="L55">			g.fillPolygon(polygon);</span>
		}
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">		if (value != null) {</span>
<span class="fc" id="L58">			g.setColor(diagram.getTextColor());</span>
<span class="fc" id="L59">			Rectangle labelBounds = getLabelBounds(g);</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">			if (labelBounds != null) {</span>
<span class="fc" id="L61">				double rotationAngle = getLabelRotationAngleRadians();</span>
<span class="fc" id="L62">				Point2D rotationCenter = getLabelRotationCenter();</span>
<span class="fc" id="L63">				Graphics2D g2D = (Graphics2D) g.create();</span>
<span class="fc" id="L64">				g2D.rotate(rotationAngle, rotationCenter.getX(), rotationCenter.getY());</span>
<span class="fc" id="L65">				g2D.drawString(value.toString(), labelBounds.x, labelBounds.y + labelBounds.height);</span>
<span class="fc" id="L66">				g2D.dispose();</span>
			}
		}
<span class="fc" id="L69">	}</span>

	public Rectangle getLabelBounds(Graphics g) {
<span class="pc bpc" id="L72" title="1 of 4 branches missed.">		if ((value == null) || (value.toString().length() == 0)) {</span>
<span class="fc" id="L73">			return null;</span>
		}
<span class="fc" id="L75">		Rectangle2D stringBounds = g.getFontMetrics().getStringBounds(value.toString(), g);</span>
<span class="fc" id="L76">		Point2D center = getCenter();</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">		if (center == null) {</span>
<span class="nc" id="L78">			return null;</span>
		}
<span class="fc" id="L80">		return new Rectangle((int) Math.round(center.getX() - (stringBounds.getWidth() / 2)),</span>
<span class="fc" id="L81">				(int) Math.round(center.getY() - stringBounds.getHeight() * 1.3),</span>
<span class="fc" id="L82">				(int) Math.round(stringBounds.getWidth()), (int) Math.round(stringBounds.getHeight()));</span>
	}

	public Point2D getLabelRotationCenter() {
<span class="fc" id="L86">		return getCenter();</span>
	}

	public double getLabelRotationAngleRadians() {
<span class="fc" id="L90">		Pair&lt;Point, Point&gt; lineSegment = getLineSegment();</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">		if (lineSegment == null) {</span>
<span class="nc" id="L92">			return 0.0;</span>
		}
<span class="fc" id="L94">		double result = Math.atan2(lineSegment.getSecond().y - lineSegment.getFirst().y,</span>
<span class="fc" id="L95">				lineSegment.getSecond().x - lineSegment.getFirst().x);</span>
<span class="fc" id="L96">		double resultBetweenMinusPiAndPi = Math.atan2(Math.sin(result), Math.cos(result));</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">		boolean upsideDown = Math.abs(resultBetweenMinusPiAndPi) &gt; (Math.PI / 2);</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">		if (upsideDown) {</span>
<span class="nc" id="L99">			result += Math.PI;</span>
		}
<span class="fc" id="L101">		return result;</span>
	}

	public Point getCenter() {
<span class="fc" id="L105">		Pair&lt;Point, Point&gt; lineSegment = getLineSegment();</span>
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">		if (lineSegment == null) {</span>
<span class="nc" id="L107">			return null;</span>
		}
<span class="fc" id="L109">		int centerX = Math.round((lineSegment.getFirst().x + lineSegment.getSecond().x) / 2f);</span>
<span class="fc" id="L110">		int centerY = Math.round((lineSegment.getFirst().y + lineSegment.getSecond().y) / 2f);</span>
<span class="fc" id="L111">		return new Point(centerX, centerY);</span>
	}

	@Override
	public boolean containsPoint(int x, int y, JDiagram diagram) {
<span class="nc" id="L116">		Graphics g = diagram.getGraphics();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">		if (g != null) {</span>
<span class="nc" id="L118">			Rectangle labelBounds = getLabelBounds(g);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">			if (labelBounds != null) {</span>
<span class="nc" id="L120">				double rotationAngle = getLabelRotationAngleRadians();</span>
<span class="nc" id="L121">				Point2D rotationCenter = getLabelRotationCenter();</span>
<span class="nc" id="L122">				AffineTransform rotation = AffineTransform.getRotateInstance(rotationAngle, rotationCenter.getX(),</span>
<span class="nc" id="L123">						rotationCenter.getY());</span>
<span class="nc" id="L124">				Shape rotatedLabelBounds = rotation.createTransformedShape(labelBounds);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">				if (rotatedLabelBounds.contains(x, y)) {</span>
<span class="nc" id="L126">					return true;</span>
				}
			}
		}
<span class="nc bnc" id="L130" title="All 2 branches missed.">		for (Polygon polygon : computePolygons(diagram.getConnectionLineThickness() + 2,</span>
<span class="nc" id="L131">				diagram.getConnectionArrowSize() + 2)) {</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">			if (polygon.contains(x, y)) {</span>
<span class="nc" id="L133">				return true;</span>
			}
		}
<span class="nc" id="L136">		return false;</span>
	}

	@Override
	public Rectangle getBounds(JDiagram diagram) {
<span class="nc" id="L141">		Point center = getCenter();</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">		if (center == null) {</span>
<span class="nc" id="L143">			center = new Point((startNode.getCenterX() + endNode.getCenterX()) / 2,</span>
<span class="nc" id="L144">					(startNode.getCenterY() + endNode.getCenterY()) / 2);</span>
		}
<span class="nc" id="L146">		Rectangle result = new Rectangle(center.x - 1, center.y - 1, 2, 2);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">		for (Polygon polygon : computePolygons(diagram.getConnectionLineThickness(),</span>
<span class="nc" id="L148">				diagram.getConnectionArrowSize())) {</span>
<span class="nc" id="L149">			result.add(polygon.getBounds());</span>
		}
<span class="nc" id="L151">		return result;</span>
	}

	public List&lt;Polygon&gt; computePolygons(int lineThickness, int arrowSize) {
<span class="fc" id="L155">		List&lt;Polygon&gt; result = new ArrayList&lt;Polygon&gt;();</span>
<span class="fc" id="L156">		Pair&lt;Point, Point&gt; lineSegment = getLineSegment();</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">		if (lineSegment == null) {</span>
<span class="nc" id="L158">			return Collections.emptyList();</span>
		}
<span class="fc" id="L160">		Point startPoint = lineSegment.getFirst();</span>
<span class="fc" id="L161">		Point endPoint = lineSegment.getSecond();</span>
<span class="fc" id="L162">		Polygon linePolygon = lineToPolygon(startPoint, endPoint, lineThickness);</span>
<span class="fc" id="L163">		result.add(linePolygon);</span>
		{
<span class="fc" id="L165">			int firstTrianglePointX = endPoint.x;</span>
<span class="fc" id="L166">			int firstTrianglePointY = endPoint.y;</span>
<span class="fc" id="L167">			double lineAngle = Math.atan2(startPoint.y - endPoint.y, startPoint.x - endPoint.x);</span>
<span class="fc" id="L168">			double triangleHeadAngle = Math.PI / 4;</span>
<span class="fc" id="L169">			double secondTrianglePointAngle = lineAngle - triangleHeadAngle / 2;</span>
<span class="fc" id="L170">			int secondTrianglePointX = (int) Math</span>
<span class="fc" id="L171">					.round(firstTrianglePointX + Math.cos(secondTrianglePointAngle) * arrowSize);</span>
<span class="fc" id="L172">			int secondTrianglePointY = (int) Math</span>
<span class="fc" id="L173">					.round(firstTrianglePointY + Math.sin(secondTrianglePointAngle) * arrowSize);</span>
<span class="fc" id="L174">			double thirdTrianglePointAngle = lineAngle + triangleHeadAngle / 2;</span>
<span class="fc" id="L175">			int thirdTrianglePointX = (int) Math</span>
<span class="fc" id="L176">					.round(firstTrianglePointX + Math.cos(thirdTrianglePointAngle) * arrowSize);</span>
<span class="fc" id="L177">			int thirdTrianglePointY = (int) Math</span>
<span class="fc" id="L178">					.round(firstTrianglePointY + Math.sin(thirdTrianglePointAngle) * arrowSize);</span>
<span class="fc" id="L179">			Polygon arrowPolygon = new Polygon();</span>
<span class="fc" id="L180">			arrowPolygon.addPoint(firstTrianglePointX, firstTrianglePointY);</span>
<span class="fc" id="L181">			arrowPolygon.addPoint(secondTrianglePointX, secondTrianglePointY);</span>
<span class="fc" id="L182">			arrowPolygon.addPoint(thirdTrianglePointX, thirdTrianglePointY);</span>
<span class="fc" id="L183">			result.add(arrowPolygon);</span>
		}
<span class="fc" id="L185">		return result;</span>
	}

	public Pair&lt;Point, Point&gt; getLineSegment() {
<span class="fc" id="L189">		Point startPoint = new Point(startNode.getCenterX(), startNode.getCenterY());</span>
<span class="fc" id="L190">		Point endPoint = new Point(endNode.getCenterX(), endNode.getCenterY());</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">		if (startNode.getImage() != null) {</span>
<span class="fc" id="L192">			startPoint = MiscUtils.getRectangleBorderContactOfLineToExternalPoint(startPoint.x, startPoint.y,</span>
<span class="fc" id="L193">					startNode.getImage().getWidth(null), startNode.getImage().getHeight(null), endPoint.x, endPoint.y);</span>
		}
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">		if (startPoint == null) {</span>
<span class="nc" id="L196">			return null;</span>
		}
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">		if (endNode.getImage() != null) {</span>
<span class="fc" id="L199">			endPoint = MiscUtils.getRectangleBorderContactOfLineToExternalPoint(endPoint.x, endPoint.y,</span>
<span class="fc" id="L200">					endNode.getImage().getWidth(null), endNode.getImage().getHeight(null), startPoint.x, startPoint.y);</span>
		}
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">		if (endPoint == null) {</span>
<span class="nc" id="L203">			return null;</span>
		}
<span class="fc" id="L205">		return new Pair&lt;Point, Point&gt;(startPoint, endPoint);</span>
	}

	private static Polygon lineToPolygon(Point p1, Point p2, double thickness) {
		// Direction vector
<span class="fc" id="L210">		double dx = p2.x - p1.x;</span>
<span class="fc" id="L211">		double dy = p2.y - p1.y;</span>

		// Normalize perpendicular vector
<span class="fc" id="L214">		double length = Math.hypot(dx, dy);</span>
<span class="fc" id="L215">		double ux = -dy / length;</span>
<span class="fc" id="L216">		double uy = dx / length;</span>

		// Half thickness offset
<span class="fc" id="L219">		double offsetX = (ux * thickness) / 2.0;</span>
<span class="fc" id="L220">		double offsetY = (uy * thickness) / 2.0;</span>

		// 4 points of the polygon
<span class="fc" id="L223">		int[] xPoints = { (int) Math.round(p1.x + offsetX), (int) Math.round(p2.x + offsetX),</span>
<span class="fc" id="L224">				(int) Math.round(p2.x - offsetX), (int) Math.round(p1.x - offsetX) };</span>

<span class="fc" id="L226">		int[] yPoints = { (int) Math.round(p1.y + offsetY), (int) Math.round(p2.y + offsetY),</span>
<span class="fc" id="L227">				(int) Math.round(p2.y - offsetY), (int) Math.round(p1.y - offsetY) };</span>

<span class="fc" id="L229">		return new Polygon(xPoints, yPoints, 4);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span>j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</div></body></html>