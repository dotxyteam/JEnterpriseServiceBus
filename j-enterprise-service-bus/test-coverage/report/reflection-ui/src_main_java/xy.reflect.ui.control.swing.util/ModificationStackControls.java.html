<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>ModificationStackControls.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</a> &gt; <a href="../../index.html" class="el_group">reflection-ui</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">xy.reflect.ui.control.swing.util</a> &gt; <span class="el_source">ModificationStackControls.java</span></div><h1>ModificationStackControls.java</h1><pre class="source lang-java linenums">
package xy.reflect.ui.control.swing.util;

import java.awt.Color;
import java.awt.Component;
import java.awt.Font;
import java.awt.Image;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.ArrayList;
import java.util.List;

import javax.swing.JButton;
import javax.swing.SwingUtilities;

import xy.reflect.ui.ReflectionUI;
import xy.reflect.ui.control.swing.renderer.Form;
import xy.reflect.ui.control.swing.renderer.SwingRenderer;
import xy.reflect.ui.info.type.ITypeInfo;
import xy.reflect.ui.undo.AbstractSimpleModificationListener;
import xy.reflect.ui.undo.IModification;
import xy.reflect.ui.undo.IModificationListener;
import xy.reflect.ui.undo.ModificationStack;
import xy.reflect.ui.util.Accessor;
import xy.reflect.ui.util.ReflectionUIUtils;

/**
 * Helper class that creates the buttons allowing to use the modification stack
 * associated with the given form.
 * 
 * @author olitank
 *
 */
public class ModificationStackControls {

	protected ModificationStack modificationStack;
	protected Form form;

	public ModificationStackControls(Form form) {
<span class="fc" id="L40">		super();</span>
<span class="fc" id="L41">		this.form = form;</span>
<span class="fc" id="L42">		this.modificationStack = form.getModificationStack();</span>
<span class="fc" id="L43">	}</span>

	protected JButton createButton(final SwingRenderer swingRenderer, final String label, final Runnable action,
			final Accessor&lt;Boolean&gt; enabled, final Accessor&lt;String&gt; tooltipText) {
<span class="fc" id="L47">		final ReflectionUI reflectionUI = swingRenderer.getReflectionUI();</span>
<span class="fc" id="L48">		final Object object = form.getObject();</span>
<span class="fc" id="L49">		final ITypeInfo type = reflectionUI.getTypeInfo(reflectionUI.getTypeInfoSource(object));</span>
<span class="fc" id="L50">		final JButton result = new AbstractControlButton() {</span>

			protected static final long serialVersionUID = 1L;
<span class="fc" id="L53">			IModificationListener listener = new AbstractSimpleModificationListener() {</span>
				@Override
				protected void handleAnyEvent(IModification modification) {
<span class="fc" id="L56">					SwingUtilities.invokeLater(new Runnable() {</span>
						@Override
						public void run() {
<span class="fc" id="L59">							updateState();</span>
<span class="fc" id="L60">						}</span>
					});
<span class="fc" id="L62">				}</span>
			};
			{
<span class="fc" id="L65">				updateState();</span>
<span class="fc" id="L66">				modificationStack.addListener(listener);</span>
			}

			@Override
			public Image retrieveBackgroundImage() {
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">				if (type.getFormButtonBackgroundImagePath() != null) {</span>
<span class="nc" id="L72">					return SwingRendererUtils.loadImageThroughCache(type.getFormButtonBackgroundImagePath(),</span>
<span class="nc" id="L73">							ReflectionUIUtils.getErrorLogListener(reflectionUI), swingRenderer);</span>
				}
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">				if (reflectionUI.getApplicationInfo().getMainButtonBackgroundImagePath() != null) {</span>
<span class="nc" id="L76">					return SwingRendererUtils.loadImageThroughCache(</span>
<span class="nc" id="L77">							reflectionUI.getApplicationInfo().getMainButtonBackgroundImagePath(),</span>
<span class="nc" id="L78">							ReflectionUIUtils.getErrorLogListener(reflectionUI), swingRenderer);</span>
				}
<span class="fc" id="L80">				return null;</span>
			}

			@Override
			public Font retrieveCustomFont() {
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">				if (reflectionUI.getApplicationInfo().getButtonCustomFontResourcePath() != null) {</span>
<span class="nc" id="L86">					return SwingRendererUtils.loadFontThroughCache(</span>
<span class="nc" id="L87">							reflectionUI.getApplicationInfo().getButtonCustomFontResourcePath(),</span>
<span class="nc" id="L88">							ReflectionUIUtils.getErrorLogListener(reflectionUI), swingRenderer);</span>
				}
<span class="fc" id="L90">				return null;</span>
			}

			@Override
			public Color retrieveBackgroundColor() {
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">				if (type.getFormButtonBackgroundColor() != null) {</span>
<span class="nc" id="L96">					return SwingRendererUtils.getColor(type.getFormButtonBackgroundColor());</span>
				}
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">				if (reflectionUI.getApplicationInfo().getMainButtonBackgroundColor() != null) {</span>
<span class="nc" id="L99">					return SwingRendererUtils</span>
<span class="nc" id="L100">							.getColor(reflectionUI.getApplicationInfo().getMainButtonBackgroundColor());</span>
				}
<span class="fc" id="L102">				return null;</span>
			}

			@Override
			public Color retrieveForegroundColor() {
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">				if (type.getFormButtonForegroundColor() != null) {</span>
<span class="nc" id="L108">					return SwingRendererUtils.getColor(type.getFormButtonForegroundColor());</span>
				}
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">				if (reflectionUI.getApplicationInfo().getMainButtonForegroundColor() != null) {</span>
<span class="nc" id="L111">					return SwingRendererUtils</span>
<span class="nc" id="L112">							.getColor(reflectionUI.getApplicationInfo().getMainButtonForegroundColor());</span>
				}
<span class="fc" id="L114">				return null;</span>
			}

			@Override
			public Color retrieveBorderColor() {
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">				if (type.getFormButtonBorderColor() != null) {</span>
<span class="nc" id="L120">					return SwingRendererUtils.getColor(type.getFormButtonBorderColor());</span>
				}
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">				if (reflectionUI.getApplicationInfo().getMainButtonBorderColor() != null) {</span>
<span class="nc" id="L123">					return SwingRendererUtils.getColor(reflectionUI.getApplicationInfo().getMainButtonBorderColor());</span>
				}
<span class="fc" id="L125">				return null;</span>
			}

			@Override
			public String retrieveText() {
<span class="fc" id="L130">				return swingRenderer.prepareMessageToDisplay(label);</span>
			}

			@Override
			public String retrieveToolTipText() {
<span class="fc" id="L135">				return swingRenderer.prepareMessageToDisplay(tooltipText.get());</span>
			}

			@Override
			public void removeNotify() {
<span class="fc" id="L140">				super.removeNotify();</span>
<span class="fc" id="L141">				modificationStack.removeListener(listener);</span>
<span class="fc" id="L142">			}</span>

			protected void updateState() {
<span class="fc" id="L145">				setEnabled(enabled.get());</span>
<span class="fc" id="L146">				this.setToolTipText(SwingRendererUtils</span>
<span class="fc" id="L147">						.adaptToolTipTextToMultiline(swingRenderer.prepareMessageToDisplay(tooltipText.get())));</span>
<span class="fc" id="L148">			}</span>

		};
<span class="fc" id="L151">		result.addActionListener(new ActionListener() {</span>
			@Override
			public void actionPerformed(ActionEvent e) {
<span class="nc" id="L154">				action.run();</span>
<span class="nc" id="L155">			}</span>
		});
<span class="fc" id="L157">		result.setEnabled(enabled.get());</span>
<span class="fc" id="L158">		return result;</span>
	}

	public List&lt;Component&gt; create(SwingRenderer swingRenderer) {
<span class="fc" id="L162">		List&lt;Component&gt; result = new ArrayList&lt;Component&gt;();</span>
<span class="fc" id="L163">		result.add(createUndoButton(swingRenderer));</span>
<span class="fc" id="L164">		result.add(createRedoButton(swingRenderer));</span>
<span class="fc" id="L165">		result.add(createResetButton(swingRenderer));</span>
<span class="fc" id="L166">		return result;</span>
	}

	protected Component createUndoButton(final SwingRenderer swingRenderer) {
<span class="fc" id="L170">		Runnable action = new Runnable() {</span>
			@Override
			public void run() {
<span class="nc" id="L173">				modificationStack.undo();</span>
<span class="nc" id="L174">			}</span>
		};
<span class="fc" id="L176">		Accessor&lt;Boolean&gt; enabled = new Accessor&lt;Boolean&gt;() {</span>
			@Override
			public Boolean get() {
<span class="fc" id="L179">				return modificationStack.canUndo();</span>
			}
		};
<span class="fc" id="L182">		Accessor&lt;String&gt; tooltipText = new Accessor&lt;String&gt;() {</span>
			@Override
			public String get() {
<span class="fc" id="L185">				IModification nextUndoModif = modificationStack.getNextUndoModification();</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">				if (nextUndoModif != null) {</span>
<span class="fc" id="L187">					return nextUndoModif.getTitle();</span>
				} else {
<span class="fc" id="L189">					return null;</span>
				}
			}
		};
<span class="fc" id="L193">		JButton button = createButton(swingRenderer, &quot;Undo&quot;, action, enabled, tooltipText);</span>
<span class="fc" id="L194">		return button;</span>
	}

	protected Component createRedoButton(final SwingRenderer swingRenderer) {
<span class="fc" id="L198">		Runnable action = new Runnable() {</span>
			@Override
			public void run() {
<span class="nc" id="L201">				modificationStack.redo();</span>
<span class="nc" id="L202">			}</span>
		};
<span class="fc" id="L204">		Accessor&lt;Boolean&gt; enabled = new Accessor&lt;Boolean&gt;() {</span>
			@Override
			public Boolean get() {
<span class="fc" id="L207">				return modificationStack.canRedo();</span>
			}
		};
<span class="fc" id="L210">		Accessor&lt;String&gt; tooltipText = new Accessor&lt;String&gt;() {</span>
			@Override
			public String get() {
<span class="fc" id="L213">				IModification nextRedoModif = modificationStack.getNextRedoModification();</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">				if (nextRedoModif != null) {</span>
<span class="nc" id="L215">					return nextRedoModif.getTitle();</span>
				} else {
<span class="fc" id="L217">					return null;</span>
				}
			}
		};
<span class="fc" id="L221">		JButton button = createButton(swingRenderer, &quot;Redo&quot;, action, enabled, tooltipText);</span>
<span class="fc" id="L222">		return button;</span>
	}

	protected Component createResetButton(final SwingRenderer swingRenderer) {
<span class="fc" id="L226">		Runnable action = new Runnable() {</span>
			@Override
			public void run() {
<span class="nc" id="L229">				modificationStack.undoAll();</span>
<span class="nc" id="L230">			}</span>
		};
<span class="fc" id="L232">		Accessor&lt;Boolean&gt; enabled = new Accessor&lt;Boolean&gt;() {</span>
			@Override
			public Boolean get() {
<span class="fc" id="L235">				return modificationStack.canReset();</span>
			}
		};
<span class="fc" id="L238">		Accessor&lt;String&gt; tooltipText = new Accessor&lt;String&gt;() {</span>
			@Override
			public String get() {
<span class="fc" id="L241">				return null;</span>
			}
		};
<span class="fc" id="L244">		JButton button = createButton(swingRenderer, &quot;Reset&quot;, action, enabled, tooltipText);</span>
<span class="fc" id="L245">		return button;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span>j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</div></body></html>