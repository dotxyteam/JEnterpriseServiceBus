<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>JavaTypeInfoSource.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</a> &gt; <a href="../../index.html" class="el_group">reflection-ui</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">xy.reflect.ui.info.type.source</a> &gt; <span class="el_source">JavaTypeInfoSource.java</span></div><h1>JavaTypeInfoSource.java</h1><pre class="source lang-java linenums">
package xy.reflect.ui.info.type.source;

import java.lang.reflect.Constructor;
import java.lang.reflect.Field;
import java.lang.reflect.Member;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.List;
import java.util.Map;

import com.fasterxml.classmate.MemberResolver;
import com.fasterxml.classmate.ResolvedType;
import com.fasterxml.classmate.ResolvedTypeWithMembers;
import com.fasterxml.classmate.TypeResolver;
import com.fasterxml.classmate.members.ResolvedConstructor;
import com.fasterxml.classmate.members.ResolvedField;
import com.fasterxml.classmate.members.ResolvedMethod;

import xy.reflect.ui.ReflectionUI;
import xy.reflect.ui.info.type.DefaultTypeInfo;
import xy.reflect.ui.info.type.ITypeInfo;
import xy.reflect.ui.info.type.enumeration.StandardEnumerationTypeInfo;
import xy.reflect.ui.info.type.iterable.ArrayTypeInfo;
import xy.reflect.ui.info.type.iterable.StandardCollectionTypeInfo;
import xy.reflect.ui.info.type.iterable.map.StandardMapAsListTypeInfo;
import xy.reflect.ui.info.type.iterable.map.StandardMapEntryTypeInfo;
import xy.reflect.ui.util.ReflectionUIError;

/**
 * Type information source for Java types. It extracts {@link ITypeInfo}
 * instances from Java classes.
 * 
 * @author olitank
 *
 */
public class JavaTypeInfoSource implements ITypeInfoSource {

	protected Class&lt;?&gt; javaType;
	protected Member declaringMember;
	protected int declaringInvokableParameterPosition;
	protected Class&lt;?&gt;[] genericTypeParameters;
	protected SpecificitiesIdentifier specificitiesIdentifier;

<span class="fc" id="L48">	public JavaTypeInfoSource(Class&lt;?&gt; javaType, SpecificitiesIdentifier specificitiesIdentifier) {</span>
<span class="fc" id="L49">		this.javaType = javaType;</span>
<span class="fc" id="L50">		this.specificitiesIdentifier = specificitiesIdentifier;</span>
<span class="fc" id="L51">	}</span>

<span class="fc" id="L53">	public JavaTypeInfoSource(Class&lt;?&gt; javaType, Class&lt;?&gt;[] genericTypeParameters,</span>
			SpecificitiesIdentifier specificitiesIdentifier) {
<span class="fc" id="L55">		this.javaType = javaType;</span>
<span class="fc" id="L56">		this.genericTypeParameters = genericTypeParameters;</span>
<span class="fc" id="L57">		this.specificitiesIdentifier = specificitiesIdentifier;</span>
<span class="fc" id="L58">	}</span>

<span class="fc" id="L60">	public JavaTypeInfoSource(Class&lt;?&gt; javaType, Member declaringMember, int declaringInvokableParameterPosition,</span>
			SpecificitiesIdentifier specificitiesIdentifier) {
<span class="fc" id="L62">		this.javaType = javaType;</span>
<span class="fc" id="L63">		this.declaringMember = declaringMember;</span>
<span class="fc" id="L64">		this.declaringInvokableParameterPosition = declaringInvokableParameterPosition;</span>
<span class="fc" id="L65">		this.specificitiesIdentifier = specificitiesIdentifier;</span>
<span class="fc" id="L66">	}</span>

	@Override
	public DefaultTypeInfo buildTypeInfo(ReflectionUI reflectionUI) {
<span class="fc" id="L70">		synchronized (reflectionUI.getTypeCacheMutex()) {</span>
<span class="fc" id="L71">			DefaultTypeInfo result = (DefaultTypeInfo) reflectionUI.getTypeInfoCache().get(this);</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">			if (result == null) {</span>
<span class="fc bfc" id="L73" title="All 2 branches covered.">				if (StandardCollectionTypeInfo.isCompatibleWith(getJavaType())) {</span>
<span class="fc" id="L74">					Class&lt;?&gt; itemClass = guessGenericTypeParameters(Collection.class, 0);</span>
					ITypeInfo itemType;
<span class="fc bfc" id="L76" title="All 2 branches covered.">					if (itemClass == null) {</span>
<span class="fc" id="L77">						itemType = null;</span>
<span class="fc" id="L78">					} else {</span>
<span class="fc" id="L79">						itemType = reflectionUI.getTypeInfo(new JavaTypeInfoSource(itemClass, null));</span>
					}
<span class="fc" id="L81">					result = new StandardCollectionTypeInfo(reflectionUI, this, itemType);</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">				} else if (StandardMapAsListTypeInfo.isCompatibleWith(getJavaType())) {</span>
<span class="fc" id="L83">					Class&lt;?&gt; keyClass = guessGenericTypeParameters(Map.class, 0);</span>
<span class="fc" id="L84">					Class&lt;?&gt; valueClass = guessGenericTypeParameters(Map.class, 1);</span>
<span class="fc" id="L85">					result = new StandardMapAsListTypeInfo(reflectionUI, this, keyClass, valueClass);</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">				} else if (StandardMapEntryTypeInfo.isCompatibleWith(getJavaType())) {</span>
<span class="fc" id="L87">					Class&lt;?&gt; keyClass = null;</span>
<span class="fc" id="L88">					Class&lt;?&gt; valueClass = null;</span>
<span class="fc" id="L89">					Class&lt;?&gt;[] genericParams = getGenericTypeParameters();</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">					if (genericParams != null) {</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">						if (genericParams.length != 2) {</span>
<span class="nc" id="L92">							throw new ReflectionUIError(&quot;Invalid generic type parameter array (expected 2 items) for &quot;</span>
<span class="nc" id="L93">									+ StandardMapEntryTypeInfo.class.getName() + &quot;: &quot; + genericTypeParameters);</span>
						}
<span class="fc" id="L95">						keyClass = genericParams[0];</span>
<span class="fc" id="L96">						valueClass = genericParams[1];</span>
					}
<span class="fc" id="L98">					result = new StandardMapEntryTypeInfo(reflectionUI, this, keyClass, valueClass);</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">				} else if (getJavaType().isArray()) {</span>
<span class="fc" id="L100">					result = new ArrayTypeInfo(reflectionUI, this);</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">				} else if (getJavaType().isEnum()) {</span>
<span class="fc" id="L102">					result = new StandardEnumerationTypeInfo(reflectionUI, this);</span>
<span class="fc" id="L103">				} else {</span>
<span class="fc" id="L104">					result = new DefaultTypeInfo(reflectionUI, this);</span>
				}
<span class="fc" id="L106">				reflectionUI.getTypeInfoCache().put(this, result);</span>
			}
<span class="fc" id="L108">			return result;</span>
		}
	}

	@Override
	public SpecificitiesIdentifier getSpecificitiesIdentifier() {
<span class="fc" id="L114">		return specificitiesIdentifier;</span>
	}

	public Class&lt;?&gt; getJavaType() {
<span class="fc" id="L118">		return javaType;</span>
	}

	public Member getDeclaringMember() {
<span class="nc" id="L122">		return declaringMember;</span>
	}

	public int getDeclaringInvokableParameterPosition() {
<span class="nc" id="L126">		return declaringInvokableParameterPosition;</span>
	}

	public Class&lt;?&gt;[] getGenericTypeParameters() {
<span class="fc" id="L130">		return genericTypeParameters;</span>
	}

	public List&lt;Class&lt;?&gt;&gt; guessGenericTypeParameters(Class&lt;?&gt; parameterizedBaseClass) {
<span class="fc" id="L134">		TypeResolver typeResolver = new TypeResolver();</span>
<span class="fc" id="L135">		ResolvedType resolvedType = null;</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">		if (declaringMember == null) {</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">			if (genericTypeParameters != null) {</span>
<span class="fc" id="L138">				resolvedType = typeResolver.resolve(javaType, genericTypeParameters);</span>
<span class="fc" id="L139">			} else {</span>
<span class="fc" id="L140">				resolvedType = typeResolver.resolve(javaType);</span>
			}
<span class="fc" id="L142">		} else {</span>
<span class="fc" id="L143">			MemberResolver memberResolver = new MemberResolver(typeResolver);</span>
<span class="fc" id="L144">			ResolvedType declaringResolvedType = typeResolver.resolve(declaringMember.getDeclaringClass());</span>
<span class="fc" id="L145">			ResolvedTypeWithMembers resolvedTypeWithMembers = memberResolver.resolve(declaringResolvedType, null, null);</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">			if (declaringMember instanceof Field) {</span>
				ResolvedField[] resolvedFields;
<span class="fc bfc" id="L148" title="All 2 branches covered.">				if (Modifier.isStatic(declaringMember.getModifiers())) {</span>
<span class="fc" id="L149">					resolvedFields = resolvedTypeWithMembers.getStaticFields();</span>
<span class="fc" id="L150">				} else {</span>
<span class="fc" id="L151">					resolvedFields = resolvedTypeWithMembers.getMemberFields();</span>
				}
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">				for (ResolvedField resolvedField : resolvedFields) {</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">					if (resolvedField.getRawMember().equals(declaringMember)) {</span>
<span class="fc" id="L155">						resolvedType = resolvedField.getType();</span>
<span class="fc" id="L156">						break;</span>
					}
				}
<span class="pc bfc" id="L159" title="All 2 branches covered.">			} else if (declaringMember instanceof Method) {</span>
				ResolvedMethod[] resolvedMethods;
<span class="fc bfc" id="L161" title="All 2 branches covered.">				if (Modifier.isStatic(declaringMember.getModifiers())) {</span>
<span class="fc" id="L162">					resolvedMethods = resolvedTypeWithMembers.getStaticMethods();</span>
<span class="fc" id="L163">				} else {</span>
<span class="fc" id="L164">					resolvedMethods = resolvedTypeWithMembers.getMemberMethods();</span>
				}
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">				for (ResolvedMethod resolvedMethod : resolvedMethods) {</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">					if (resolvedMethod.getRawMember().equals(declaringMember)) {</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">						if (declaringInvokableParameterPosition == -1) {</span>
<span class="fc" id="L169">							resolvedType = resolvedMethod.getType();</span>
<span class="fc" id="L170">						} else {</span>
<span class="fc" id="L171">							resolvedType = resolvedMethod.getArgumentType(declaringInvokableParameterPosition);</span>
						}
<span class="fc" id="L173">						break;</span>
					}
				}
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">			} else if (declaringMember instanceof Constructor) {</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">				for (ResolvedConstructor resolvedConstructor : resolvedTypeWithMembers.getConstructors()) {</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">					if (resolvedConstructor.getRawMember().equals(declaringMember)) {</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">						if (declaringInvokableParameterPosition == -1) {</span>
<span class="nc" id="L180">							resolvedType = resolvedConstructor.getType();</span>
<span class="nc" id="L181">						} else {</span>
<span class="fc" id="L182">							resolvedType = resolvedConstructor.getArgumentType(declaringInvokableParameterPosition);</span>
						}
<span class="fc" id="L184">						break;</span>
					}
				}
<span class="nc" id="L187">			} else {</span>
<span class="nc" id="L188">				throw new ReflectionUIError();</span>
			}
<span class="fc bfc" id="L190" title="All 2 branches covered.">			if (resolvedType == null) {</span>
<span class="fc" id="L191">				return null;</span>
			}
		}
<span class="fc" id="L194">		List&lt;Class&lt;?&gt;&gt; result = new ArrayList&lt;Class&lt;?&gt;&gt;();</span>
<span class="fc" id="L195">		List&lt;ResolvedType&gt; resolvedTypeParameters = resolvedType.typeParametersFor(parameterizedBaseClass);</span>
<span class="pc bpc" id="L196" title="1 of 4 branches missed.">		if ((resolvedTypeParameters == null) || resolvedTypeParameters.isEmpty()){</span>
<span class="fc" id="L197">			return null;</span>
		}
<span class="fc bfc" id="L199" title="All 2 branches covered.">		for (ResolvedType classParameter : resolvedTypeParameters) {</span>
<span class="fc" id="L200">			result.add(classParameter.getErasedType());</span>
		}
<span class="fc" id="L202">		return result;</span>
	}

	public Class&lt;?&gt; guessGenericTypeParameters(Class&lt;?&gt; parameterizedBaseClass, int genericParameterIndex) {
<span class="fc" id="L206">		List&lt;Class&lt;?&gt;&gt; parameterClasses = guessGenericTypeParameters(parameterizedBaseClass);</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">		if (parameterClasses == null) {</span>
<span class="fc" id="L208">			return null;</span>
		}
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">		if (parameterClasses.size() &lt;= genericParameterIndex) {</span>
<span class="nc" id="L211">			return null;</span>
		}
<span class="fc" id="L213">		return parameterClasses.get(genericParameterIndex);</span>
	}

	@Override
	public int hashCode() {
<span class="fc" id="L218">		final int prime = 31;</span>
<span class="fc" id="L219">		int result = 1;</span>
<span class="fc" id="L220">		result = prime * result + declaringInvokableParameterPosition;</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">		result = prime * result + ((declaringMember == null) ? 0 : declaringMember.hashCode());</span>
<span class="fc" id="L222">		result = prime * result + Arrays.hashCode(genericTypeParameters);</span>
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">		result = prime * result + ((javaType == null) ? 0 : javaType.hashCode());</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">		result = prime * result + ((specificitiesIdentifier == null) ? 0 : specificitiesIdentifier.hashCode());</span>
<span class="fc" id="L225">		return result;</span>
	}

	@Override
	public boolean equals(Object obj) {
<span class="fc bfc" id="L230" title="All 2 branches covered.">		if (this == obj)</span>
<span class="fc" id="L231">			return true;</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">		if (obj == null)</span>
<span class="nc" id="L233">			return false;</span>
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">		if (getClass() != obj.getClass())</span>
<span class="nc" id="L235">			return false;</span>
<span class="fc" id="L236">		JavaTypeInfoSource other = (JavaTypeInfoSource) obj;</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">		if (declaringInvokableParameterPosition != other.declaringInvokableParameterPosition)</span>
<span class="nc" id="L238">			return false;</span>
<span class="fc bfc" id="L239" title="All 2 branches covered.">		if (declaringMember == null) {</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">			if (other.declaringMember != null)</span>
<span class="nc" id="L241">				return false;</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">		} else if (!declaringMember.equals(other.declaringMember))</span>
<span class="fc" id="L243">			return false;</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">		if (!Arrays.equals(genericTypeParameters, other.genericTypeParameters))</span>
<span class="nc" id="L245">			return false;</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">		if (javaType == null) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">			if (other.javaType != null)</span>
<span class="nc" id="L248">				return false;</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">		} else if (!javaType.equals(other.javaType))</span>
<span class="nc" id="L250">			return false;</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">		if (specificitiesIdentifier == null) {</span>
<span class="pc bpc" id="L252" title="1 of 2 branches missed.">			if (other.specificitiesIdentifier != null)</span>
<span class="nc" id="L253">				return false;</span>
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">		} else if (!specificitiesIdentifier.equals(other.specificitiesIdentifier))</span>
<span class="nc" id="L255">			return false;</span>
<span class="fc" id="L256">		return true;</span>
	}

	@Override
	public String toString() {
<span class="fc" id="L261">		return &quot;JavaTypeInfoSource [javaType=&quot; + javaType + &quot;, declaringMember=&quot; + declaringMember</span>
<span class="fc" id="L262">				+ &quot;, declaringInvokableParameterPosition=&quot; + declaringInvokableParameterPosition</span>
<span class="fc" id="L263">				+ &quot;, genericTypeParameters=&quot; + Arrays.toString(genericTypeParameters) + &quot;, specificitiesIdentifier=&quot;</span>
<span class="fc" id="L264">				+ specificitiesIdentifier + &quot;]&quot;;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span>j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</div></body></html>