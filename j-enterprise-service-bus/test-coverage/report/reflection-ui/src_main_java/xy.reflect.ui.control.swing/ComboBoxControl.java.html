<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>ComboBoxControl.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</a> &gt; <a href="../../index.html" class="el_group">reflection-ui</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">xy.reflect.ui.control.swing</a> &gt; <span class="el_source">ComboBoxControl.java</span></div><h1>ComboBoxControl.java</h1><pre class="source lang-java linenums">
package xy.reflect.ui.control.swing;

import java.awt.BorderLayout;
import java.awt.Component;
import java.awt.Image;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import javax.swing.BorderFactory;
import javax.swing.DefaultComboBoxModel;
import javax.swing.Icon;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.ListCellRenderer;
import javax.swing.plaf.basic.BasicComboBoxRenderer;

import xy.reflect.ui.control.IAdvancedFieldControl;
import xy.reflect.ui.control.IFieldControlData;
import xy.reflect.ui.control.IFieldControlInput;
import xy.reflect.ui.control.swing.renderer.SwingRenderer;
import xy.reflect.ui.control.swing.util.ControlPanel;
import xy.reflect.ui.control.swing.util.SwingRendererUtils;
import xy.reflect.ui.info.ValidationSession;
import xy.reflect.ui.info.menu.MenuModel;
import xy.reflect.ui.info.type.enumeration.IEnumerationItemInfo;
import xy.reflect.ui.info.type.enumeration.IEnumerationTypeInfo;
import xy.reflect.ui.util.MiscUtils;
import xy.reflect.ui.util.ReflectionUIUtils;

/**
 * Field control that displays a combo box. Compatible with
 * {@link IEnumerationTypeInfo}.
 * 
 * @author olitank
 *
 */
@SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
public class ComboBoxControl extends ControlPanel implements IAdvancedFieldControl {

	protected static final long serialVersionUID = 1L;

	protected static final String INVALID_VALUE_SUFFIX = &quot;...&quot;;

	protected IEnumerationTypeInfo enumType;
	protected List&lt;Object&gt; possibleValues;
	protected SwingRenderer swingRenderer;
	protected IFieldControlInput input;
	protected IFieldControlData data;
	protected JComboBox comboBox;
<span class="fc" id="L56">	protected boolean listenerDisabled = false;</span>

<span class="fc" id="L58">	public ComboBoxControl(final SwingRenderer swingRenderer, IFieldControlInput input) {</span>
<span class="fc" id="L59">		this.swingRenderer = swingRenderer;</span>
<span class="fc" id="L60">		this.input = input;</span>
<span class="fc" id="L61">		this.data = input.getControlData();</span>
<span class="fc" id="L62">		this.enumType = (IEnumerationTypeInfo) data.getType();</span>
<span class="fc" id="L63">		initialize();</span>
<span class="fc" id="L64">	}</span>

	protected List&lt;Object&gt; collectPossibleValues() {
<span class="fc" id="L67">		List&lt;Object&gt; result = new ArrayList&lt;Object&gt;(Arrays.asList(enumType.getValues()));</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">		if (data.isNullValueDistinct()) {</span>
<span class="fc" id="L69">			result.add(0, null);</span>
		}
<span class="fc" id="L71">		return result;</span>
	}

	protected void initialize() {
<span class="fc" id="L75">		setLayout(new BorderLayout());</span>
<span class="fc" id="L76">		comboBox = new JComboBox();</span>
<span class="fc" id="L77">		add(comboBox, BorderLayout.CENTER);</span>
<span class="fc" id="L78">		comboBox.setRenderer(createRenderer());</span>
<span class="fc" id="L79">		comboBox.addActionListener(createActionListener());</span>
<span class="fc" id="L80">		refreshUI(true);</span>

<span class="fc" id="L82">	}</span>

	protected ActionListener createActionListener() {
<span class="fc" id="L85">		return new ActionListener() {</span>
			@Override
			public void actionPerformed(ActionEvent e) {
<span class="fc bfc" id="L88" title="All 2 branches covered.">				if (listenerDisabled) {</span>
<span class="fc" id="L89">					return;</span>
				}
				try {
<span class="fc" id="L92">					Object selected = comboBox.getSelectedItem();</span>
<span class="fc" id="L93">					data.setValue(selected);</span>
<span class="pc" id="L94">				} catch (Throwable t) {</span>
<span class="nc" id="L95">					swingRenderer.handleException(ComboBoxControl.this, t);</span>
				}
<span class="fc" id="L97">			}</span>
		};
	}

	protected ListCellRenderer createRenderer() {
<span class="fc" id="L102">		return new BasicComboBoxRenderer() {</span>

			protected static final long serialVersionUID = 1L;

			@Override
			public Component getListCellRendererComponent(JList list, Object value, int index, boolean isSelected,
					boolean cellHasFocus) {
<span class="fc" id="L109">				JLabel label = (JLabel) super.getListCellRendererComponent(list, value, index, isSelected,</span>
<span class="fc" id="L110">						cellHasFocus);</span>
<span class="fc" id="L111">				String text = getValueText(value);</span>
<span class="pc bpc" id="L112" title="1 of 4 branches missed.">				if ((text == null) || (text.length() == 0)) {</span>
<span class="fc" id="L113">					label.setText(&quot;&quot;);</span>
<span class="fc" id="L114">					label.setToolTipText(null);</span>
<span class="fc" id="L115">				} else {</span>
<span class="fc" id="L116">					label.setText(text.replaceAll(MiscUtils.getNewLineRegex(), &quot; &quot;));</span>
<span class="fc" id="L117">					label.setToolTipText(SwingRendererUtils.adaptToolTipTextToMultiline(text));</span>
				}
<span class="fc" id="L119">				label.setIcon(getValueIcon(value));</span>
<span class="pc bpc" id="L120" title="1 of 4 branches missed.">				if ((value != null) &amp;&amp; !possibleValues.contains(value)) {</span>
<span class="nc" id="L121">					SwingRendererUtils.setErrorBorder(label, swingRenderer);</span>
<span class="nc" id="L122">				} else {</span>
<span class="fc" id="L123">					label.setBorder(null);</span>
				}
<span class="fc" id="L125">				return label;</span>
			}
		};
	}

	protected String getValueText(Object value) {
<span class="fc bfc" id="L131" title="All 2 branches covered.">		if (value == null) {</span>
<span class="fc" id="L132">			String nullValueLabel = data.getNullValueLabel();</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">			if (nullValueLabel == null) {</span>
<span class="fc" id="L134">				return &quot;&quot;;</span>
			} else {
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">				return enumType.isDynamicEnumeration() ? nullValueLabel</span>
<span class="fc" id="L137">						: swingRenderer.prepareMessageToDisplay(nullValueLabel);</span>
			}
		} else {
<span class="fc" id="L140">			IEnumerationItemInfo itemInfo = enumType.getValueInfo(value);</span>
			String s;
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">			if (itemInfo == null) {</span>
<span class="nc" id="L143">				s = &quot;&quot;;</span>
<span class="nc" id="L144">			} else {</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">				s = enumType.isDynamicEnumeration() ? itemInfo.getCaption()</span>
<span class="fc" id="L146">						: swingRenderer.prepareMessageToDisplay(itemInfo.getCaption());</span>
			}
<span class="fc" id="L148">			return s;</span>
		}
	}

	protected String getValueTooltipText(Object value) {
<span class="fc bfc" id="L153" title="All 2 branches covered.">		if (value != null) {</span>
<span class="fc" id="L154">			IEnumerationItemInfo itemInfo = enumType.getValueInfo(value);</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">			if (itemInfo != null) {</span>
<span class="fc" id="L156">				String onlineHelp = itemInfo.getOnlineHelp();</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">				if (onlineHelp != null) {</span>
<span class="nc" id="L158">					return swingRenderer.prepareMessageToDisplay(onlineHelp);</span>
				}
			}
		}
<span class="fc" id="L162">		return getValueText(value);</span>
	}

	protected Icon getValueIcon(Object value) {
<span class="fc bfc" id="L166" title="All 2 branches covered.">		if (value == null) {</span>
<span class="fc" id="L167">			return null;</span>
		} else {
<span class="fc" id="L169">			IEnumerationItemInfo itemInfo = enumType.getValueInfo(value);</span>
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">			if (itemInfo == null) {</span>
<span class="nc" id="L171">				return null;</span>
			} else {
<span class="fc" id="L173">				Image image = swingRenderer.getEnumerationItemIconImage(itemInfo);</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">				if (image == null) {</span>
<span class="fc" id="L175">					return null;</span>
				}
<span class="fc" id="L177">				return SwingRendererUtils.getIcon(image);</span>
			}
		}
	}

	@Override
	public boolean refreshUI(boolean refreshStructure) {
<span class="fc bfc" id="L184" title="All 4 branches covered.">		if (enumType.isDynamicEnumeration() || refreshStructure) {</span>
<span class="fc" id="L185">			possibleValues = collectPossibleValues();</span>
		}
<span class="fc" id="L187">		List&lt;Object&gt; extendedPossibleValues = new ArrayList&lt;Object&gt;(possibleValues);</span>
<span class="fc" id="L188">		Object currentValue = data.getValue();</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">		if (!possibleValues.contains(currentValue)) {</span>
<span class="fc" id="L190">			extendedPossibleValues.add(currentValue);</span>
		}
<span class="fc" id="L192">		comboBox.setModel(new DefaultComboBoxModel(extendedPossibleValues.toArray()));</span>
<span class="fc" id="L193">		listenerDisabled = true;</span>
		try {
<span class="fc" id="L195">			comboBox.setSelectedItem(currentValue);</span>
<span class="fc" id="L196">			String tooltipText = getValueTooltipText(currentValue);</span>
<span class="pc bpc" id="L197" title="1 of 4 branches missed.">			if ((tooltipText == null) || (tooltipText.length() == 0)) {</span>
<span class="fc" id="L198">				comboBox.setToolTipText(null);</span>
<span class="fc" id="L199">			} else {</span>
<span class="fc" id="L200">				comboBox.setToolTipText(SwingRendererUtils.adaptToolTipTextToMultiline(tooltipText));</span>
			}
<span class="fc" id="L202">		} finally {</span>
<span class="fc" id="L203">			listenerDisabled = false;</span>
		}
<span class="fc bfc" id="L205" title="All 2 branches covered.">		if (refreshStructure) {</span>
<span class="fc" id="L206">			((JComponent) comboBox.getEditor().getEditorComponent()).setBorder(BorderFactory.createEmptyBorder());</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">			if (data.getBorderColor() != null) {</span>
<span class="fc" id="L208">				comboBox.setBorder(BorderFactory.createLineBorder(SwingRendererUtils.getColor(data.getBorderColor())));</span>
<span class="fc" id="L209">			} else {</span>
<span class="fc" id="L210">				comboBox.setBorder(new JComboBox().getBorder());</span>
			}
<span class="fc bfc" id="L212" title="All 2 branches covered.">			if (data.isGetOnly()) {</span>
<span class="fc" id="L213">				comboBox.setEnabled(false);</span>
<span class="fc" id="L214">				comboBox.setBackground(new JComboBox().getBackground());</span>
<span class="fc" id="L215">				comboBox.setForeground(new JComboBox().getForeground());</span>
<span class="fc" id="L216">			} else {</span>
<span class="fc" id="L217">				comboBox.setEnabled(true);</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">				if (data.getEditorBackgroundColor() != null) {</span>
<span class="fc" id="L219">					comboBox.setBackground(SwingRendererUtils.getColor(data.getEditorBackgroundColor()));</span>
<span class="fc" id="L220">				} else {</span>
<span class="nc" id="L221">					comboBox.setBackground(new JComboBox().getBackground());</span>
				}
<span class="fc bfc" id="L223" title="All 2 branches covered.">				if (data.getEditorForegroundColor() != null) {</span>
<span class="fc" id="L224">					comboBox.setForeground(SwingRendererUtils.getColor(data.getEditorForegroundColor()));</span>
<span class="fc" id="L225">				} else {</span>
<span class="fc" id="L226">					comboBox.setForeground(new JComboBox().getForeground());</span>
				}
			}
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">			if (data.getEditorCustomFontResourcePath() != null) {</span>
<span class="nc" id="L230">				comboBox.setFont(SwingRendererUtils</span>
<span class="nc" id="L231">						.loadFontThroughCache(data.getEditorCustomFontResourcePath(),</span>
<span class="nc" id="L232">								ReflectionUIUtils.getErrorLogListener(swingRenderer.getReflectionUI()), swingRenderer)</span>
<span class="nc" id="L233">						.deriveFont(comboBox.getFont().getStyle(), comboBox.getFont().getSize()));</span>
<span class="nc" id="L234">			} else {</span>
<span class="fc" id="L235">				comboBox.setFont(new JComboBox().getFont());</span>
			}
		}
<span class="fc" id="L238">		return true;</span>
	}

	@Override
	public boolean isModificationStackManaged() {
<span class="fc" id="L243">		return false;</span>
	}

	@Override
	public boolean areValueAccessErrorsManaged() {
<span class="fc" id="L248">		return false;</span>
	}

	@Override
	public boolean displayError(Throwable error) {
<span class="nc" id="L253">		SwingRendererUtils.displayErrorOnBorderAndTooltip(this, comboBox, error, swingRenderer);</span>
<span class="nc" id="L254">		return true;</span>
	}

	@Override
	public boolean showsCaption() {
<span class="fc" id="L259">		return false;</span>
	}

	@Override
	public boolean requestCustomFocus() {
<span class="fc bfc" id="L264" title="All 2 branches covered.">		if (data.isGetOnly()) {</span>
<span class="fc" id="L265">			return false;</span>
		}
<span class="fc" id="L267">		return SwingRendererUtils.requestAnyComponentFocus(comboBox, swingRenderer);</span>
	}

	@Override
	public void validateControlData(ValidationSession session) throws Exception {
<span class="nc" id="L272">	}</span>

	@Override
	public void addMenuContributions(MenuModel menuModel) {
<span class="fc" id="L276">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span>j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</div></body></html>