<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>ImageViewPlugin.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</a> &gt; <a href="../../index.html" class="el_group">reflection-ui</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">xy.reflect.ui.control.swing.plugin</a> &gt; <span class="el_source">ImageViewPlugin.java</span></div><h1>ImageViewPlugin.java</h1><pre class="source lang-java linenums">
package xy.reflect.ui.control.swing.plugin;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.GridBagConstraints;
import java.awt.Image;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.imageio.ImageIO;
import javax.swing.BorderFactory;
import javax.swing.JButton;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.border.Border;
import javax.swing.border.TitledBorder;

import xy.reflect.ui.ReflectionUI;
import xy.reflect.ui.control.DefaultFieldControlData;
import xy.reflect.ui.control.DefaultFieldControlInput;
import xy.reflect.ui.control.FieldControlDataProxy;
import xy.reflect.ui.control.IAdvancedFieldControl;
import xy.reflect.ui.control.IFieldControlData;
import xy.reflect.ui.control.IFieldControlInput;
import xy.reflect.ui.control.plugin.AbstractSimpleCustomizableFieldControlPlugin;
import xy.reflect.ui.control.swing.plugin.FileBrowserPlugin.FileBrowser;
import xy.reflect.ui.control.swing.plugin.FileBrowserPlugin.FileBrowserConfiguration;
import xy.reflect.ui.control.swing.plugin.FileBrowserPlugin.FileNameFilterConfiguration;
import xy.reflect.ui.control.swing.plugin.FileBrowserPlugin.SelectionModeConfiguration;
import xy.reflect.ui.control.swing.renderer.SwingRenderer;
import xy.reflect.ui.control.swing.util.AbstractControlButton;
import xy.reflect.ui.control.swing.util.ControlPanel;
import xy.reflect.ui.control.swing.util.ControlScrollPane;
import xy.reflect.ui.control.swing.util.ImagePanel;
import xy.reflect.ui.control.swing.util.SwingRendererUtils;
import xy.reflect.ui.info.ValidationSession;
import xy.reflect.ui.info.menu.MenuModel;
import xy.reflect.ui.info.method.AbstractConstructorInfo;
import xy.reflect.ui.info.method.IMethodInfo;
import xy.reflect.ui.info.method.InvocationData;
import xy.reflect.ui.info.parameter.IParameterInfo;
import xy.reflect.ui.info.type.ITypeInfo;
import xy.reflect.ui.info.type.factory.InfoProxyFactory;
import xy.reflect.ui.info.type.source.JavaTypeInfoSource;
import xy.reflect.ui.info.type.source.SpecificitiesIdentifier;
import xy.reflect.ui.info.type.source.TypeInfoSourceProxy;
import xy.reflect.ui.util.Accessor;
import xy.reflect.ui.util.MiscUtils;
import xy.reflect.ui.util.ReflectionUIError;
import xy.reflect.ui.util.ReflectionUIUtils;

/**
 * Field control plugin that allows to display/update images.
 * 
 * @author olitank
 *
 */
<span class="fc" id="L71">public class ImageViewPlugin extends AbstractSimpleCustomizableFieldControlPlugin {</span>

	@Override
	public String getControlTitle() {
<span class="nc" id="L75">		return &quot;Image View&quot;;</span>
	}

	@Override
	protected boolean handles(Class&lt;?&gt; javaType) {
<span class="fc bfc" id="L80" title="All 4 branches covered.">		return javaType.equals(Image.class) || javaType.equals(BufferedImage.class);</span>
	}

	@Override
	public AbstractConfiguration getDefaultControlCustomization() {
<span class="fc" id="L85">		return new ImageViewConfiguration();</span>
	}

	@Override
	public ImageView createControl(Object renderer, IFieldControlInput input) {
<span class="fc" id="L90">		return new ImageView((SwingRenderer) renderer, input);</span>
	}

	@Override
	public boolean canDisplayDistinctNullValue() {
<span class="nc" id="L95">		return false;</span>
	}

	@Override
	public IFieldControlData filterDistinctNullValueControlData(final Object renderer, IFieldControlData controlData) {
<span class="nc" id="L100">		return new FieldControlDataProxy(controlData) {</span>
			@Override
			public ITypeInfo getType() {
<span class="nc" id="L103">				return new ImageTypeInfoProxyFactory(((SwingRenderer) renderer).getReflectionUI())</span>
<span class="nc" id="L104">						.wrapTypeInfo(super.getType());</span>
			}

		};
	}

	protected static class ImageTypeInfoProxyFactory extends InfoProxyFactory {

		protected ReflectionUI reflectionUI;

<span class="nc" id="L114">		public ImageTypeInfoProxyFactory(ReflectionUI reflectionUI) {</span>
<span class="nc" id="L115">			this.reflectionUI = reflectionUI;</span>
<span class="nc" id="L116">		}</span>

		@Override
		protected List&lt;IMethodInfo&gt; getConstructors(ITypeInfo type) {
<span class="nc bnc" id="L120" title="All 2 branches missed.">			if (ImageConstructor.isCompatibleWith(reflectionUI, type)) {</span>
<span class="nc" id="L121">				List&lt;IMethodInfo&gt; result = new ArrayList&lt;IMethodInfo&gt;();</span>
<span class="nc" id="L122">				result.add(new ImageConstructor(reflectionUI, type));</span>
<span class="nc" id="L123">				return result;</span>
			}
<span class="nc" id="L125">			return super.getConstructors(type);</span>
		}

		@Override
		protected boolean isConcrete(ITypeInfo type) {
<span class="nc bnc" id="L130" title="All 2 branches missed.">			if (ImageConstructor.isCompatibleWith(reflectionUI, type)) {</span>
<span class="nc" id="L131">				return true;</span>
			}
<span class="nc" id="L133">			return super.isConcrete(type);</span>
		}

	}

	protected static class ImageConstructor extends AbstractConstructorInfo {

		protected ReflectionUI reflectionUI;
		protected ITypeInfo type;

<span class="nc" id="L143">		public ImageConstructor(ReflectionUI reflectionUI, ITypeInfo type) {</span>
<span class="nc" id="L144">			this.reflectionUI = reflectionUI;</span>
<span class="nc" id="L145">			this.type = type;</span>
<span class="nc" id="L146">		}</span>

		@Override
		public ITypeInfo getReturnValueType() {
<span class="nc" id="L150">			return reflectionUI.getTypeInfo(new TypeInfoSourceProxy(type.getSource()) {</span>
				@Override
				public SpecificitiesIdentifier getSpecificitiesIdentifier() {
<span class="nc" id="L153">					return null;</span>
				}

				@Override
				protected String getTypeInfoProxyFactoryIdentifier() {
<span class="nc" id="L158">					return &quot;ConstructorReturnValueTypeInfoProxyFactory [of=&quot; + getClass().getName() + &quot;]&quot;;</span>
				}
			});
		}

		@Override
		public List&lt;IParameterInfo&gt; getParameters() {
<span class="nc" id="L165">			return Collections.emptyList();</span>
		}

		@Override
		public Object invoke(Object ignore, InvocationData invocationData) {
<span class="nc" id="L170">			return new BufferedImage(1, 1, BufferedImage.TYPE_INT_ARGB);</span>
		}

		public static boolean isCompatibleWith(ReflectionUI reflectionUI, ITypeInfo type) {
			Class&lt;?&gt; imageClass;
			try {
<span class="nc" id="L176">				imageClass = reflectionUI.getReflectedClass(type.getName());</span>
<span class="nc" id="L177">			} catch (ClassNotFoundException e) {</span>
<span class="nc" id="L178">				return false;</span>
			}
<span class="nc" id="L180">			return imageClass.isAssignableFrom(BufferedImage.class);</span>
		}

		@Override
		public int hashCode() {
<span class="nc" id="L185">			final int prime = 31;</span>
<span class="nc" id="L186">			int result = super.hashCode();</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">			result = prime * result + ((type == null) ? 0 : type.hashCode());</span>
<span class="nc" id="L188">			return result;</span>
		}

		@Override
		public boolean equals(Object obj) {
<span class="nc bnc" id="L193" title="All 2 branches missed.">			if (this == obj)</span>
<span class="nc" id="L194">				return true;</span>
<span class="nc bnc" id="L195" title="All 2 branches missed.">			if (!super.equals(obj))</span>
<span class="nc" id="L196">				return false;</span>
<span class="nc bnc" id="L197" title="All 2 branches missed.">			if (getClass() != obj.getClass())</span>
<span class="nc" id="L198">				return false;</span>
<span class="nc" id="L199">			ImageConstructor other = (ImageConstructor) obj;</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">			if (type == null) {</span>
<span class="nc bnc" id="L201" title="All 2 branches missed.">				if (other.type != null)</span>
<span class="nc" id="L202">					return false;</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">			} else if (!type.equals(other.type))</span>
<span class="nc" id="L204">				return false;</span>
<span class="nc" id="L205">			return true;</span>
		}

		@Override
		public String toString() {
<span class="nc" id="L210">			return &quot;ImageConstructor [type=&quot; + type + &quot;]&quot;;</span>
		}

	}

<span class="fc" id="L215">	public static class ImageViewConfiguration extends AbstractConfiguration {</span>
		private static final long serialVersionUID = 1L;

		public SizeConstraint sizeConstraint;
	}

<span class="fc" id="L221">	public enum ImageSizeUnit {</span>
<span class="fc" id="L222">		PIXELS, SCREEN_PERCENT</span>
	}

<span class="nc" id="L225">	public static abstract class SizeConstraint extends AbstractConfiguration {</span>
		private static final long serialVersionUID = 1L;

<span class="nc" id="L228">		public int canvasWidth = 100;</span>
<span class="nc" id="L229">		public int canvasHeight = 100;</span>
<span class="nc" id="L230">		public ImageSizeUnit unit = ImageSizeUnit.PIXELS;</span>
<span class="nc" id="L231">		public boolean scalingQualitHigh = false;;</span>

		private void readObject(java.io.ObjectInputStream in) throws IOException, ClassNotFoundException {
<span class="fc" id="L234">			in.defaultReadObject();</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">			if (unit == null) {</span>
<span class="nc" id="L236">				unit = ImageSizeUnit.PIXELS;</span>
			}
<span class="fc" id="L238">		}</span>

		public abstract void configure(ImageView imageView, JPanel imagePanelContainer, ImagePanel imagePanel);

		public abstract void updateImagePanel(ImageView imageView, ImagePanel imagePanel);

		protected Dimension getSizeInPixels() {
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">			if (unit == ImageSizeUnit.PIXELS) {</span>
<span class="fc" id="L246">				return new Dimension(canvasWidth, canvasHeight);</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">			} else if (unit == ImageSizeUnit.SCREEN_PERCENT) {</span>
<span class="nc" id="L248">				Dimension screenSize = MiscUtils.getDefaultScreenSize();</span>
<span class="nc" id="L249">				int width = Math.round((canvasWidth / 100f) * screenSize.width);</span>
<span class="nc" id="L250">				int height = Math.round((canvasHeight / 100f) * screenSize.height);</span>
<span class="nc" id="L251">				return new Dimension(width, height);</span>
			} else {
<span class="nc" id="L253">				throw new ReflectionUIError();</span>
			}
		}

	}

<span class="nc" id="L259">	public static class StretchingSizeConstraint extends SizeConstraint {</span>
		private static final long serialVersionUID = 1L;

		@Override
		public void configure(ImageView imageView, JPanel imagePanelContainer, ImagePanel imagePanel) {
<span class="nc" id="L264">			Dimension size = getSizeInPixels();</span>
<span class="nc" id="L265">			imagePanel.setPreferredSize(size);</span>
<span class="nc" id="L266">			imagePanel.setMinimumSize(size);</span>
<span class="nc" id="L267">			imagePanel.setPreservingRatio(false);</span>
<span class="nc" id="L268">			imagePanel.setScalingQualitHigh(scalingQualitHigh);</span>
<span class="nc" id="L269">			imagePanelContainer.setLayout(new BorderLayout());</span>
<span class="nc" id="L270">			imagePanelContainer.add(imagePanel, BorderLayout.CENTER);</span>
<span class="nc" id="L271">		}</span>

		@Override
		public void updateImagePanel(ImageView imageView, ImagePanel imagePanel) {
<span class="nc" id="L275">			Image image = (Image) imageView.data.getValue();</span>
<span class="nc" id="L276">			imagePanel.setImage(image);</span>
<span class="nc" id="L277">		}</span>
	}

<span class="nc" id="L280">	public static class ScalingSizeConstraint extends SizeConstraint {</span>
		private static final long serialVersionUID = 1L;

<span class="nc" id="L283">		public boolean areaFilled = false;</span>

		@Override
		public void configure(ImageView imageView, JPanel imagePanelContainer, ImagePanel imagePanel) {
<span class="nc" id="L287">			Dimension size = getSizeInPixels();</span>
<span class="nc" id="L288">			imagePanel.setPreferredSize(size);</span>
<span class="nc" id="L289">			imagePanel.setMinimumSize(size);</span>
<span class="nc" id="L290">			imagePanel.setPreservingRatio(true);</span>
<span class="nc" id="L291">			imagePanel.setFillingAreaWhenPreservingRatio(areaFilled);</span>
<span class="nc" id="L292">			imagePanel.setScalingQualitHigh(scalingQualitHigh);</span>
<span class="nc" id="L293">			imagePanelContainer.setLayout(new BorderLayout());</span>
<span class="nc" id="L294">			imagePanelContainer.add(imagePanel, BorderLayout.CENTER);</span>
<span class="nc" id="L295">		}</span>

		@Override
		public void updateImagePanel(ImageView imageView, ImagePanel imagePanel) {
<span class="nc" id="L299">			Image image = (Image) imageView.data.getValue();</span>
<span class="nc" id="L300">			imagePanel.setImage(image);</span>
<span class="nc" id="L301">		}</span>
	}

<span class="nc" id="L304">	public static class ScrollableSizeConstraint extends SizeConstraint {</span>
		private static final long serialVersionUID = 1L;

		@Override
		public void configure(ImageView imageView, JPanel imagePanelContainer, ImagePanel imagePanel) {
<span class="nc" id="L309">			imagePanel.setPreservingRatio(true);</span>
<span class="nc" id="L310">			imagePanel.setFillingAreaWhenPreservingRatio(false);</span>
<span class="nc" id="L311">			imagePanel.setScalingQualitHigh(scalingQualitHigh);</span>
<span class="nc" id="L312">			JScrollPane scrollPane = new ControlScrollPane(imagePanel);</span>
<span class="nc" id="L313">			scrollPane.setBorder(null);</span>
<span class="nc" id="L314">			Dimension size = getSizeInPixels();</span>
<span class="nc" id="L315">			scrollPane.setPreferredSize(size);</span>
<span class="nc" id="L316">			scrollPane.setMinimumSize(size);</span>
<span class="nc" id="L317">			imagePanelContainer.setLayout(new BorderLayout());</span>
<span class="nc" id="L318">			imagePanelContainer.add(scrollPane, BorderLayout.CENTER);</span>
<span class="nc" id="L319">		}</span>

		@Override
		public void updateImagePanel(ImageView imageView, ImagePanel imagePanel) {
<span class="nc" id="L323">			imageView.updateImagePanelWithoutSizeConstraint(imageView, imagePanel);</span>
<span class="nc" id="L324">		}</span>
	}

<span class="nc" id="L327">	public static class ZoomableSizeConstraint extends SizeConstraint {</span>
		private static final long serialVersionUID = 1L;

		@Override
		public void configure(final ImageView imageView, JPanel imagePanelContainer, final ImagePanel imagePanel) {
<span class="fc" id="L332">			imagePanelContainer.setLayout(new BorderLayout());</span>
<span class="fc" id="L333">			imagePanel.setPreservingRatio(true);</span>
<span class="fc" id="L334">			imagePanel.setFillingAreaWhenPreservingRatio(false);</span>
<span class="fc" id="L335">			imagePanel.setScalingQualitHigh(scalingQualitHigh);</span>
<span class="fc" id="L336">			JPanel zoomPanel = new ControlPanel();</span>
			{
<span class="fc" id="L338">				imagePanelContainer.add(SwingRendererUtils.flowInLayout(zoomPanel, GridBagConstraints.CENTER),</span>
<span class="fc" id="L339">						BorderLayout.NORTH);</span>
<span class="fc" id="L340">				zoomPanel.setBorder(</span>
<span class="fc" id="L341">						BorderFactory.createTitledBorder(null, imageView.swingRenderer.prepareMessageToDisplay(&quot;Zoom&quot;),</span>
<span class="fc" id="L342">								TitledBorder.CENTER, TitledBorder.TOP));</span>
<span class="pc bpc" id="L343" title="1 of 2 branches missed.">				if (imageView.data.getLabelForegroundColor() != null) {</span>
<span class="nc" id="L344">					((TitledBorder) zoomPanel.getBorder())</span>
<span class="nc" id="L345">							.setTitleColor(SwingRendererUtils.getColor(imageView.data.getLabelForegroundColor()));</span>
				}
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">				if (imageView.data.getBorderColor() != null) {</span>
<span class="fc" id="L348">					((TitledBorder) zoomPanel.getBorder()).setBorder(BorderFactory</span>
<span class="fc" id="L349">							.createLineBorder(SwingRendererUtils.getColor(imageView.data.getBorderColor())));</span>
				}
<span class="fc" id="L351">				final float ZOOM_CHANGE_FACTOR = 1.3f;</span>
<span class="fc" id="L352">				zoomPanel.setLayout(new FlowLayout());</span>
<span class="fc" id="L353">				JButton smallerButton = createZoomButton(imageView, &quot;-&quot;);</span>
				{
<span class="fc" id="L355">					zoomPanel.add(smallerButton);</span>
<span class="fc" id="L356">					smallerButton.addActionListener(new ActionListener() {</span>
						@Override
						public void actionPerformed(ActionEvent e) {
<span class="nc" id="L359">							Dimension size = imagePanel.getSize();</span>
<span class="nc" id="L360">							size.width /= ZOOM_CHANGE_FACTOR;</span>
<span class="nc" id="L361">							size.height /= ZOOM_CHANGE_FACTOR;</span>
<span class="nc" id="L362">							imagePanel.setPreferredSize(size);</span>
<span class="nc" id="L363">							SwingRendererUtils.handleComponentSizeChange(imagePanel);</span>
<span class="nc" id="L364">						}</span>
					});
				}
<span class="fc" id="L367">				JButton biggerButton = createZoomButton(imageView, &quot;+&quot;);</span>
				{
<span class="fc" id="L369">					zoomPanel.add(biggerButton);</span>
<span class="fc" id="L370">					biggerButton.addActionListener(new ActionListener() {</span>
						@Override
						public void actionPerformed(ActionEvent e) {
<span class="nc" id="L373">							Dimension size = imagePanel.getSize();</span>
<span class="nc" id="L374">							size.width *= ZOOM_CHANGE_FACTOR;</span>
<span class="nc" id="L375">							size.height *= ZOOM_CHANGE_FACTOR;</span>
<span class="nc" id="L376">							imagePanel.setPreferredSize(size);</span>
<span class="nc" id="L377">							SwingRendererUtils.handleComponentSizeChange(imagePanel);</span>
<span class="nc" id="L378">						}</span>
					});
				}
			}
<span class="fc" id="L382">			imagePanel.setPreferredSize(getSizeInPixels());</span>
<span class="fc" id="L383">			JScrollPane scrollPane = new ControlScrollPane(imagePanel);</span>
			{
<span class="fc" id="L385">				imagePanelContainer.add(scrollPane, BorderLayout.CENTER);</span>
<span class="fc" id="L386">				scrollPane.setBorder(null);</span>
<span class="fc" id="L387">				Dimension size = getSizeInPixels();</span>
<span class="fc" id="L388">				size.width += scrollPane.getHorizontalScrollBar().getPreferredSize().height;</span>
<span class="fc" id="L389">				size.height += scrollPane.getVerticalScrollBar().getPreferredSize().width;</span>
<span class="fc" id="L390">				scrollPane.setPreferredSize(size);</span>
<span class="fc" id="L391">				scrollPane.setMinimumSize(size);</span>
			}
<span class="fc" id="L393">		}</span>

		protected JButton createZoomButton(final ImageView imageView, final String caption) {
<span class="fc" id="L396">			return new AbstractControlButton() {</span>

				private static final long serialVersionUID = 1L;

				@Override
				public String retrieveText() {
<span class="fc" id="L402">					return imageView.swingRenderer.prepareMessageToDisplay(caption);</span>
				}

				@Override
				public Image retrieveBackgroundImage() {
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">					if (imageView.data.getButtonBackgroundImagePath() == null) {</span>
<span class="nc" id="L408">						return null;</span>
					} else {
<span class="fc" id="L410">						return SwingRendererUtils.loadImageThroughCache(imageView.data.getButtonBackgroundImagePath(),</span>
<span class="fc" id="L411">								ReflectionUIUtils.getErrorLogListener(imageView.swingRenderer.getReflectionUI()), null);</span>
					}
				}

				@Override
				public Font retrieveCustomFont() {
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">					if (imageView.data.getButtonCustomFontResourcePath() == null) {</span>
<span class="fc" id="L418">						return null;</span>
					} else {
<span class="nc" id="L420">						return SwingRendererUtils.loadFontThroughCache(imageView.data.getButtonCustomFontResourcePath(),</span>
<span class="nc" id="L421">								ReflectionUIUtils.getErrorLogListener(imageView.swingRenderer.getReflectionUI()), null);</span>
					}
				}

				@Override
				public Color retrieveBackgroundColor() {
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">					if (imageView.data.getButtonBackgroundColor() == null) {</span>
<span class="nc" id="L428">						return null;</span>
					} else {
<span class="fc" id="L430">						return SwingRendererUtils.getColor(imageView.data.getButtonBackgroundColor());</span>
					}
				}

				@Override
				public Color retrieveForegroundColor() {
<span class="pc bpc" id="L436" title="1 of 2 branches missed.">					if (imageView.data.getButtonForegroundColor() == null) {</span>
<span class="nc" id="L437">						return null;</span>
					} else {
<span class="fc" id="L439">						return SwingRendererUtils.getColor(imageView.data.getButtonForegroundColor());</span>
					}
				}

				@Override
				public Color retrieveBorderColor() {
<span class="pc bpc" id="L445" title="1 of 2 branches missed.">					if (imageView.data.getButtonBorderColor() == null) {</span>
<span class="nc" id="L446">						return null;</span>
					} else {
<span class="fc" id="L448">						return SwingRendererUtils.getColor(imageView.data.getButtonBorderColor());</span>
					}
				}

			};
		}

		@Override
		public void updateImagePanel(ImageView imageView, ImagePanel imagePanel) {
<span class="fc" id="L457">			Image image = (Image) imageView.data.getValue();</span>
<span class="fc" id="L458">			imagePanel.setImage(image);</span>
<span class="fc" id="L459">		}</span>
	}

	public class ImageView extends ControlPanel implements IAdvancedFieldControl {
		private static final long serialVersionUID = 1L;

		protected SwingRenderer swingRenderer;
		protected IFieldControlInput input;
		protected IFieldControlData data;
		protected ControlPanel contentPane;
		protected JPanel imagePanelContainer;
		protected ImagePanel imagePanel;
		protected JButton browseButton;

		protected ImageViewConfiguration controlConfiguration;

<span class="fc" id="L475">		public ImageView(SwingRenderer swingRenderer, IFieldControlInput input) {</span>
<span class="fc" id="L476">			this.swingRenderer = swingRenderer;</span>
<span class="fc" id="L477">			this.input = input;</span>
<span class="fc" id="L478">			this.data = input.getControlData();</span>
<span class="fc" id="L479">			setLayout(new BorderLayout());</span>
<span class="fc" id="L480">			contentPane = new ControlPanel();</span>
<span class="fc" id="L481">			contentPane.setLayout(new BorderLayout());</span>
<span class="fc" id="L482">			add(contentPane, BorderLayout.CENTER);</span>
<span class="fc" id="L483">			refreshUI(true);</span>
<span class="fc" id="L484">		}</span>

		@Override
		public boolean refreshUI(boolean refreshStructure) {
<span class="fc bfc" id="L488" title="All 2 branches covered.">			if (refreshStructure) {</span>
<span class="fc" id="L489">				updateControlConfiguration();</span>
			}
<span class="fc bfc" id="L491" title="All 2 branches covered.">			if (refreshStructure) {</span>
<span class="fc" id="L492">				contentPane.removeAll();</span>
<span class="fc" id="L493">				browseButton = null;</span>
<span class="fc" id="L494">				imagePanelContainer = null;</span>
<span class="fc" id="L495">				imagePanel = null;</span>
<span class="fc" id="L496">				SwingRendererUtils.showFieldCaptionOnBorder(data, this, new Accessor&lt;Border&gt;() {</span>
					@Override
					public Border get() {
<span class="fc" id="L499">						return new ControlPanel().getBorder();</span>
					}
<span class="fc" id="L501">				}, swingRenderer);</span>
<span class="fc" id="L502">				setOpaque(false);</span>
			}
<span class="fc bfc" id="L504" title="All 2 branches covered.">			if (browseButton == null) {</span>
<span class="fc" id="L505">				browseButton = createBrowseButton();</span>
<span class="fc" id="L506">				contentPane.add(SwingRendererUtils.flowInLayout(browseButton, GridBagConstraints.CENTER),</span>
<span class="fc" id="L507">						BorderLayout.SOUTH);</span>
<span class="pc bpc" id="L508" title="1 of 2 branches missed.">				browseButton.setVisible(!data.isGetOnly());</span>
			}
<span class="fc bfc" id="L510" title="All 2 branches covered.">			if (imagePanelContainer == null) {</span>
<span class="fc" id="L511">				imagePanelContainer = new ControlPanel();</span>
<span class="fc" id="L512">				contentPane.add(imagePanelContainer);</span>
			}
<span class="fc bfc" id="L514" title="All 2 branches covered.">			if (imagePanel == null) {</span>
<span class="fc" id="L515">				imagePanel = createImagePanel();</span>
<span class="fc bfc" id="L516" title="All 2 branches covered.">				if (controlConfiguration.sizeConstraint == null) {</span>
<span class="fc" id="L517">					configureWithoutSizeConstraint(this);</span>
<span class="fc" id="L518">					updateImagePanelWithoutSizeConstraint(this, imagePanel);</span>
<span class="fc" id="L519">				} else {</span>
<span class="fc" id="L520">					controlConfiguration.sizeConstraint.configure(this, imagePanelContainer, imagePanel);</span>
<span class="fc" id="L521">					controlConfiguration.sizeConstraint.updateImagePanel(this, imagePanel);</span>
				}
<span class="fc" id="L523">			} else {</span>
<span class="pc bpc" id="L524" title="1 of 2 branches missed.">				if (controlConfiguration.sizeConstraint == null) {</span>
<span class="fc" id="L525">					updateImagePanelWithoutSizeConstraint(this, imagePanel);</span>
<span class="fc" id="L526">				} else {</span>
<span class="nc" id="L527">					controlConfiguration.sizeConstraint.updateImagePanel(this, imagePanel);</span>
				}
			}
<span class="fc" id="L530">			imagePanel.getParent().invalidate();</span>
<span class="fc" id="L531">			SwingRendererUtils.handleComponentSizeChange(this);</span>
<span class="fc" id="L532">			return true;</span>
		}

		protected void updateControlConfiguration() {
<span class="fc" id="L536">			controlConfiguration = (ImageViewConfiguration) loadControlCustomization(input);</span>
<span class="fc" id="L537">		}</span>

		protected JButton createBrowseButton() {
<span class="fc" id="L540">			final JButton result = new AbstractControlButton() {</span>

				private static final long serialVersionUID = 1L;

				@Override
				public Image retrieveBackgroundImage() {
<span class="fc bfc" id="L546" title="All 2 branches covered.">					if (data.getButtonBackgroundImagePath() == null) {</span>
<span class="fc" id="L547">						return null;</span>
					} else {
<span class="fc" id="L549">						return SwingRendererUtils.loadImageThroughCache(data.getButtonBackgroundImagePath(),</span>
<span class="fc" id="L550">								ReflectionUIUtils.getErrorLogListener(swingRenderer.getReflectionUI()), swingRenderer);</span>
					}
				}

				@Override
				public Font retrieveCustomFont() {
<span class="pc bpc" id="L556" title="1 of 2 branches missed.">					if (data.getButtonCustomFontResourcePath() == null) {</span>
<span class="fc" id="L557">						return null;</span>
					} else {
<span class="nc" id="L559">						return SwingRendererUtils.loadFontThroughCache(data.getButtonCustomFontResourcePath(),</span>
<span class="nc" id="L560">								ReflectionUIUtils.getErrorLogListener(swingRenderer.getReflectionUI()), swingRenderer);</span>
					}
				}

				@Override
				public Color retrieveBackgroundColor() {
<span class="fc bfc" id="L566" title="All 2 branches covered.">					if (data.getButtonBackgroundColor() == null) {</span>
<span class="fc" id="L567">						return null;</span>
					} else {
<span class="fc" id="L569">						return SwingRendererUtils.getColor(data.getButtonBackgroundColor());</span>
					}
				}

				@Override
				public Color retrieveForegroundColor() {
<span class="fc bfc" id="L575" title="All 2 branches covered.">					if (data.getButtonForegroundColor() == null) {</span>
<span class="fc" id="L576">						return null;</span>
					} else {
<span class="fc" id="L578">						return SwingRendererUtils.getColor(data.getButtonForegroundColor());</span>
					}
				}

				@Override
				public Color retrieveBorderColor() {
<span class="fc bfc" id="L584" title="All 2 branches covered.">					if (data.getButtonBorderColor() == null) {</span>
<span class="fc" id="L585">						return null;</span>
					} else {
<span class="fc" id="L587">						return SwingRendererUtils.getColor(data.getButtonBorderColor());</span>
					}
				}

				@Override
				public String retrieveText() {
<span class="fc" id="L593">					return swingRenderer.prepareMessageToDisplay(&quot;...&quot;);</span>
				}
			};
<span class="fc" id="L596">			result.addActionListener(new ActionListener() {</span>
				@Override
				public void actionPerformed(ActionEvent e) {
					try {
<span class="nc" id="L600">						onBrowseImage();</span>
<span class="nc" id="L601">					} catch (Throwable t) {</span>
<span class="nc" id="L602">						ImageView.this.swingRenderer.handleException(ImageView.this, t);</span>
					}
<span class="nc" id="L604">				}</span>
			});
<span class="fc" id="L606">			return result;</span>
		}

		protected ImagePanel createImagePanel() {
<span class="fc" id="L610">			return new ImagePanel();</span>
		}

		protected void onBrowseImage() {
<span class="nc" id="L614">			final FileBrowserConfiguration fileBrowserConfiguration = new FileBrowserConfiguration();</span>
<span class="nc" id="L615">			fileBrowserConfiguration.selectionMode = SelectionModeConfiguration.FILES_ONLY;</span>
<span class="nc" id="L616">			fileBrowserConfiguration.actionTitle = &quot;Load Image&quot;;</span>
<span class="nc" id="L617">			FileNameFilterConfiguration filter = new FileNameFilterConfiguration();</span>
			{
<span class="nc" id="L619">				filter.description = &quot;Images&quot;;</span>
<span class="nc" id="L620">				filter.extensions.addAll(Arrays.asList(ImageIO.getReaderFileSuffixes()));</span>
<span class="nc" id="L621">				fileBrowserConfiguration.fileNameFilters.add(filter);</span>
			}
<span class="nc" id="L623">			final File[] imageFileHolder = new File[1];</span>
<span class="nc" id="L624">			final FileBrowserPlugin browserPlugin = new FileBrowserPlugin();</span>
<span class="nc" id="L625">			IFieldControlInput fileBrowserInput = new DefaultFieldControlInput(swingRenderer.getReflectionUI()) {</span>

				@Override
				public IFieldControlData getControlData() {
<span class="nc" id="L629">					return new DefaultFieldControlData(swingRenderer.getReflectionUI()) {</span>

						@Override
						public Object getValue() {
<span class="nc" id="L633">							return imageFileHolder[0];</span>
						}

						@Override
						public void setValue(Object value) {
<span class="nc" id="L638">							imageFileHolder[0] = (File) value;</span>
<span class="nc" id="L639">						}</span>

						@Override
						public ITypeInfo getType() {
<span class="nc" id="L643">							return new InfoProxyFactory() {</span>

								@Override
								protected Map&lt;String, Object&gt; getSpecificProperties(ITypeInfo type) {
<span class="nc" id="L647">									Map&lt;String, Object&gt; result = super.getSpecificProperties(type);</span>
<span class="nc" id="L648">									result = new HashMap&lt;String, Object&gt;();</span>
<span class="nc" id="L649">									result = browserPlugin.storeControlCustomization(fileBrowserConfiguration, result);</span>
<span class="nc" id="L650">									return result;</span>
								}

<span class="nc" id="L653">							}.wrapTypeInfo(swingRenderer.getReflectionUI()</span>
<span class="nc" id="L654">									.getTypeInfo(new JavaTypeInfoSource(File.class, null)));</span>
						}

					};
				}

			};
<span class="nc" id="L661">			FileBrowser browser = browserPlugin.createControl(swingRenderer, fileBrowserInput);</span>
<span class="nc" id="L662">			browser.openDialog(this);</span>
<span class="nc bnc" id="L663" title="All 2 branches missed.">			if (imageFileHolder[0] == null) {</span>
<span class="nc" id="L664">				return;</span>
			}
			Image loadedImage;
			try {
<span class="nc" id="L668">				loadedImage = ImageIO.read(imageFileHolder[0]);</span>
<span class="nc" id="L669">			} catch (IOException e) {</span>
<span class="nc" id="L670">				throw new ReflectionUIError(</span>
<span class="nc" id="L671">						&quot;Failed to load the image file '&quot; + imageFileHolder[0] + &quot;': &quot; + e.toString(), e);</span>
			}
<span class="nc" id="L673">			data.setValue(loadedImage);</span>
<span class="nc" id="L674">		}</span>

		@Override
		public boolean displayError(Throwable error) {
<span class="nc" id="L678">			SwingRendererUtils.displayErrorOnBorderAndTooltip(contentPane, contentPane, error, swingRenderer);</span>
<span class="nc" id="L679">			return true;</span>
		}

		@Override
		public boolean showsCaption() {
<span class="fc" id="L684">			return true;</span>
		}

		protected void updateImagePanelWithoutSizeConstraint(ImageView imageView, ImagePanel imagePanel) {
<span class="fc" id="L688">			Image image = (Image) data.getValue();</span>
<span class="fc bfc" id="L689" title="All 2 branches covered.">			if (image != null) {</span>
<span class="fc" id="L690">				imagePanel.setImage(image);</span>
<span class="fc" id="L691">				Dimension size = new Dimension(image.getWidth(null), image.getHeight(null));</span>
<span class="fc" id="L692">				imagePanel.setPreferredSize(size);</span>
<span class="fc" id="L693">				imagePanel.setMinimumSize(size);</span>
<span class="fc" id="L694">			} else {</span>
<span class="fc" id="L695">				imagePanel.setImage(null);</span>
<span class="fc" id="L696">				imagePanel.setPreferredSize(null);</span>
<span class="fc" id="L697">				imagePanel.setMinimumSize(null);</span>
			}
<span class="fc" id="L699">		}</span>

		protected void configureWithoutSizeConstraint(ImageView imageView) {
<span class="fc" id="L702">			imagePanel.setPreservingRatio(true);</span>
<span class="fc" id="L703">			imagePanel.setScalingQualitHigh(false);</span>
<span class="fc" id="L704">			imagePanelContainer.setLayout(new BorderLayout());</span>
<span class="fc" id="L705">			imagePanelContainer.add(imagePanel, BorderLayout.CENTER);</span>
<span class="fc" id="L706">		}</span>

		@Override
		public boolean isModificationStackManaged() {
<span class="nc" id="L710">			return false;</span>
		}

		@Override
		public boolean areValueAccessErrorsManaged() {
<span class="fc" id="L715">			return false;</span>
		}

		@Override
		public boolean requestCustomFocus() {
<span class="fc" id="L720">			return false;</span>
		}

		@Override
		public void validateControlData(ValidationSession session) throws Exception {
<span class="nc" id="L725">		}</span>

		@Override
		public void addMenuContributions(MenuModel menuModel) {
<span class="fc" id="L729">		}</span>

	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span>j-enterprise-service-bus (java8) (Dec 1, 2025 10:13:41 AM)</div></body></html>